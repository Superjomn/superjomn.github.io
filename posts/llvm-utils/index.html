<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | LLVM Utilities (keep updating)</title>
<meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home
</a><a class=nav-link href=/tags/tech><i data-feather=terminal></i>
Tech
</a><a class=nav-link href=/tags/life><i data-feather=coffee></i>
Life
</a><a class=nav-link href=/posts/><i data-feather=archive></i>
Archive
</a><a class=nav-link href=/tags/><i data-feather=tag></i>
Tags
</a><a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><main><article><h1>LLVM Utilities (keep updating)</h1><i data-feather=calendar></i> <time datetime=2023-10-17>Oct 17, 2023</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/llvm>llvm</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/cpp>cpp</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/tech>tech</a><br><br><p><b>Table of Contents</b></p><aside><nav id=TableOfContents><ol><li><a href=#basic-data-type>Basic data type</a><ol><li><a href=#llvm-stringref>llvm::StringRef</a></li><li><a href=#llvm-arrayref>llvm::ArrayRef</a></li><li><a href=#llvm-twine>llvm::Twine</a></li><li><a href=#llvm-nullableptr>llvm::NullablePtr</a></li></ol></li><li><a href=#container>Container</a><ol><li><a href=#llvm-densemap>llvm::DenseMap</a></li><li><a href=#llvm-densemapinfo>llvm::DenseMapInfo</a></li><li><a href=#llvm-stringmap>llvm::StringMap</a></li><li><a href=#llvm-smallvector>llvm::SmallVector</a></li></ol></li><li><a href=#misc>Misc</a><ol><li><a href=#llvm-bumpptrallocator>llvm::BumpPtrAllocator</a></li></ol></li><li><a href=#updating-log>Updating log</a></li></ol></nav></aside><br><p>There are many handy functions or data structures in LLVM project, which are widely used by other projects that rely on LLVM. In this page, I will introduce some common utilities that are worthy of using in your own project or frequently used in LLVM code that you should be familiar with.</p><h2 id=basic-data-type>Basic data type</h2><h3 id=llvm-stringref>llvm::StringRef</h3><p>It is a lightweight, non-owning reference to a sequence of characters.
It is similar to <code>std::string_view</code> introduced in <code>C++17</code>.</p><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// from a C-string
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span><span style=color:#666>*</span> cStr <span style=color:#666>=</span> <span style=color:#4070a0>&#34;hello&#34;</span>;
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>StringRef strRef(cStr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// from a C++-string
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>std<span style=color:#666>::</span>string cppStr <span style=color:#666>=</span> <span style=color:#4070a0>&#34;hello&#34;</span>;
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>StringRef strRef1(cppStr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// from pointer and length
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>llvm<span style=color:#666>::</span>StringRef strRef2(cppStr.c_str(), cppStr.size());
</span></span></code></pre></div><h3 id=llvm-arrayref>llvm::ArrayRef</h3><p>It is a lightweight, non-owning reference to an array of elements. It is similar to <code>std::span</code> introduced in C++20.</p><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#902000>int</span> myArray[] <span style=color:#666>=</span> {<span style=color:#40a070>1</span>, <span style=color:#40a070>2</span>, <span style=color:#40a070>3</span>, <span style=color:#40a070>4</span>, <span style=color:#40a070>5</span>};
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>ArrayRef<span style=color:#666>&lt;</span><span style=color:#902000>int</span><span style=color:#666>&gt;</span> arrayRef(myArray, <span style=color:#40a070>5</span>);
</span></span></code></pre></div><h3 id=llvm-twine>llvm::Twine</h3><p><code>llvm::Twine</code> is a class used to efficiently concatenate strings in both memory and performance.</p><p>To concate two strings:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine twine1(<span style=color:#4070a0>&#34;Hello, &#34;</span>);
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine twine2(<span style=color:#4070a0>&#34;world!&#34;</span>);
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine result <span style=color:#666>=</span> twine1 <span style=color:#666>+</span> twine2;
</span></span></code></pre></div><p>To concate string with other elements:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine twine1(<span style=color:#4070a0>&#34;The answer is &#34;</span>);
</span></span><span style=display:flex><span><span style=color:#902000>int</span> value <span style=color:#666>=</span> <span style=color:#40a070>42</span>;
</span></span><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine result <span style=color:#666>=</span> twine1 <span style=color:#666>+</span> llvm<span style=color:#666>::</span>Twine(value);
</span></span></code></pre></div><p>It is possible to concate multiple elements:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>Twine result <span style=color:#666>=</span> llvm<span style=color:#666>::</span>Twine(<span style=color:#4070a0>&#34;Hello, &#34;</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;world!&#34;</span> <span style=color:#666>+</span> <span style=color:#40a070>42</span> <span style=color:#666>+</span> <span style=color:#40a070>3.14</span>;
</span></span></code></pre></div><p>In the example above, the first &ldquo;Hello&rdquo; is a <code>Twine</code> instance, and all the following &ldquo;+&rdquo; will use <code>Twine</code>&rsquo;s <code>operator+</code> and get new <code>Twine</code> instances, so it is able to concate any number of elements in the real usages.</p><h3 id=llvm-nullableptr>llvm::NullablePtr</h3><p>It is used to represent a pointer that can be either a valid pointer or null.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>NullablePtr<span style=color:#666>&lt;</span>MyType<span style=color:#666>&gt;</span> ptr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ptr <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> MyType();
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// or ptr = nullptr;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> (ptr.isNull()) {
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>} <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>delete</span> ptr.get(); <span style=color:#60a0b0;font-style:italic>// get the underlying pointer
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>}
</span></span></code></pre></div><h2 id=container>Container</h2><h3 id=llvm-densemap>llvm::DenseMap</h3><p><code>llvm::DenseMap</code> has higher performance than <code>std::unordered_map</code> and a similar usage.</p><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>DenseMap<span style=color:#666>&lt;</span><span style=color:#902000>int</span>, <span style=color:#902000>float</span><span style=color:#666>&gt;</span> map;
</span></span><span style=display:flex><span>map[<span style=color:#40a070>20</span>] <span style=color:#666>=</span> <span style=color:#40a070>20.f</span>;
</span></span><span style=display:flex><span>map.insert(std<span style=color:#666>::</span>make_pair(<span style=color:#40a070>20</span>, <span style=color:#40a070>20.f</span>));
</span></span></code></pre></div><h3 id=llvm-densemapinfo>llvm::DenseMapInfo</h3><p><code>llvm::DenseMapInfo</code> is a utility class that provides information and hashing for custom types used as keys in <code>llvm::DenseMap</code>. To use it, you should define your custom type with the following methods provided:</p><ul><li><code>static KeyTy getEmptyKey()</code>: This function should return a unique value representing an &ldquo;empty&rdquo; or &ldquo;deleted&rdquo; key in your custom type</li><li><code>static KeyTy getTombstoneKey()</code>: It should return a unique value representing a &ldquo;tombstone&rdquo; key, which is used when a key is removed.</li><li><code>static unique getHashValue(const KeyTy& key)</code>: This function returns the hash value of a given key.</li><li><code>static bool isEqual(const KeyTy& a, const KeyTy &amp;b)</code>: This function compares two keys and returns true if they are equal, or false if they are not.</li></ul><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>MyKeyType</span> {
</span></span><span style=display:flex><span>    <span style=color:#902000>int</span> value;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> MyKeyType <span style=color:#06287e>getEmptyKey</span>() { <span style=color:#007020;font-weight:700>return</span> MyKeyType{<span style=color:#666>-</span><span style=color:#40a070>1</span>}; }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> MyKeyType <span style=color:#06287e>getTombstoneKey</span>() { <span style=color:#007020;font-weight:700>return</span> MyKeyType{<span style=color:#666>-</span><span style=color:#40a070>2</span>}; }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>unsigned</span> <span style=color:#06287e>getHashValue</span>(<span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>key) { <span style=color:#007020;font-weight:700>return</span> llvm<span style=color:#666>::</span>hash_value(key.value); }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>bool</span> <span style=color:#06287e>isEqual</span>(<span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>a, <span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>b) { <span style=color:#007020;font-weight:700>return</span> a.value <span style=color:#666>==</span> b.value; }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>After this, you should specialize the <code>llvm::DenseMapInfo</code> template for your custom type:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#007020;font-weight:700>namespace</span> llvm {
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>template</span> <span style=color:#666>&lt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>DenseMapInfo</span><span style=color:#666>&lt;</span>MyKeyType<span style=color:#666>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> MyKeyType <span style=color:#06287e>getEmptyKey</span>() { <span style=color:#007020;font-weight:700>return</span> MyKeyType<span style=color:#666>::</span>getEmptyKey(); }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> MyKeyType <span style=color:#06287e>getTombstoneKey</span>() { <span style=color:#007020;font-weight:700>return</span> MyKeyType<span style=color:#666>::</span>getTombstoneKey(); }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>unsigned</span> <span style=color:#06287e>getHashValue</span>(<span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>key) { <span style=color:#007020;font-weight:700>return</span> MyKeyType<span style=color:#666>::</span>getHashValue(key); }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>bool</span> <span style=color:#06287e>isEqual</span>(<span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>a, <span style=color:#007020;font-weight:700>const</span> MyKeyType <span style=color:#666>&amp;</span>b) { <span style=color:#007020;font-weight:700>return</span> MyKeyType<span style=color:#666>::</span>isEqual(a, b); }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=llvm-stringmap>llvm::StringMap</h3><p>It is a map-like container that is specially optimized for string keys.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>StringMap<span style=color:#666>&lt;</span><span style=color:#902000>int</span><span style=color:#666>&gt;</span> stringToIntMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stringToIntMap[<span style=color:#4070a0>&#34;name&#34;</span>] <span style=color:#666>=</span> <span style=color:#4070a0>&#34;Tim&#34;</span>;
</span></span><span style=display:flex><span>stringToIntMap.insert(std<span style=color:#666>::</span>map_pair(<span style=color:#4070a0>&#34;name&#34;</span>, <span style=color:#4070a0>&#34;Tom&#34;</span>));
</span></span></code></pre></div><h3 id=llvm-smallvector>llvm::SmallVector</h3><p>It is a dynamic array container that quite similar to <code>std::vector</code> but optimized for situations where the number of elements is expected to be small.</p><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>SmallVector<span style=color:#666>&lt;</span><span style=color:#902000>int</span>, <span style=color:#40a070>4</span><span style=color:#666>&gt;</span> vec;
</span></span><span style=display:flex><span>vec.push_back(<span style=color:#40a070>1</span>);
</span></span></code></pre></div><h2 id=misc>Misc</h2><h3 id=llvm-bumpptrallocator>llvm::BumpPtrAllocator</h3><p>This is an allocator used to allocate memory in a highly efficient manner. But note that, it doesn&rsquo;t support deallocation for the elements allocated.
Once the <code>llvm::BumpPtrAllocator</code> instance is freed, all the allocated elements will be deallocated in bulk automatically.</p><p>An example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>llvm<span style=color:#666>::</span>BumpPtrAllocator allocator;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span><span style=color:#666>*</span> intPtr <span style=color:#666>=</span> allocator.Allocate<span style=color:#666>&lt;</span><span style=color:#902000>int</span><span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>*</span>intPtr <span style=color:#666>=</span> <span style=color:#40a070>100</span>;
</span></span></code></pre></div><h2 id=updating-log>Updating log</h2><ul><li>[2024-02-25 Sun] Publish the post</li></ul><script src=https://utteranc.es/client.js repo=superjomn/superjomn.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><p class="footer text-center">Copyright (c) 2024 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script><script>feather.replace()</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script></body></html>