<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | Python functools 包简要实践</title></head><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/posts/><i data-feather=home></i>
Home</a>
<a class=nav-link href=/posts/><i data-feather=pen-tool></i>
Posts</a>
<a class=nav-link href=/tags/><i data-feather=tag></i>
Tags</a>
<a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><h1>Python functools 包简要实践</h1><i data-feather=calendar></i> <time datetime=2023-02-22>Feb 22, 2023</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=tags/python>python</a><br><br><h2 id=python-functools-包简要实践>Python functools 包简要实践</h2><p>在阅读 Pytorch 代码时，发现很多 Python 的新的用法比较有趣，之前笔者大部分时间在 C++ 上，这里整理和记录一些有趣的用法。
本文先从 functools 这个包开始。</p><h3 id=total-ordering-shortcut-to-make-class-orderable>@total_ordering shortcut to make class orderable</h3><p>为了让一个 Class 能够比较，我们正常需要定义一堆 slots， <code>__gt__()</code>, <code>__ge__()</code>,~_<em>lt</em>_()~, <code>__le__()</code>, <code>__eq__()</code> 等等。
但其实只需要 <code>__eq__()</code> 和 其他任一方法(比如 <code>__gt__()</code> ) 便可以组合出其他方法。</p><p><code>@total_ordering</code> 便用于这类场景的 helper，如下代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> total_ordering
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@total_ordering</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stuff</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, x):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __eq__(self, other:<span style=color:#e6db74>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>x <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __gt__(self, other:<span style=color:#e6db74>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>x <span style=color:#f92672>&gt;</span> other<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> Stuff(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> Stuff(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;a &lt; b? </span><span style=color:#e6db74>{</span>a <span style=color:#f92672>&lt;</span> b<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>a &lt; b? True
</span></span></code></pre></div><h3 id=partial-to-reuse-a-existing-method-by-fixing-some-arguments>partial() to reuse a existing method by fixing some arguments</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func0</span>(a, b):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;a:</span><span style=color:#e6db74>{</span>a<span style=color:#e6db74>}</span><span style=color:#e6db74>, b:</span><span style=color:#e6db74>{</span>b<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1 <span style=color:#f92672>=</span> partial(func0, a <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(func1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1(b<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># reset argument a</span>
</span></span><span style=display:flex><span>func1(a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, b<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>functools.partial(&lt;function func0 at 0x7fdf180e4f70&gt;, a=0)
</span></span><span style=display:flex><span>a:0, b:10
</span></span><span style=display:flex><span>a:1, b:10
</span></span></code></pre></div><p>从例子可以看出， <code>partial</code> 效果有点类似设定了默认值，新的函数依旧依旧可以设置被 fixed 的 argument。</p><h3 id=warps-to-help-define-better-decorators>@warps to help define better decorators</h3><p>之前，定义 decorator 的 naivie 的方式是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>actual_func</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Before Calling </span><span style=color:#e6db74>{</span>func<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;After Calling </span><span style=color:#e6db74>{</span>func<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>greet</span>(name):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>greet(<span style=color:#e6db74>&#34;Martin&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Before Calling greet
</span></span><span style=display:flex><span>Hello, Martin!
</span></span><span style=display:flex><span>After Calling greet
</span></span></code></pre></div><p>如上， <code>greet</code> 方法实现了既有的功能，但有一个问题，当执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(greet<span style=color:#f92672>.</span>__name__)
</span></span></code></pre></div><p>也就是原有的 <code>greet</code> 的属性都变化了（其实是 greet 替换成了 actual_func），这个不是我们希望的。
<code>warps</code> 方法就用来将 <code>actual_func</code> 伪装回 <code>greet</code> ，让装饰器看起来没有改变表象的东西。</p><p>简单用法如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>actual_func</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Before Calling </span><span style=color:#e6db74>{</span>func<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;After Calling </span><span style=color:#e6db74>{</span>func<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>greet</span>(name):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(greet<span style=color:#f92672>.</span>__name__)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>greet
</span></span></code></pre></div><p>哈哈，greet 还是 greet。</p><h2 id=lru-cache><code>@lru_cache</code></h2><p>默认 <code>maxsize=128</code> ，可以设置 <code>maxsize=None</code> 来确定无限 cache。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@functools.lru_cache</span>(maxsize<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>factorial</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> factorial(n<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>if</span> n <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://dzone.com/articles/functools-useful-decorators-amp-functions-1>Useful Decorators and Functions in Python&rsquo;s Functools</a></li><li><a href=https://towardsdatascience.com/functools-the-power-of-higher-order-functions-in-python-8e6e61c6e4e4>Functools — The Power of Higher-Order Functions in Python</a></li></ul><p class="footer text-center">Copyright (c) 2023 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script>
<script>feather.replace()</script></body></html>