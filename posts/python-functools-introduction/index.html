<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | Python functools 包简要实践</title><meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home</a>
<a class=nav-link href=/posts/><i data-feather=pen-tool></i>
Posts</a>
<a class=nav-link href=/tags/><i data-feather=tag></i>
Tags</a>
<a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><h1>Python functools 包简要实践</h1><i data-feather=calendar></i> <time datetime=2023-02-22>Feb 22, 2023</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=tags/python>python</a><br><br><h2 id=python-functools-包简要实践>Python functools 包简要实践</h2><p>在阅读 Pytorch 代码时，发现很多 Python 的新的用法比较有趣，之前笔者大部分时间在 C++ 上，这里整理和记录一些有趣的用法。
本文先从 functools 这个包开始。</p><h3 id=total-ordering-shortcut-to-make-class-orderable>@total_ordering shortcut to make class orderable</h3><p>为了让一个 Class 能够比较，我们正常需要定义一堆 slots， <code>__gt__()</code>, <code>__ge__()</code>,~_<em>lt</em>_()~, <code>__le__()</code>, <code>__eq__()</code> 等等。
但其实只需要 <code>__eq__()</code> 和 其他任一方法(比如 <code>__gt__()</code> ) 便可以组合出其他方法。</p><p><code>@total_ordering</code> 便用于这类场景的 helper，如下代码</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>from</span> <span style=color:#000>functools</span> <span style=color:#00f>import</span> <span style=color:#000>total_ordering</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@total_ordering</span>
</span></span><span style=display:flex><span><span style=color:#00f>class</span> <span style=color:#000>Stuff</span>:
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> <span style=color:#000>__init__</span>(<span style=color:#000>self</span>, <span style=color:#000>x</span>):
</span></span><span style=display:flex><span>        <span style=color:#000>self</span>.<span style=color:#000>x</span> = <span style=color:#000>x</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> <span style=color:#000>__eq__</span>(<span style=color:#000>self</span>, <span style=color:#000>other</span>:<span style=color:#5a2>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#00f>return</span> <span style=color:#000>self</span>.<span style=color:#000>x</span> == <span style=color:#000>other</span>.<span style=color:#000>x</span>
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> <span style=color:#000>__gt__</span>(<span style=color:#000>self</span>, <span style=color:#000>other</span>:<span style=color:#5a2>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#00f>return</span> <span style=color:#000>self</span>.<span style=color:#000>x</span> &gt; <span style=color:#000>other</span>.<span style=color:#000>x</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>a</span> = <span style=color:#000>Stuff</span>(<span style=color:#3af>0</span>)
</span></span><span style=display:flex><span><span style=color:#000>b</span> = <span style=color:#000>Stuff</span>(<span style=color:#3af>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;a &lt; b? </span><span style=color:#5a2>{</span><span style=color:#000>a</span> &lt; <span style=color:#000>b</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>a &lt; b? True
</span></span></code></pre></div><h3 id=partial-to-reuse-a-existing-method-by-fixing-some-arguments>partial() to reuse a existing method by fixing some arguments</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>from</span> <span style=color:#000>functools</span> <span style=color:#00f>import</span> <span style=color:#000>partial</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>func0</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;a:</span><span style=color:#5a2>{</span><span style=color:#000>a</span><span style=color:#5a2>}</span><span style=color:#5a2>, b:</span><span style=color:#5a2>{</span><span style=color:#000>b</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>func1</span> = <span style=color:#000>partial</span>(<span style=color:#000>func0</span>, <span style=color:#000>a</span> = <span style=color:#3af>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>print</span>(<span style=color:#000>func1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>func1</span>(<span style=color:#000>b</span>=<span style=color:#3af>10</span>)
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># reset argument a</span>
</span></span><span style=display:flex><span><span style=color:#000>func1</span>(<span style=color:#000>a</span>=<span style=color:#3af>1</span>, <span style=color:#000>b</span>=<span style=color:#3af>10</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>functools.partial(&lt;function func0 at 0x7fdf180e4f70&gt;, a=0)
</span></span><span style=display:flex><span>a:0, b:10
</span></span><span style=display:flex><span>a:1, b:10
</span></span></code></pre></div><p>从例子可以看出， <code>partial</code> 效果有点类似设定了默认值，新的函数依旧依旧可以设置被 fixed 的 argument。</p><h3 id=warps-to-help-define-better-decorators>@warps to help define better decorators</h3><p>之前，定义 decorator 的 naivie 的方式是</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>decorator</span>(<span style=color:#000>func</span>):
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> <span style=color:#000>actual_func</span>(*<span style=color:#000>args</span>, **<span style=color:#000>kwargs</span>):
</span></span><span style=display:flex><span>        <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;Before Calling </span><span style=color:#5a2>{</span><span style=color:#000>func</span>.<span style=color:#000>__name__</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>func</span>(*<span style=color:#000>args</span>, **<span style=color:#000>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;After Calling </span><span style=color:#5a2>{</span><span style=color:#000>func</span>.<span style=color:#000>__name__</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> <span style=color:#000>actual_func</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>greet</span>(<span style=color:#000>name</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;Hello, </span><span style=color:#5a2>{</span><span style=color:#000>name</span><span style=color:#5a2>}</span><span style=color:#5a2>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>greet</span>(<span style=color:#5a2>&#34;Martin&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Before Calling greet
</span></span><span style=display:flex><span>Hello, Martin!
</span></span><span style=display:flex><span>After Calling greet
</span></span></code></pre></div><p>如上， <code>greet</code> 方法实现了既有的功能，但有一个问题，当执行</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>print</span>(<span style=color:#000>greet</span>.<span style=color:#000>__name__</span>)
</span></span></code></pre></div><p>也就是原有的 <code>greet</code> 的属性都变化了（其实是 greet 替换成了 actual_func），这个不是我们希望的。
<code>warps</code> 方法就用来将 <code>actual_func</code> 伪装回 <code>greet</code> ，让装饰器看起来没有改变表象的东西。</p><p>简单用法如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>from</span> <span style=color:#000>functools</span> <span style=color:#00f>import</span> <span style=color:#000>wraps</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>decorator</span>(<span style=color:#000>func</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>@wraps</span>(<span style=color:#000>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> <span style=color:#000>actual_func</span>(*<span style=color:#000>args</span>, **<span style=color:#000>kwargs</span>):
</span></span><span style=display:flex><span>        <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;Before Calling </span><span style=color:#5a2>{</span><span style=color:#000>func</span>.<span style=color:#000>__name__</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>func</span>(*<span style=color:#000>args</span>, **<span style=color:#000>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;After Calling </span><span style=color:#5a2>{</span><span style=color:#000>func</span>.<span style=color:#000>__name__</span><span style=color:#5a2>}</span><span style=color:#5a2>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> <span style=color:#000>actual_func</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>greet</span>(<span style=color:#000>name</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>print</span>(<span style=color:#5a2>f</span><span style=color:#5a2>&#34;Hello, </span><span style=color:#5a2>{</span><span style=color:#000>name</span><span style=color:#5a2>}</span><span style=color:#5a2>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>print</span>(<span style=color:#000>greet</span>.<span style=color:#000>__name__</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>greet
</span></span></code></pre></div><p>哈哈，greet 还是 greet。</p><h2 id=lru-cache><code>@lru_cache</code></h2><p>默认 <code>maxsize=128</code> ，可以设置 <code>maxsize=None</code> 来确定无限 cache。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>@functools.lru_cache</span>(<span style=color:#000>maxsize</span>=<span style=color:#3af>1000</span>)
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>factorial</span>(<span style=color:#000>n</span>):
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> <span style=color:#000>n</span> * <span style=color:#000>factorial</span>(<span style=color:#000>n</span>-<span style=color:#3af>1</span>) <span style=color:#00f>if</span> <span style=color:#000>n</span> <span style=color:#00f>else</span> <span style=color:#3af>1</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://dzone.com/articles/functools-useful-decorators-amp-functions-1>Useful Decorators and Functions in Python&rsquo;s Functools</a></li><li><a href=https://towardsdatascience.com/functools-the-power-of-higher-order-functions-in-python-8e6e61c6e4e4>Functools — The Power of Higher-Order Functions in Python</a></li></ul><p class="footer text-center">Copyright (c) 2023 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script>
<script>feather.replace()</script></body></html>