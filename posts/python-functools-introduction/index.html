<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | Python 高端写法记录</title>
<meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home
</a><a class=nav-link href=/tags/tech><i data-feather=terminal></i>
Tech
</a><a class=nav-link href=/tags/life><i data-feather=coffee></i>
Life
</a><a class=nav-link href=/posts/><i data-feather=archive></i>
Archive
</a><a class=nav-link href=/tags/><i data-feather=tag></i>
Tags
</a><a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><main><article><h1>Python 高端写法记录</h1><i data-feather=calendar></i> <time datetime=2023-02-22>Feb 22, 2023</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=tags/python>python</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=tags/tech>tech</a><br><br><h2 style=color:#999>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#functools-misc-功能><code>functools</code> - Misc 功能</a><ul><li><a href=#total-ordering-shortcut-to-make-class-orderable>@total_ordering shortcut to make class orderable</a></li><li><a href=#partial-to-reuse-a-existing-method-by-fixing-some-arguments>partial() to reuse a existing method by fixing some arguments</a></li><li><a href=#warps-to-help-define-better-decorators>@warps to help define better decorators</a></li><li><a href=#lru-cache><code>@lru_cache</code></a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></aside><br><p>在阅读 Pytorch 代码时，发现很多 Python 的新的用法比较有趣，这里整理和记录一些有趣的用法。</p><p>这篇文章会持续更新 :-)</p><h2 id=functools-misc-功能><code>functools</code> - Misc 功能</h2><h3 id=total-ordering-shortcut-to-make-class-orderable>@total_ordering shortcut to make class orderable</h3><p>为了让一个 Class 能够比较，我们正常需要定义一堆 slots， <code>__gt__()</code>, <code>__ge__()</code>,~_<em>lt</em>_()~, <code>__le__()</code>, <code>__eq__()</code> 等等。
但其实只需要 <code>__eq__()</code> 和 其他任一方法(比如 <code>__gt__()</code> ) 便可以组合出其他方法。</p><p><code>@total_ordering</code> 便用于这类场景的 helper，如下代码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>functools</span> <span style=color:#007020;font-weight:700>import</span> total_ordering
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@total_ordering</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Stuff</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> __init__(self, x):
</span></span><span style=display:flex><span>        self<span style=color:#666>.</span>x <span style=color:#666>=</span> x
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> __eq__(self, other:<span style=color:#4070a0>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> self<span style=color:#666>.</span>x <span style=color:#666>==</span> other<span style=color:#666>.</span>x
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> __gt__(self, other:<span style=color:#4070a0>&#34;Stuff&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> self<span style=color:#666>.</span>x <span style=color:#666>&gt;</span> other<span style=color:#666>.</span>x
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a <span style=color:#666>=</span> Stuff(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>b <span style=color:#666>=</span> Stuff(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;a &lt; b? </span><span style=color:#70a0d0>{</span>a <span style=color:#666>&lt;</span> b<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>a &lt; b? True
</span></span></code></pre></div><h3 id=partial-to-reuse-a-existing-method-by-fixing-some-arguments>partial() to reuse a existing method by fixing some arguments</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>functools</span> <span style=color:#007020;font-weight:700>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>func0</span>(a, b):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;a:</span><span style=color:#70a0d0>{</span>a<span style=color:#70a0d0>}</span><span style=color:#4070a0>, b:</span><span style=color:#70a0d0>{</span>b<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1 <span style=color:#666>=</span> partial(func0, a <span style=color:#666>=</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(func1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1(b<span style=color:#666>=</span><span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># reset argument a</span>
</span></span><span style=display:flex><span>func1(a<span style=color:#666>=</span><span style=color:#40a070>1</span>, b<span style=color:#666>=</span><span style=color:#40a070>10</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>functools.partial(&lt;function func0 at 0x7f8cb00e31e0&gt;, a=0)
</span></span><span style=display:flex><span>a:0, b:10
</span></span><span style=display:flex><span>a:1, b:10
</span></span></code></pre></div><p>从例子可以看出， <code>partial</code> 效果有点类似设定了默认值，新的函数依旧依旧可以设置被 fixed 的 argument。</p><h3 id=warps-to-help-define-better-decorators>@warps to help define better decorators</h3><p>之前，定义 decorator 的 naivie 的方式是</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>actual_func</span>(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Before Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span>__name__<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;After Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span>__name__<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>greet</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Hello, </span><span style=color:#70a0d0>{</span>name<span style=color:#70a0d0>}</span><span style=color:#4070a0>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>greet(<span style=color:#4070a0>&#34;Martin&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>import codecs, os;__pyfile = codecs.open(&#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pyaTjbBA&#39;&#39;&#39;, encoding=&#39;&#39;&#39;utf-8&#39;&#39;&#39;);__code = __pyfile.read().encode(&#39;&#39;&#39;utf-8&#39;&#39;&#39;);__pyfile.close();os.remove(&#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pyaTjbBA&#39;&#39;&#39;);exec(compile(__code, &#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pyaTjbBA&#39;&#39;&#39;, &#39;exec&#39;));
</span></span><span style=display:flex><span>Before Calling greet
</span></span><span style=display:flex><span>Hello, Martin!
</span></span><span style=display:flex><span>After Calling greet
</span></span></code></pre></div><p>如上， <code>greet</code> 方法实现了既有的功能，但有一个问题，当执行</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span>__name__)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>import codecs, os;__pyfile = codecs.open(&#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pym2LOKm&#39;&#39;&#39;, encoding=&#39;&#39;&#39;utf-8&#39;&#39;&#39;);__code = __pyfile.read().encode(&#39;&#39;&#39;utf-8&#39;&#39;&#39;);__pyfile.close();os.remove(&#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pym2LOKm&#39;&#39;&#39;);exec(compile(__code, &#39;&#39;&#39;/var/folders/41/6sd124ws3t982vl6bmw1gvjxdmh6b5/T/pym2LOKm&#39;&#39;&#39;, &#39;exec&#39;));
</span></span><span style=display:flex><span>actual_func
</span></span></code></pre></div><p>也就是原有的 <code>greet</code> 的属性都变化了（其实是 greet 替换成了 actual_func），这个不是我们希望的。
<code>warps</code> 方法就用来将 <code>actual_func</code> 伪装回 <code>greet</code> ，让装饰器看起来没有改变表象的东西。</p><p>简单用法如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>functools</span> <span style=color:#007020;font-weight:700>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>actual_func</span>(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Before Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span>__name__<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;After Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span>__name__<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>greet</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Hello, </span><span style=color:#70a0d0>{</span>name<span style=color:#70a0d0>}</span><span style=color:#4070a0>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span>__name__)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>greet
</span></span></code></pre></div><p>哈哈，greet 还是 greet。</p><h3 id=lru-cache><code>@lru_cache</code></h3><p>默认 <code>maxsize=128</code> ，可以设置 <code>maxsize=None</code> 来确定无限 cache。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#555;font-weight:700>@functools.lru_cache</span>(maxsize<span style=color:#666>=</span><span style=color:#40a070>1000</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>factorial</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> n <span style=color:#666>*</span> factorial(n<span style=color:#666>-</span><span style=color:#40a070>1</span>) <span style=color:#007020;font-weight:700>if</span> n <span style=color:#007020;font-weight:700>else</span> <span style=color:#40a070>1</span>
</span></span></code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://dzone.com/articles/functools-useful-decorators-amp-functions-1>Useful Decorators and Functions in Python&rsquo;s Functools</a></li><li><a href=https://towardsdatascience.com/functools-the-power-of-higher-order-functions-in-python-8e6e61c6e4e4>Functools — The Power of Higher-Order Functions in Python</a></li></ul><script src=https://utteranc.es/client.js repo=superjomn/superjomn.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><p class="footer text-center">Copyright (c) 2023 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script><script>feather.replace()</script></body></html>