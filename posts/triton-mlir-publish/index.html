<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | OpenAI/Triton MLIR 迁移工作简介</title><meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home</a>
<a class=nav-link href=/posts/><i data-feather=pen-tool></i>
Posts</a>
<a class=nav-link href=/tags/><i data-feather=tag></i>
Tags</a>
<a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><h1>OpenAI/Triton MLIR 迁移工作简介</h1><i data-feather=calendar></i> <time datetime=2022-11-15>Nov 15, 2022</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=tags/tritoncompiler>triton,compiler</a><br><br><ul><li><a href=#triton-%E7%AE%80%E4%BB%8B>Triton 简介</a><ul><li><a href=#%E5%AE%9A%E4%BD%8D>定位</a></li><li><a href=#%E6%96%B0%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E6%9E%B6%E6%9E%84>新代码中的架构</a></li></ul></li><li><a href=#python-%E7%95%8C%E9%9D%A2%E4%B9%8B-frontend>Python 界面之 Frontend</a></li><li><a href=#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B-optimizer>性能优化之 Optimizer</a><ul><li><a href=#tritongpu-dialect>TritonGPU Dialect</a></li><li><a href=#tritonir-%E7%9A%84%E4%BC%98%E5%8C%96>TritonIR 的优化</a></li><li><a href=#tritongpu-ir-%E7%9A%84%E4%BC%98%E5%8C%96>TritonGPU IR 的优化</a></li></ul></li><li><a href=#%E9%AB%98%E6%80%A7%E8%83%BD-llvm-%E7%94%9F%E6%88%90%E4%B9%8B-backend>高性能 LLVM 生成之 Backend</a><ul><li><a href=#ptx-inline-asm>PTX inline asm</a></li><li><a href=#mma-%E6%8C%87%E4%BB%A4%E7%94%9F%E6%88%90>MMA 指令生成</a></li></ul></li><li><a href=#fyi>FYI</a><ul><li><a href=#gemm-%E5%9C%A8-optimizer-pass-%E6%95%88%E6%9E%9C>GEMM 在 Optimizer Pass 效果</a></li></ul></li></ul><p>经过几个月的不懈努力，OpenAI Triton已经成功完成了面向MLIR Infra的迁移/重构工作，并将其最新的基于MLIR的代码合并至主分支。这个工作是由OpenAI和NVIDIA相关团队近几个月来深入合作完成的，而我也有幸参与其中。在这篇文章中，我将分享一些技术总结，记录一些收获和思考。</p><p>尽管Triton目前的开源开发非常迅速，但本文将主要聚焦于基于MLIR Infra进行重构的第一个版本的<a href=https://github.com/openai/triton/tree/ca05ef8e5b0b4d4834957bc31e7581b09d35c530>代码</a>（这应该也是两三个月前的）</p><h2 id=triton-简介>Triton 简介</h2><p>OpenAI Triton <a href=https://www.eecs.harvard.edu/~htk/publication/2019-mapl-tillet-kung-cox.pdf>paper</a> 中的介绍是 &ldquo;An Intermediate Language and Compiler for Tiled Neural Network Computations&rdquo;，其中几个关键词应该能够代表其特点：</p><ul><li><em>Intermediate Language</em>, 目前是基于 Python 的 DSL</li><li><em>Compiler</em> ，是一个经典的 Compiler 的架构</li><li><em>Tiled</em> Computation，面向 GPU 体系特点，自动分析和实施 tiling</li></ul><h3 id=定位>定位</h3><p>由于 Triton 的开发非常迅速，这里只讨论当前 Triton 的功能。</p><p>简而言之，Triton 提供了一套针对 GPU Kernel 的开发的 Language（基于 Python） 和 高性能 Compiler。</p><figure><img src=/static/triton-publish/1.png></figure><p>因此，就层次而言，Triton的 DNN 开发能力与 CUDA 的部分相对应，但与TVM、XLA等直接面向 DL 的 Domain compiler 无法完全对应。
后者更像是面向 DL 的武器库，拥有从构图到 auto fusion 等端到端的能力，而Triton则更像一把小巧、实用的瑞士军刀，面向偏底层的也是最通用的 Kernel 开发问题。</p><h3 id=新代码中的架构>新代码中的架构</h3><p>Triton 新代码中的架构总体上可以如下呈现</p><figure><img src=/static/triton-publish/three-components.png></figure><p>即总体上可以分为三大块</p><ol><li>Frontend，将用户的 Python kernel code 转换为 Triton IR，以及维护 kernel launch 的 Runtime</li><li>Optimizer，通过各类 pass 将 Triton IR 逐步转换为优化过的 TritonGPU IR</li><li>Backend，将 TritonGPU IR 逐步转换为 LLVM IR，并最终通过 ptxas 编译为 cubin</li></ol><p>贯穿这三部分的核心表示是 Triton 的 IR，微观上，IR 也分为两个层次</p><ol><li>Triton Dialect，表示计算逻辑，硬件无关的表达</li><li>TritonGPU Dialect，GPU 相关的计算表示</li></ol><p>这两者都是基于 MLIR 的自定义 dialect，除此之外，Triton 也复用了很多社区的 dialect 来进行宏观的表示，包括</p><ul><li><code>std</code> dialect： tensor, int, float 等数据类型</li><li><code>arith</code> dialect：各类数学操作</li><li><code>scf</code> dialect：if, for 等控制流</li><li><code>nvvm</code> dialect：获取 <code>thread_id</code> 等少量操作</li><li><code>gpu</code> dialect：printf 等少量操作</li></ul><p>下图是 Triton 中核心表示完整的转换过程：</p><figure><img src=/static/2023-01-29_15-59-49_screenshot.png></figure><p>其中蓝色的两部分主要是 MLIR 体系涉及的部分，随后 MLIR 会转换为 LLVM IR，之后 Triton 会调用 NVPTX 转换为 PTX Assembly，随后由 CUDA 的 ptxas 编译器编译为 cubin。</p><h2 id=python-界面之-frontend>Python 界面之 Frontend</h2><p>Frontend 用于将用户用 Python 编写的 kernel 转换为对应的 Triton IR (Triton Dialect)，这里由于篇幅不便展开，细节可以阅读 <a href=https://github.com/openai/triton/blob/ca05ef8e5b0b4d4834957bc31e7581b09d35c530/python/triton/compiler.py#L108>compiler.py::CodeGenerator</a> 中基于 Python ast 的规则。</p><p>比如 vector add 的例子</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>@triton.jit</span>
</span></span><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>add_kernel</span>(<span style=color:#000>x_ptr</span>, <span style=color:#000>y_ptr</span>, <span style=color:#000>output_ptr</span>, <span style=color:#000>N</span>,
</span></span><span style=display:flex><span>               <span style=color:#000>BLOCK_SIZE</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>pid</span> = <span style=color:#000>tl</span>.<span style=color:#000>program_id</span>(<span style=color:#3af>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>block_start</span> = <span style=color:#000>pid</span> * <span style=color:#000>BLOCK_SIZE</span>
</span></span><span style=display:flex><span>    <span style=color:#000>offsets</span> = <span style=color:#000>block_start</span> + <span style=color:#000>tl</span>.<span style=color:#000>arange</span>(<span style=color:#3af>0</span>, <span style=color:#000>BLOCK_SIZE</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>mask</span> = <span style=color:#000>offsets</span> &lt; <span style=color:#000>N</span>
</span></span><span style=display:flex><span>    <span style=color:#000>x</span> = <span style=color:#000>tl</span>.<span style=color:#000>load</span>(<span style=color:#000>x_ptr</span> + <span style=color:#000>offsets</span>, <span style=color:#000>mask</span>=<span style=color:#000>mask</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>y</span> = <span style=color:#000>tl</span>.<span style=color:#000>load</span>(<span style=color:#000>y_ptr</span> + <span style=color:#000>offsets</span>, <span style=color:#000>mask</span>=<span style=color:#000>mask</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>output</span> = <span style=color:#000>x</span> + <span style=color:#000>y</span>
</span></span><span style=display:flex><span>    <span style=color:#000>tl</span>.<span style=color:#000>store</span>(<span style=color:#000>output_ptr</span>+<span style=color:#000>offsets</span>, <span style=color:#000>output</span>, <span style=color:#000>mask</span>=<span style=color:#000>mask</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># x, y are torch.Tensor</span>
</span></span><span style=display:flex><span><span style=color:#000>grid</span> = <span style=color:#00f>lambda</span> <span style=color:#000>meta</span>: (<span style=color:#000>triton</span>.<span style=color:#000>cdiv</span>(<span style=color:#000>n_elements</span>, <span style=color:#000>meta</span>[<span style=color:#5a2>&#39;BLOCK_SIZE&#39;</span>]),)
</span></span><span style=display:flex><span><span style=color:#000>add_kernel</span>[<span style=color:#000>grid</span>](<span style=color:#000>x</span>, <span style=color:#000>y</span>, <span style=color:#000>output</span>, <span style=color:#000>n_elements</span>, <span style=color:#000>BLOCK_SIZE</span>=<span style=color:#3af>1024</span>)
</span></span></code></pre></div><p>相应会得到 Triton IR</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@kernel_0d1d2d3d</span>(
</span></span><span style=display:flex><span>       <span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}) {
</span></span><span style=display:flex><span>  <span style=color:#000>%c256_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>256</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>get_program_id</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%0</span>, <span style=color:#000>%c256_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%2</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>256</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%1</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%4</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%3</span>, <span style=color:#000>%2</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%5</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%5</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%7</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%8</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%7</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%10</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%4</span>, <span style=color:#000>%9</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%11</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%6</span>, <span style=color:#000>%10</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%12</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%8</span>, <span style=color:#000>%10</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%13</span> = <span style=color:red>arith</span>.<span style=color:red>addf</span> <span style=color:#000>%11</span>, <span style=color:#000>%12</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%14</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%15</span>, <span style=color:#000>%13</span>, <span style=color:#000>%10</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>256</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:red>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到，Triton IR 几乎一比一地对应到原始的 Python code，将用户定义的 computation 带入 MLIR 的体系，后续会在此基础上做各类优化（by Optimizer）以及最终 translate 到更低层次的表示中（by Backend）。</p><h2 id=性能优化之-optimizer>性能优化之 Optimizer</h2><p>Optimizer 用于分析和优化 Frontend 传入的 IR，通过各类 Transformation 和 Conversion (Pass) 策略，最终传递给 Backend 做 translate。</p><p>Optimizer 大致的 workflow 如下</p><figure><img src=/static/triton-publish/optimizer.png></figure><p>主要分为三大块优化</p><ol><li>TritonIR 的优化</li><li>TritonIR to TritonGPU IR 的 Conversion</li><li>TritonGPU IR 的优化</li></ol><p>贯穿中间的数据结构是 TritonGPU IR，顾名思义是带上了 GPU 相关的信息的 IR。</p><h3 id=tritongpu-dialect>TritonGPU Dialect</h3><p>TritonGPU Dialect 相比 Triton Dialect，主要是增加了 GPU 硬件相关的 Op 和 Type。</p><p>相关的主要 Op 如下</p><ol><li><code>async_wait(N:int) -> ()</code>, 直接对应到 PTX 中的 <code>cp.async.wait_group N</code> 指令</li><li><code>alloc_tensor()->Tensor</code> , 表明 allocate 一个处于 shared memory 的 tensor</li><li><code>insert_slice_async(slice:PtrTensor, dst:Tensor, index:int, mask:i1 ...) -> Tensor</code>, 表明往 （alloc_tensor op 产生的，shared memory中的) tensor 中 insert 一个 slice，并且这个操作是 async 的</li><li><code>convert_layout(src:Tensor)->Tensor</code> ，转换 Tensor 中的 data layout</li></ol><p>前三个 Op 主要在 Pipeline 和 Prefetch 的优化（下文 Pass 中会涉及）中用到， <code>convert_layout</code> Op 在 TritonGPU Dialect 中的 Type system 比较关键，以下两个小节会重点详解。</p><h4 id=data-layout>Data layout</h4><p>Data layout 是 TritonGPU Dialect 的 Type system 的关键，确定了 Data(各层级memory中的Tensor) 到 thread 之间的映射关系。</p><p>目前 Triton 中有如下几种</p><ul><li><ol><li>Blocked Layout</li></ol><p>Blocked Layout 表示 thread 间平均分配 workload 的情况，每个线程 own 一块 memory 上连续的 data 进行处理。</p><p>其包含了如下三个字段用于帮助确定 thread 和数据之间的映射关系：</p><ul><li>sizePerThread：每个 thread 处理的 <strong>连续排布</strong> 的元素数目</li><li>threadsPerWarp：每个 Warp 在不同维度上的线程数，用向量表示</li><li>warpsPerCTA：每个 CTA 对应的 Warp 数目，这个由用户在 Python 层制定</li></ul><p>按代码中的例子</p><pre tabindex=0><code class=language-nil data-lang=nil>For example, a row-major coalesced layout may partition a 16x16 tensor over 2 warps (i.e. 64 threads) as follows.

[ 0  0  1  1  2  2  3  3  ; 32 32 33 33 34 34 35 35 ]
[ 0  0  1  1  2  2  3  3  ; 32 32 33 33 34 34 35 35 ]
[ 4  4  5  5  6  6  7  7  ; 36 36 37 37 38 38 39 39 ]
[ 4  4  5  5  6  6  7  7  ; 36 36 37 37 38 38 39 39 ]
...
[ 28 28 29 29 30 30 31 31 ; 60 60 61 61 62 62 63 63 ]
[ 28 28 29 29 30 30 31 31 ; 60 60 61 61 62 62 63 63 ]

for

#triton_gpu.blocked_layout&lt;{
  sizePerThread = {2, 2}
  threadsPerWarp = {8, 4}
  warpsPerCTA = {1, 2}
}&gt;
</code></pre></li></ul><ul><li><ol start=2><li>Shared Layout</li></ol><p>Shared Layout：表示数据在 shared memory 的一些特性，比如 swizzle 访问的一些参数。</p><p>其包含了如下字段</p><ul><li>vec, 支持 vectorization 的单位</li><li>perPhase, 每个 phase 包含多少个 vec</li><li>maxPhase, tensor 总共包含多少个 phase</li><li>order, axis 的次序</li></ul><p>其中，vec, perPhase, maxPhase 是用于避免 bank conflict 的 swizzle 操作需要的参数。</p><p>代码中的例子：</p><pre tabindex=0><code class=language-nil data-lang=nil>In order to avoid shared memory bank conflicts, elements may be swizzled
in memory. For example, a swizzled row-major layout could store its data
as follows:

A_{0, 0}  A_{0, 1}  A_{0, 2}  A_{0, 3} ...   [phase 0] \ per_phase = 2
A_{1, 0}  A_{1, 1}  A_{1, 2}  A_{1, 3} ...   [phase 0] /
groups of vec=2 elements
are stored contiguously
_ _ _ _ /\_ _ _ _
A_{2, 2}  A_{2, 3}  A_{2, 0}  A_{2, 1} ...   [phase 1] \ per phase = 2
A_{3, 2}  A_{3, 3}  A_{3, 0}  A_{3, 1} ...   [phase 1] /
</code></pre></li></ul><ul><li><ol start=3><li>MMA Layout</li></ol><p>顾名思义，MMA Layout 表示 Tensor Core 中 MMA 指令结果的 data layout，比如 Ampere 对应的 MMA Layout 的数据排布基本可以对应到 PTX 指令中的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-1684>mma.m16n8k16</a> 的 C,D 的排布。</p><p>MMA Layout 主要包含两个字段：</p><ul><li><code>version</code> ，表示 TensorCore 的版本<ul><li>1 为 Volta</li><li>2 为 Ampere</li></ul></li><li><code>warpsPerCTA</code></li></ul><p>这里演示 FP16 精度下， <code>version=2</code> 的数据排布（会映射到 <code>mma.m16n8k16</code> 指令）的 Accumulators (C or D) 的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-16816-float>数据排布</a>。</p><figure><img src=/static/mma.16816.png></figure></li></ul><ul><li><ol start=4><li>DotOperand Layout</li></ol><p>DotOperand Layout 用来表示 Triton 的 DotOp 的输入的 layout。</p><p>其主要包含如下信息</p><ol><li><code>opIdx</code> ， Operand 的 ID<ul><li><code>opIdx=0</code> 表示 DotOp 的 $a</li><li><code>opIdx=1</code> 表示 DotOp 的 $b</li></ul></li><li><code>parent</code> ，存储其对应的 MMA Layout，这里 DotOperand 的数据排布也可能间接的由 MMA Layout 确定（如果 DotOp lower 到 MMA 指令）或者 Blocked Layout（如果 DotOp lower 到 FMA 指令）</li></ol><p>这里为了方便演示，我们采用 MMA Layout 中的 <code>mma.m16n8k16.f16</code> 指令</p><ul><li><p>计算精度为 FP16</p></li><li><p>MMA Layout</p><ul><li><code>version=2</code></li><li><code>warpsPerCTA=[8,4]</code></li></ul></li><li><p>对于 $a，对应的 DotOperand 的 opIdx = 0</p></li><li><p>$b, 对应的 DotOperand 的 opIdx = 1</p><figure><img src=/static/mma.16816.op.png></figure></li></ul></li></ul><ul><li><ol start=5><li>Slice Layout</li></ol><p>Slice Layout 表明单个维度上的数据反向索引</p></li></ul><h4 id=convertlayoutop>ConvertLayoutOp</h4><p>顾名思义，ConvertLayoutOp 就是用来讲 Tensor 从一种 data layout 转换到另外一种 data layout。
由于 data layout 是 TensorType 的一部分，很自然会存在类型（其中layout）需要转换的情况，这就是 ConvertLayoutOp 的作用。</p><p>有了上面的 Data Layout，接下来我们看最简单的 MatMul 中的的 IR：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>4</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#mma</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>mma</span>&lt;{<span style=color:red>version</span> = <span style=color:#3af>2</span>, <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:red>//</span> ...
</span></span><span style=display:flex><span><span style=color:#000>%37</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span><span style=color:#000>%38</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span><span style=color:#000>%39</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%37</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span><span style=color:#000>%40</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%38</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span><span style=color:#000>%41</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%39</span>, <span style=color:#000>%40</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span><span style=color:red>//</span> ...
</span></span></code></pre></div><p>上面是截取了一段经典 MatMul 中某个阶段的 TritonGPU IR，逻辑比较直白，定义了 <code>#blocked0</code>, <code>#blocked1</code> 和 <code>#mma</code> 三种 layout，之后通过 <code>tt.load</code> 将 DotOp 的两个 Operand 从 GEMM 加载数据到 register files，之后两个 <code>triton_gpu.convert_layout</code> 转换 layout 为 DotOp 的参数需要的 <code>#triton_gpu.dot_op</code> layout。</p><p>这里列举一些典型的 data layout 的转换，以及特点：</p><ul><li><code>#shared -> #blocked</code> ，正常是代表数据从 shared memory 被 load 到 register file 中，需要考虑 swizzle</li><li><code>#blocked -> #shared</code> ，代表数据从 register file 存储到 shared memory 中，需要上一步相同的 swizzle 方式</li><li><code>#mma -> #blocked</code> ，正常是 DotOp 的输出转换为更简单的 layout 来进一步计算，由于涉及到跨 thread 间的数据传递，因此一般会借由 shared memory 中转一次</li><li><code>#blocked -> #dot_operand</code> ，转换为 DotOp 的输入，这一步可能也需要 shared memory 中转</li></ul><p>Triton 中几乎实现了任意 data layout 间的转换，当然不同的转换代价也不尽相同（考虑到是否会用到 shared memory，register 增减量等等），因此转换的代价也会在 Optimizer 里面一并考虑。</p><h3 id=tritonir-的优化>TritonIR 的优化</h3><p>TritonIR 上的优化主要是计算本身的，与硬件无关的优化，包含了如下 Pass</p><ul><li>Inliner Pass，将 Kernel Call 的子函数 Inline 展开</li><li>Combine Pass，一些特定的 Pattern rewrite，比如<ul><li><code>select(cond, load(ptrs, broadcast(cond), ???), other) => load(ptrs, broadcast(cond), other)</code></li></ul></li><li>Canonicalizer Pass，一些化简的 Pattern rewrite</li><li>CSE Pass，MLIR 的 <a href=https://mlir.llvm.org/docs/Passes/#-cse-eliminate-common-sub-expressions>cse</a> Pass，用于 Eliminate common sub-expressions</li><li>LICM Pass，MLIR 的 <a href=https://mlir.llvm.org/doxygen/LoopInvariantCodeMotion_8cpp_source.html>LoopInvariantCodeMotion Pass</a> ，将循环无关的变量挪到 forloop 外面</li></ul><h3 id=tritongpu-ir-的优化>TritonGPU IR 的优化</h3><p>TritonGPU IR 上的优化在计算本身优化外，新增了 GPU 硬件相关的优化，具体的 Pass 列表如下</p><ul><li>ConvertTritonToTritonGPU Pass，将 Triton IR 转换为 TritonGPU IR，主要是增加 TritonGPU 特有的 layout</li><li>Coalesce Pass，重排 order，使得最大 contiguity 的维度排在最前面</li><li>Combine Pass，同 Triton IR</li><li>Pipeline Pass，MMA 指令对应的 global memory 到 shared memory 的 N-Buffer 优化，下文详解</li><li>Prefetch Pass，MMA 指令对应的 shared memory 到 register file 的 N-Buffer 优化，下文详解</li><li>Canonicalizer，同 Triton IR</li><li>CSE Pass，同 Triton IR</li><li>LICM Pass，同 Triton IR</li></ul><h4 id=pipeline-pass>Pipeline Pass</h4><p>Pipeline Pass 和下一小节中的 Prefetch Pass 是配合关系，整体用来为 DotOp (mma 指令) 的 Operand 提供 IO 优化。</p><p>Pipeline 优化主要针对 DotOp 中 GEMM 到 SMEM 之间的数据拷贝，并自动做 Double Buffer 或者 N Buffer 的优化。</p><p>最简单的 Double buffer 的伪代码如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>A</span> = <span style=color:#000>alloc_tensor</span>(<span style=color:#000>shape</span>=[<span style=color:#3af>2</span>*<span style=color:#3af>16</span>,<span style=color:#3af>16</span>])
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># cp.async &amp; cp.async.commit_group</span>
</span></span><span style=display:flex><span><span style=color:#000>A</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>A</span>, <span style=color:#000>ptr0</span>, <span style=color:#3af>0</span>)
</span></span><span style=display:flex><span><span style=color:#000>B</span> = <span style=color:#000>alloc_tensor</span>(<span style=color:#000>shape</span>=[<span style=color:#3af>2</span>*<span style=color:#3af>16</span>,<span style=color:#3af>8</span>])
</span></span><span style=display:flex><span><span style=color:#000>B</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>B</span>, <span style=color:#000>ptr1</span>, <span style=color:#3af>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>A</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>A</span>, <span style=color:#000>ptr00</span>, <span style=color:#3af>1</span>)
</span></span><span style=display:flex><span><span style=color:#000>B</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>B</span>, <span style=color:#000>ptr11</span>, <span style=color:#3af>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>async_wait</span>(<span style=color:#000>num</span>=<span style=color:#3af>2</span>) <span style=color:#888;font-style:italic># cp.async.wait_group</span>
</span></span><span style=display:flex><span><span style=color:#000>A_slice0</span> = <span style=color:#000>extract_slice</span>(<span style=color:#000>A</span>, <span style=color:#000>offset</span>=(<span style=color:#3af>0</span>,<span style=color:#3af>0</span>,<span style=color:#3af>0</span>), <span style=color:#000>size</span>=(<span style=color:#3af>1</span>,<span style=color:#3af>16</span>,<span style=color:#3af>16</span>))
</span></span><span style=display:flex><span><span style=color:#000>B_slice0</span> = <span style=color:#000>extract_slice</span>(<span style=color:#000>B</span>, <span style=color:#000>offset</span>=(<span style=color:#3af>0</span>,<span style=color:#3af>0</span>,<span style=color:#3af>0</span>), <span style=color:#000>size</span>=(<span style=color:#3af>1</span>,<span style=color:#3af>16</span>,<span style=color:#3af>8</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>for</span> <span style=color:#000>i</span> <span style=color:#00f>in</span> <span style=color:#000>range</span>(...):
</span></span><span style=display:flex><span>    <span style=color:#000>a</span> = <span style=color:#000>ldmatrix</span>(<span style=color:#000>A_slice0</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>b</span> = <span style=color:#000>ldmatrix</span>(<span style=color:#000>B_slice0</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>c</span> = <span style=color:#000>dot</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>offset</span> = (<span style=color:#000>i</span>+<span style=color:#3af>1</span>) % <span style=color:#3af>2</span>
</span></span><span style=display:flex><span>    <span style=color:#000>A</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>A</span>, <span style=color:#000>ptr2</span>, <span style=color:#000>offset</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>B</span> = <span style=color:#000>insert_slice_async</span>(<span style=color:#000>B</span>, <span style=color:#000>ptr3</span>, <span style=color:#000>offset</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>async_wait</span>(<span style=color:#000>num</span>=<span style=color:#3af>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>A_slice0</span> = <span style=color:#000>extract_slice</span>(<span style=color:#000>A</span>, <span style=color:#000>offset</span>=(<span style=color:#000>offset</span>,<span style=color:#3af>0</span>,<span style=color:#3af>0</span>), <span style=color:#000>size</span>=(<span style=color:#3af>1</span>,<span style=color:#3af>16</span>,<span style=color:#3af>16</span>))
</span></span><span style=display:flex><span>    <span style=color:#000>B_slice0</span> = <span style=color:#000>extract_slice</span>(<span style=color:#000>B</span>, <span style=color:#000>offset</span>=(<span style=color:#000>offset</span>,<span style=color:#3af>0</span>,<span style=color:#3af>0</span>), <span style=color:#000>size</span>=(<span style=color:#3af>1</span>,<span style=color:#3af>16</span>,<span style=color:#3af>8</span>))
</span></span></code></pre></div><p>其中，</p><ul><li><code>alloc_tensor</code> 大致对应到 <code>triton_gpu.alloc_tensor</code></li><li><code>insert_slice_async</code> 对应到 <code>triton_gpu.insert_slice_async</code> ， 表示异步地向 Tensor 中插入一个 slice，这个过程是通过 <code>cp.async</code> 指令实现的异步</li><li><code>tensor.extract_slice</code> 表示从 Tensor 中读取一个 slice</li><li><code>async_wait</code> 的语义对应到 <code>cp.async.wait_group</code> 指令</li></ul><h4 id=prefetch-pass>Prefetch Pass</h4><p>Prefetch 的逻辑跟 Pipeline Pass 基本类似，也是 Double buffer 和 N Buffer 的优化，区别是其承担了 SMEM 到 register file 的数据搬运，IR 的表示方式是 <code>triton_gpu.convert_layout %37 : (tensor&lt;16x16xf16, #blocked0>) -> tensor&lt;16x16xf16, #triton_gpu.dot_op&lt;{opIdx = 0, parent = #mma}>></code> ， 最终映射的核心指令是 <code>ldmatrix</code> 。</p><h2 id=高性能-llvm-生成之-backend>高性能 LLVM 生成之 Backend</h2><p>Triton 的 Backend 可以有微观和宏观两个角度</p><ul><li>微观上主要包括 <code>TritonGPU IR -> LLVM Dialect</code> 的过程，这里需要注意的是，<a href=https://mlir.llvm.org/docs/Dialects/LLVM/>LLVM Dialect</a> 是 MLIR 体系中的一个表示，其可以进一步自动 lower 到 LLVM IR</li><li>宏观上进一步包括了 LLVM Dialect -> LLVM IR -> PTX -> cubin 等过程</li></ul><p>这里我们只从微观角度介绍，因为宏观角度中，大部分流程可以通过 LLVM 社区或者 CUDA 的一些设施自动完成。</p><p>Triton 的 Backend 是比较经典的 MLIR 的 Lowering，主要内容就是将 TritonGPU IR 中包含的每种 Op 逐个的 OpConversion。 不过为了高性能，以及保证 Codegen 产物的可控，Triton 在 LLVM 中大量插入了 PTX 的内联汇编（下文会介绍）。 此外，大部分 Op 的 Lowering 都是比较规则化，下文会简要介绍 Dot 指令的 Lowering。</p><h3 id=ptx-inline-asm>PTX inline asm</h3><p>Triton 中使用 Inline asm 大致几个原因：</p><ul><li>一些指令对应的操作在现有的 <code>gpu</code> 和 <code>nvgpu</code> 的 dialect 还不太完善</li><li>性能原因，比如浮点类型间的变换，一小块汇编足以</li></ul><p>Triton 里面针对 Inline asm 的封装有个简单的 wrapper，类似最简单的 <code>cp.async.wait_group</code> 的调用</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#000>PTXBuilder</span> <span style=color:#000>ptxBuilder</span>;
</span></span><span style=display:flex><span><span style=color:#00f>auto</span> &amp;<span style=color:#000>asyncWaitOp</span> = *<span style=color:#000>ptxBuilder</span>.<span style=color:#000>create</span>&lt;&gt;(<span style=color:#5a2>&#34;cp.async.wait_group&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#00f>auto</span> <span style=color:#000>num</span> = <span style=color:#000>op</span>-&gt;<span style=color:#000>getAttrOfType</span>&lt;<span style=color:#000>IntegerAttr</span>&gt;(<span style=color:#5a2>&#34;num&#34;</span>).<span style=color:#000>getInt</span>();
</span></span><span style=display:flex><span><span style=color:#000>asyncWaitOp</span>(<span style=color:#000>ptxBuilder</span>.<span style=color:#000>newConstantOperand</span>(<span style=color:#000>num</span>));
</span></span></code></pre></div><p>到稍微复杂点的 <code>ld</code> 的各种参数组合</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#00f>auto</span> &amp;<span style=color:#000>ld</span> = <span style=color:#000>ptxBuilder</span>.<span style=color:#000>create</span>&lt;&gt;(<span style=color:#5a2>&#34;ld&#34;</span>)
</span></span><span style=display:flex><span>                     -&gt;<span style=color:#000>o</span>(<span style=color:#5a2>&#34;volatile&#34;</span>, <span style=color:#000>op</span>.<span style=color:#000>getIsVolatile</span>())
</span></span><span style=display:flex><span>                     .<span style=color:#000>global</span>()
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;ca&#34;</span>, <span style=color:#000>op</span>.<span style=color:#000>getCache</span>() == <span style=color:#000>triton</span>::<span style=color:#000>CacheModifier</span>::<span style=color:#000>CA</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;cg&#34;</span>, <span style=color:#000>op</span>.<span style=color:#000>getCache</span>() == <span style=color:#000>triton</span>::<span style=color:#000>CacheModifier</span>::<span style=color:#000>CG</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;L1::evict_first&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#000>op</span>.<span style=color:#000>getEvict</span>() == <span style=color:#000>triton</span>::<span style=color:#000>EvictionPolicy</span>::<span style=color:#000>EVICT_FIRST</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;L1::evict_last&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#000>op</span>.<span style=color:#000>getEvict</span>() == <span style=color:#000>triton</span>::<span style=color:#000>EvictionPolicy</span>::<span style=color:#000>EVICT_LAST</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;L1::cache_hint&#34;</span>, <span style=color:#000>hasL2EvictPolicy</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>v</span>(<span style=color:#000>nWords</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>b</span>(<span style=color:#000>width</span>);
</span></span></code></pre></div><h3 id=mma-指令生成>MMA 指令生成</h3><p>相比于 ReduceOp 等需要跟 layout 结合的 Op 的 Lowering，DotOp 的是规则非常清晰的。</p><p>这里大致提下在 Backend，一个 Dot 的工作流涉及的阶段和 Op：</p><table><thead><tr><th></th><th>Stage</th><th>Op</th><th>Layout</th></tr></thead><tbody><tr><td>2</td><td>Load <code>$a</code>, <code>$b</code> 的 tile 到 SMEM</td><td><code>triton_gpu.insert_slice_async</code></td><td><code>#shared</code></td></tr><tr><td>3</td><td>从 SMEM Load 参数到 Register file</td><td><code>tensor.extract_slice</code></td><td><code>#dot_op</code></td></tr><tr><td>4</td><td>执行 MMA，结果会在 Registter file</td><td><code>tt.dot</code></td><td><code>#mma</code></td></tr></tbody></table><p>所以直接跟 MMA 指令相关的其实只在第 4 步，其需要的 \(a\), \(b\) 两个参数已经通过 <code>tensor.extract_slice</code> 拷贝到了 Register file，直接满足了 Ampere 上的 <code>mma</code> 指令的需求。</p><p>在 Ampere 架构上，一个 DotOp 会映射到多个 mma 指令，下面我们以 FP16 的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-16816-float>mma.m16n8k16</a> 指令为例，具体的任务设置如下</p><ul><li>Dot 计算的 tile 的尺寸是 M=32, N=16, K=16<ul><li>对应着 <code>mma.m16n8k16</code> 指令的尺寸是 <code>M=16, N=8, K=16</code> ，因此一个 tile 需要在 m, n, k 方向展开 <code>2x2x1</code> 总共 4 个 <code>mma.m16n8k16</code> 指令</li></ul></li></ul><p>最终会有类似如下的代码</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#00f>for</span> (<span style=color:#00f>unsigned</span> <span style=color:#000>k</span> = <span style=color:#3af>0</span>; <span style=color:#000>k</span> &lt; <span style=color:#000>numK</span>; ++<span style=color:#000>k</span>)
</span></span><span style=display:flex><span>      <span style=color:#00f>for</span> (<span style=color:#00f>unsigned</span> <span style=color:#000>m</span> = <span style=color:#3af>0</span>; <span style=color:#000>m</span> &lt; <span style=color:#000>numM</span>; ++<span style=color:#000>m</span>)
</span></span><span style=display:flex><span>        <span style=color:#00f>for</span> (<span style=color:#00f>unsigned</span> <span style=color:#000>n</span> = <span style=color:#3af>0</span>; <span style=color:#000>n</span> &lt; <span style=color:#000>numN</span>; ++<span style=color:#000>n</span>) {
</span></span><span style=display:flex><span>          <span style=color:#000>callMMA</span>(<span style=color:#000>m</span>, <span style=color:#000>n</span>, <span style=color:#000>k</span>);
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>其中，numM, numN, numK 就对应着上面的 2, 2, 1。</p><p>callMMA 的代码如上文时候 InlineAsm，类似如下代码</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span> <span style=color:#00f>auto</span> <span style=color:#000>mma</span> = <span style=color:#000>builder</span>.<span style=color:#000>create</span>(<span style=color:#5a2>&#34;mma.sync.aligned.m8n8k4&#34;</span>)
</span></span><span style=display:flex><span>                     -&gt;<span style=color:#000>o</span>(<span style=color:#000>isARow</span> ? <span style=color:#5a2>&#34;row&#34;</span> : <span style=color:#5a2>&#34;col&#34;</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#000>isBRow</span> ? <span style=color:#5a2>&#34;row&#34;</span> : <span style=color:#5a2>&#34;col&#34;</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#000>o</span>(<span style=color:#5a2>&#34;f32.f16.f16.f32&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>mma</span>(<span style=color:#000>resOprs</span>, <span style=color:#000>AOprs</span>, <span style=color:#000>BOprs</span>, <span style=color:#000>COprs</span>);
</span></span></code></pre></div><h2 id=fyi>FYI</h2><ul><li><a href=https://github.com/openai/triton/tree/ca05ef8e5b0b4d4834957bc31e7581b09d35c530>Triton MLIR migration code</a></li><li>Triton paper: <a href=https://www.eecs.harvard.edu/~htk/publication/2019-mapl-tillet-kung-cox.pdf>Triton: An Intermediate Language and Compiler forTiled Neural Network Computations</a></li></ul><h3 id=gemm-在-optimizer-pass-效果>GEMM 在 Optimizer Pass 效果</h3><p>下面列举了经典的 GEMM 在 Triton 的 Compile pipeline 里面的 IR 的变换。</p><h4 id=python-code>Python code</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> <span style=color:#000>matmul_kernel</span>(
</span></span><span style=display:flex><span>    <span style=color:#000>a_ptr</span>, <span style=color:#000>b_ptr</span>, <span style=color:#000>c_ptr</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>stride_am</span>, <span style=color:#000>stride_ak</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>stride_bk</span>, <span style=color:#000>stride_bn</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>stride_cm</span>, <span style=color:#000>stride_cn</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>M</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>, <span style=color:#000>N</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>, <span style=color:#000>K</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>BLOCK_SIZE_M</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>, <span style=color:#000>BLOCK_SIZE_N</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>BLOCK_SIZE_K</span>: <span style=color:#000>tl</span>.<span style=color:#000>constexpr</span>,
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#000>offs_m</span> = <span style=color:#000>tl</span>.<span style=color:#000>arange</span>(<span style=color:#3af>0</span>, <span style=color:#000>BLOCK_SIZE_M</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>offs_n</span> = <span style=color:#000>tl</span>.<span style=color:#000>arange</span>(<span style=color:#3af>0</span>, <span style=color:#000>BLOCK_SIZE_N</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>offs_k</span> = <span style=color:#000>tl</span>.<span style=color:#000>arange</span>(<span style=color:#3af>0</span>, <span style=color:#000>BLOCK_SIZE_K</span>)
</span></span><span style=display:flex><span>    <span style=color:#000>a_ptrs</span> = <span style=color:#000>a_ptr</span> + <span style=color:#000>offs_m</span>[:, <span style=color:#00f>None</span>] * <span style=color:#000>stride_am</span> + <span style=color:#000>offs_k</span>[<span style=color:#00f>None</span>, :] * <span style=color:#000>stride_ak</span>
</span></span><span style=display:flex><span>    <span style=color:#000>b_ptrs</span> = <span style=color:#000>b_ptr</span> + <span style=color:#000>offs_k</span>[:, <span style=color:#00f>None</span>] * <span style=color:#000>stride_bk</span> + <span style=color:#000>offs_n</span>[<span style=color:#00f>None</span>, :] * <span style=color:#000>stride_bn</span>
</span></span><span style=display:flex><span>    <span style=color:#000>accumulator</span> = <span style=color:#000>tl</span>.<span style=color:#000>zeros</span>((<span style=color:#000>BLOCK_SIZE_M</span>, <span style=color:#000>BLOCK_SIZE_N</span>), <span style=color:#000>dtype</span>=<span style=color:#000>tl</span>.<span style=color:#000>float32</span>)
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> <span style=color:#000>k</span> <span style=color:#00f>in</span> <span style=color:#000>range</span>(<span style=color:#3af>0</span>, <span style=color:#000>K</span>, <span style=color:#000>BLOCK_SIZE_K</span>):
</span></span><span style=display:flex><span>        <span style=color:#000>a</span> = <span style=color:#000>tl</span>.<span style=color:#000>load</span>(<span style=color:#000>a_ptrs</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>b</span> = <span style=color:#000>tl</span>.<span style=color:#000>load</span>(<span style=color:#000>b_ptrs</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>accumulator</span> += <span style=color:#000>tl</span>.<span style=color:#000>dot</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>a_ptrs</span> += <span style=color:#000>BLOCK_SIZE_K</span> * <span style=color:#000>stride_ak</span>
</span></span><span style=display:flex><span>        <span style=color:#000>b_ptrs</span> += <span style=color:#000>BLOCK_SIZE_K</span> * <span style=color:#000>stride_bk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>c_ptrs</span> = <span style=color:#000>c_ptr</span> + <span style=color:#000>offs_m</span>[:, <span style=color:#00f>None</span>] * <span style=color:#000>stride_cm</span> + <span style=color:#000>offs_n</span>[<span style=color:#00f>None</span>, :] * <span style=color:#000>stride_cn</span>
</span></span><span style=display:flex><span>    <span style=color:#000>tl</span>.<span style=color:#000>store</span>(<span style=color:#000>c_ptrs</span>, <span style=color:#000>accumulator</span>)
</span></span></code></pre></div><h4 id=triton-ir-translated-from-python-ast--and-after-inliner-ces-dot-dot-dot-passes>Triton IR translated from Python AST(and after Inliner, CES &mldr; passes)</h4><p>这一步算是 Python code 直接翻译到了 Triton IR.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>0.000000e+00</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c64</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>16</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c16_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%3</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%5</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%6</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%7</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%8</span>, <span style=color:#000>%9</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg4</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%11</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%13</span>, <span style=color:#000>%12</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%1</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%16</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%14</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%17</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%15</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%18</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%16</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%19</span><span style=color:red>:</span><span style=color:#3af>3</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%10</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%18</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      <span style=color:#000>%26</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%27</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%28</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%26</span>, <span style=color:#000>%27</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%29</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%30</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%30</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%32</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%31</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%28</span>, <span style=color:#000>%29</span>, <span style=color:#000>%32</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>%20</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg5</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%21</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%20</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%22</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%23</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%22</span>, <span style=color:#000>%21</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%24</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%23</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%25</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%24</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%25</span>, <span style=color:#000>%19</span><span style=color:#000>#0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-before-loopinvariantcodemotion>IR Before LoopInvariantCodeMotion</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>0.000000e+00</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c64</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>16</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c16_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%3</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%5</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%6</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%7</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%8</span>, <span style=color:#000>%9</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg4</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%11</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%13</span>, <span style=color:#000>%12</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%1</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%16</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%14</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%17</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%15</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%18</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%16</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%19</span><span style=color:red>:</span><span style=color:#3af>3</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%10</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%18</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      <span style=color:#000>%26</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%27</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%28</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%26</span>, <span style=color:#000>%27</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%29</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%30</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%30</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%32</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%31</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%28</span>, <span style=color:#000>%29</span>, <span style=color:#000>%32</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>%20</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg5</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%21</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%20</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%22</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%23</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%22</span>, <span style=color:#000>%21</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%24</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%23</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%25</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%24</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%25</span>, <span style=color:#000>%19</span><span style=color:#000>#0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>可以看到</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span>      <span style=color:#000>%30</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%30</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span></code></pre></div><p>这段计算的输入分别是 function argument 和 constant，不依赖 forloop 内的变量，理论上可以挪出去。</p><h4 id=ir-after-loopinvariantcodemotion>IR After LoopInvariantCodeMotion</h4><p>LoopInvariantCodeMotion 是 MLIR 社区的一个 Pass，用于将无关 variable 计算挪到 forloop 外面，可以看到上小节里面的计算已经挪出去了。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>0.000000e+00</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c64</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>16</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c16_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%3</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%5</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%6</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%7</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%8</span>, <span style=color:#000>%9</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg4</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%11</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%13</span>, <span style=color:#000>%12</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%1</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%16</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%14</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%17</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%15</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%18</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%16</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%19</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%20</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%19</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%21</span><span style=color:red>:</span><span style=color:#3af>3</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%10</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%18</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      <span style=color:#000>%28</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%29</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%30</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%28</span>, <span style=color:#000>%29</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%32</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%20</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%30</span>, <span style=color:#000>%31</span>, <span style=color:#000>%32</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>%22</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg5</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%23</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%2</span>, <span style=color:#000>%22</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%24</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%25</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%24</span>, <span style=color:#000>%23</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%26</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%25</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%27</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%26</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%27</span>, <span style=color:#000>%21</span><span style=color:#000>#0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-after-converttritontotritongpu>IR After ConvertTritonToTritonGPU</h4><p>这一步是在原有的硬件无关的 Triton IR 基础上加入了 GPU 相关的 data layout 和 operation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>2</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>1</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>3</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>4</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#blocked</span><span style=color:#3af>5</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>0</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>0.000000e+00</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>|\colorbo</span><span style=color:#00f>x</span>{<span style=color:red>yellow</span>}{<span style=color:red>\strut</span> <span style=color:red>#blocked</span><span style=color:#3af>4</span>}<span style=color:red>|</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c64</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>16</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c16_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%0</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>2</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%2</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>2</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%3</span>, <span style=color:#000>%4</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%6</span>, <span style=color:#000>%5</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%0</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>3</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%8</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>3</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>3</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%7</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%10</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%9</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>3</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>3</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%12</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>3</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%11</span>, <span style=color:#000>%13</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg4</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%16</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%3</span>, <span style=color:#000>%15</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%17</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%18</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%17</span>, <span style=color:#000>%16</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%19</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%1</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>5</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%20</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%19</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>5</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>5</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%21</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%18</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%22</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%21</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%23</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%20</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>5</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>5</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%24</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%23</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>5</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%25</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%22</span>, <span style=color:#000>%24</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%26</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%27</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%26</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%28</span><span style=color:red>:</span><span style=color:#3af>3</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%14</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%25</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;) {
</span></span><span style=display:flex><span>      <span style=color:#000>%36</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%37</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%38</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%36</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>4</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%39</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%37</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>4</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%40</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%38</span>, <span style=color:#000>%39</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>4</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>4</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%41</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%42</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%27</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%40</span>, <span style=color:#000>%41</span>, <span style=color:#000>%42</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>%29</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg5</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%30</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%3</span>, <span style=color:#000>%29</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%32</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%31</span>, <span style=color:#000>%30</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%33</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%32</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%34</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%33</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>2</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%35</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%34</span>, <span style=color:#000>%24</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%35</span>, <span style=color:#000>%28</span><span style=color:#000>#0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>这里比较明显的是</p><ol><li>作为 dotOp 的输出， <code>%40</code> 应该是 mma layout，但这一步还是 blocked layout，这个会在下一节里面改写</li><li><code>%38</code>, <code>%39</code> 这些的 layout 应该是 <code>dot_op&lt;mma></code> 但由于 mma layout 还没有给定，所以还是 <code>dot_op&lt;blocked></code></li></ol><h4 id=ir-after-tritongpucombineops>IR After TritonGPUCombineOps</h4><p>这一步会包含很多 Op pattern 的改写，直接的变化是</p><ul><li>给 dot 相关的增加了 mma 的 data layout</li><li>插入了 mma layout 相关的 <code>convert_layout</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>4</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:red>#mma</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>mma</span>&lt;{<span style=color:red>version</span> = <span style=color:#3af>2</span>, <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c64</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c16_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>0.000000e+00</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:red>dense</span>&lt;<span style=color:#3af>16</span>&gt; <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>0</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg3</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg0</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>0</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%0</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>0</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%6</span>, <span style=color:#000>%3</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%4</span>, <span style=color:#000>%7</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%8</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%5</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>0</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%10</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg4</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg1</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%14</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%15</span> = <span style=color:red>tt</span>.<span style=color:red>make_range</span> {<span style=color:#00f>end</span> = <span style=color:#3af>8</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>start</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%16</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%1</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%17</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%16</span>, <span style=color:#000>%12</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%18</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%13</span>, <span style=color:#000>%17</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%19</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%18</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%20</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%14</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%21</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%20</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%22</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%15</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%23</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%22</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%24</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%arg4</span>, <span style=color:#000>%c16_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%25</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%24</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%26</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%9</span>, <span style=color:#000>%11</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%27</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%19</span>, <span style=color:#000>%21</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%28</span><span style=color:red>:</span><span style=color:#3af>3</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%26</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%27</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) {
</span></span><span style=display:flex><span>      <span style=color:#000>%37</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg8</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%38</span> = <span style=color:red>tt</span>.<span style=color:#00f>load</span> <span style=color:#000>%arg9</span> {<span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%39</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%37</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%40</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%38</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%41</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%39</span>, <span style=color:#000>%40</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%42</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%43</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%41</span>, <span style=color:#000>%42</span>, <span style=color:#000>%43</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000>%29</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg5</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%30</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%arg2</span> <span style=color:red>:</span> (<span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%31</span> = <span style=color:red>tt</span>.<span style=color:red>expand_dims</span> <span style=color:#000>%2</span> {<span style=color:red>axis</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>slice</span>&lt;{<span style=color:red>dim</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#blocked</span><span style=color:#3af>1</span>}&gt;&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%32</span> = <span style=color:red>arith</span>.<span style=color:red>muli</span> <span style=color:#000>%31</span>, <span style=color:#000>%29</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:red>x</span><span style=color:#00f>i32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%33</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%30</span>, <span style=color:#000>%32</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%34</span> = <span style=color:red>tt</span>.<span style=color:red>broadcast</span> <span style=color:#000>%33</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>1</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%35</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%34</span>, <span style=color:#000>%23</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%36</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%28</span><span style=color:#000>#0</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>tt</span>.<span style=color:#00f>store</span> <span style=color:#000>%35</span>, <span style=color:#000>%36</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-after-tritongpupipeline>IR After TritonGPUPipeline</h4><p>这一步可以认为是在 global memory -> shared memory 的数据搬运做 Pipeline 优化。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>4</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#mma</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>mma</span>&lt;{<span style=color:red>version</span> = <span style=color:#3af>2</span>, <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>4</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>2</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>8</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>1</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>%28</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%c0</span>, <span style=color:#000>%c64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%29</span> = <span style=color:#000>triton_gpu.alloc_tensor :</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%30</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%28</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%31</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%26</span>, <span style=color:#000>%29</span>, <span style=color:#000>%c0_i32</span>, <span style=color:#000>%30</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%32</span> = <span style=color:#000>triton_gpu.alloc_tensor :</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%33</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%28</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%34</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%27</span>, <span style=color:#000>%32</span>, <span style=color:#000>%c0_i32</span>, <span style=color:#000>%33</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%35</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%26</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%36</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%27</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#000>%40</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%39</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%41</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%35</span>, <span style=color:#000>%31</span>, <span style=color:#000>%37</span>, <span style=color:#000>%40</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%42</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%39</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%43</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%36</span>, <span style=color:#000>%34</span>, <span style=color:#000>%37</span>, <span style=color:#000>%42</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%44</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%35</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%45</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%36</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c1_i32_1</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%46</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%37</span>, <span style=color:#000>%c1_i32_1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#000>%c0_i32_2</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%47</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%41</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%48</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%43</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c1_i32_3</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%49</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%c0_i32_2</span>, <span style=color:#000>%c1_i32_3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%50</span><span style=color:red>:</span><span style=color:#3af>12</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%26</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%27</span>, <span style=color:#000>%arg10</span> = <span style=color:#000>%41</span>, <span style=color:#000>%arg11</span> = <span style=color:#000>%43</span>, <span style=color:#000>%arg12</span> = <span style=color:#000>%47</span>, <span style=color:#000>%arg13</span> = <span style=color:#000>%48</span>, <span style=color:#000>%arg14</span> = <span style=color:#000>%45</span>, <span style=color:#000>%arg15</span> = <span style=color:#000>%44</span>, <span style=color:#000>%arg16</span> = <span style=color:#000>%38</span>, <span style=color:#000>%arg17</span> = <span style=color:#000>%46</span>, <span style=color:#000>%arg18</span> = <span style=color:#000>%49</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>      <span style=color:#000>%59</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg12</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%60</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg13</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%61</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%59</span>, <span style=color:#000>%60</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%62</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%63</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%64</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg16</span>, <span style=color:#000>%c16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%65</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%64</span>, <span style=color:#000>%c64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%66</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c3_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32_4</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%67</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c3_i32_4</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%68</span> = <span style=color:red>arith</span>.<span style=color:red>index_cast</span> <span style=color:#000>%67</span> <span style=color:red>:</span> <span style=color:#00f>i32</span> <span style=color:#00f>to</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%69</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%65</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%70</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%arg10</span>, <span style=color:#000>%66</span>, <span style=color:#000>%69</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%71</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%65</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%72</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%arg11</span>, <span style=color:#000>%66</span>, <span style=color:#000>%71</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%73</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%74</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%75</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%70</span>[<span style=color:#000>%68</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%76</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%72</span>[<span style=color:#000>%68</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_5</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%77</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c1_i32_5</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_6</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%78</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c1_i32_6</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%61</span>, <span style=color:#000>%62</span>, <span style=color:#000>%63</span>, <span style=color:#000>%70</span>, <span style=color:#000>%72</span>, <span style=color:#000>%75</span>, <span style=color:#000>%76</span>, <span style=color:#000>%74</span>, <span style=color:#000>%73</span>, <span style=color:#000>%64</span>, <span style=color:#000>%77</span>, <span style=color:#000>%78</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-before-tritongpuprefetch>IR Before TritonGPUPrefetch</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>4</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#mma</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>mma</span>&lt;{<span style=color:red>version</span> = <span style=color:#3af>2</span>, <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>4</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>2</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>8</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>1</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt;, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>%28</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%c0</span>, <span style=color:#000>%c64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%29</span> = <span style=color:#000>triton_gpu.alloc_tensor :</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%30</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%28</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%31</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%26</span>, <span style=color:#000>%29</span>, <span style=color:#000>%c0_i32</span>, <span style=color:#000>%30</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%32</span> = <span style=color:#000>triton_gpu.alloc_tensor :</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%33</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%28</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%34</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%27</span>, <span style=color:#000>%32</span>, <span style=color:#000>%c0_i32</span>, <span style=color:#000>%33</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%35</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%26</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%36</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%27</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#000>%40</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%39</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%41</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%35</span>, <span style=color:#000>%31</span>, <span style=color:#000>%37</span>, <span style=color:#000>%40</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%42</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%39</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%43</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%36</span>, <span style=color:#000>%34</span>, <span style=color:#000>%37</span>, <span style=color:#000>%42</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%44</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%35</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%45</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%36</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c1_i32_1</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%46</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%37</span>, <span style=color:#000>%c1_i32_1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#000>%c0_i32_2</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%47</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%41</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%48</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%43</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c1_i32_3</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%49</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%c0_i32_2</span>, <span style=color:#000>%c1_i32_3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%50</span><span style=color:red>:</span><span style=color:#3af>12</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%26</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%27</span>, <span style=color:#000>%arg10</span> = <span style=color:#000>%41</span>, <span style=color:#000>%arg11</span> = <span style=color:#000>%43</span>, <span style=color:#000>%arg12</span> = <span style=color:#000>%47</span>, <span style=color:#000>%arg13</span> = <span style=color:#000>%48</span>, <span style=color:#000>%arg14</span> = <span style=color:#000>%45</span>, <span style=color:#000>%arg15</span> = <span style=color:#000>%44</span>, <span style=color:#000>%arg16</span> = <span style=color:#000>%38</span>, <span style=color:#000>%arg17</span> = <span style=color:#000>%46</span>, <span style=color:#000>%arg18</span> = <span style=color:#000>%49</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%59</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg12</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%60</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg13</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%61</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%59</span>, <span style=color:#000>%60</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%62</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%63</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%64</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg16</span>, <span style=color:#000>%c16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%65</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%64</span>, <span style=color:#000>%c64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%66</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c3_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32_4</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%67</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c3_i32_4</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%68</span> = <span style=color:red>arith</span>.<span style=color:red>index_cast</span> <span style=color:#000>%67</span> <span style=color:red>:</span> <span style=color:#00f>i32</span> <span style=color:#00f>to</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%69</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%65</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%70</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%arg10</span>, <span style=color:#000>%66</span>, <span style=color:#000>%69</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%71</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%65</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%72</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%arg11</span>, <span style=color:#000>%66</span>, <span style=color:#000>%71</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%73</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%74</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex><span>      <span style=color:#000>%75</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%70</span>[<span style=color:#000>%68</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%76</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%72</span>[<span style=color:#000>%68</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_5</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%77</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c1_i32_5</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_6</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%78</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c1_i32_6</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%61</span>, <span style=color:#000>%62</span>, <span style=color:#000>%63</span>, <span style=color:#000>%70</span>, <span style=color:#000>%72</span>, <span style=color:#000>%75</span>, <span style=color:#000>%76</span>, <span style=color:#000>%74</span>, <span style=color:#000>%73</span>, <span style=color:#000>%64</span>, <span style=color:#000>%77</span>, <span style=color:#000>%78</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-after-tritongpuprefetch>IR After TritonGPUPrefetch</h4><p>这一步可以认为是在 Dot 相关的 shared memory -> registers 的数据搬运阶段做 Pipepline 优化。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>8</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>16</span>, <span style=color:#3af>2</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#blocked</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>blocked</span>&lt;{<span style=color:red>sizePerThread</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>threadsPerWarp</span> = [<span style=color:#3af>4</span>, <span style=color:#3af>8</span>], <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>], <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#mma</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>mma</span>&lt;{<span style=color:red>version</span> = <span style=color:#3af>2</span>, <span style=color:red>warpsPerCTA</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>0</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>4</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>2</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:red>#shared</span><span style=color:#3af>1</span> = <span style=color:red>#triton_gpu</span>.<span style=color:red>shared</span>&lt;{<span style=color:red>ve</span><span style=color:#00f>c</span> = <span style=color:#3af>8</span>, <span style=color:red>perPhase</span> = <span style=color:#3af>8</span>, <span style=color:red>maxPhase</span> = <span style=color:#3af>1</span>, <span style=color:red>order</span> = [<span style=color:#3af>1</span>, <span style=color:#3af>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:red>publi</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c56c78c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#000>%c0_i32_2</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%47</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%41</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%48</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%43</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%c1_i32_3</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%49</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%c0_i32_2</span>, <span style=color:#000>%c1_i32_3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%50</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%47</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%51</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%50</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%52</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%48</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%53</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%52</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%54</span><span style=color:red>:</span><span style=color:#3af>14</span> = <span style=color:red>scf</span>.<span style=color:red>f</span><span style=color:#00f>or</span> <span style=color:#000>%arg6</span> = <span style=color:#000>%c0</span> <span style=color:#00f>to</span> <span style=color:#000>%c64</span> <span style=color:red>step</span> <span style=color:#000>%c16</span> <span style=color:red>iter_args</span>(<span style=color:#000>%arg7</span> = <span style=color:#000>%cst</span>, <span style=color:#000>%arg8</span> = <span style=color:#000>%26</span>, <span style=color:#000>%arg9</span> = <span style=color:#000>%27</span>, <span style=color:#000>%arg10</span> = <span style=color:#000>%41</span>, <span style=color:#000>%arg11</span> = <span style=color:#000>%43</span>, <span style=color:#000>%arg12</span> = <span style=color:#000>%47</span>, <span style=color:#000>%arg13</span> = <span style=color:#000>%48</span>, <span style=color:#000>%arg14</span> = <span style=color:#000>%45</span>, <span style=color:#000>%arg15</span> = <span style=color:#000>%44</span>, <span style=color:#000>%arg16</span> = <span style=color:#000>%38</span>, <span style=color:#000>%arg17</span> = <span style=color:#000>%46</span>, <span style=color:#000>%arg18</span> = <span style=color:#000>%49</span>, <span style=color:#000>%arg19</span> = <span style=color:#000>%51</span>, <span style=color:#000>%arg20</span> = <span style=color:#000>%53</span>) <span style=color:red>-</span>&gt; (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;) {
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%63</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg12</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%64</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%arg13</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%65</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%63</span>, <span style=color:#000>%64</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%66</span> = <span style=color:red>tt</span>.<span style=color:red>dot</span> <span style=color:#000>%arg19</span>, <span style=color:#000>%arg20</span>, <span style=color:#000>%arg7</span> {<span style=color:red>allowTF</span><span style=color:#3af>32</span> = <span style=color:#00f>true</span>, <span style=color:red>transA</span> = <span style=color:#00f>false</span>, <span style=color:red>transB</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; * <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%67</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg8</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%68</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg9</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%69</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg16</span>, <span style=color:#000>%c16</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%70</span> = <span style=color:red>arith</span>.<span style=color:red>cmpi</span> <span style=color:#00f>slt</span>, <span style=color:#000>%69</span>, <span style=color:#000>%c64</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%71</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c3_i32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c3_i32_4</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%72</span> = <span style=color:red>arith</span>.<span style=color:red>remsi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c3_i32_4</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%73</span> = <span style=color:red>arith</span>.<span style=color:red>index_cast</span> <span style=color:#000>%72</span> <span style=color:red>:</span> <span style=color:#00f>i32</span> <span style=color:#00f>to</span> <span style=color:red>inde</span><span style=color:#00f>x</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%74</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%70</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%75</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%arg10</span>, <span style=color:#000>%71</span>, <span style=color:#000>%74</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%76</span> = <span style=color:red>tt</span>.<span style=color:red>splat</span> <span style=color:#000>%70</span> <span style=color:red>:</span> (<span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>x</span><span style=color:#00f>i1</span>, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%77</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>insert_slice_asyn</span><span style=color:#00f>c</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%arg11</span>, <span style=color:#000>%71</span>, <span style=color:#000>%76</span> {<span style=color:red>axis</span> = <span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>cache</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>evict</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>isVolatile</span> = <span style=color:#00f>false</span>} <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt; <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%78</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg15</span>, <span style=color:#000>%cst_0</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%79</span> = <span style=color:red>tt</span>.<span style=color:red>addptr</span> <span style=color:#000>%arg14</span>, <span style=color:#000>%25</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:red>triton_gpu</span>.<span style=color:red>async_wait</span> {<span style=color:red>num</span> = <span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}
</span></span><span style=display:flex><span>      <span style=color:#000>%80</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%75</span>[<span style=color:#000>%73</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%81</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%77</span>[<span style=color:#000>%73</span>, <span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_5</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%82</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg17</span>, <span style=color:#000>%c1_i32_5</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%c1_i32_6</span> = <span style=color:red>arith</span>.<span style=color:#00f>constant</span> <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%83</span> = <span style=color:red>arith</span>.<span style=color:red>addi</span> <span style=color:#000>%arg18</span>, <span style=color:#000>%c1_i32_6</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%84</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%80</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>16</span>, <span style=color:#3af>16</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%85</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%84</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:#000>%86</span> = <span style=color:red>tens</span><span style=color:#00f>or</span>.<span style=color:red>extract_slice</span> <span style=color:#000>%81</span>[<span style=color:#3af>0</span>, <span style=color:#3af>0</span>] [<span style=color:#3af>16</span>, <span style=color:#3af>8</span>] [<span style=color:#3af>1</span>, <span style=color:#3af>1</span>] <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt; <span style=color:#00f>to</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;
</span></span><span style=display:flex;background-color:#e5e5e5><span>      <span style=color:#000>%87</span> = <span style=color:red>triton_gpu</span>.<span style=color:red>convert_layout</span> <span style=color:#000>%86</span> <span style=color:red>:</span> (<span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span style=color:red>scf</span>.<span style=color:red>yield</span> <span style=color:#000>%65</span>, <span style=color:#000>%67</span>, <span style=color:#000>%68</span>, <span style=color:#000>%75</span>, <span style=color:#000>%77</span>, <span style=color:#000>%80</span>, <span style=color:#000>%81</span>, <span style=color:#000>%79</span>, <span style=color:#000>%78</span>, <span style=color:#000>%69</span>, <span style=color:#000>%82</span>, <span style=color:#000>%83</span>, <span style=color:#000>%85</span>, <span style=color:#000>%87</span> <span style=color:red>:</span> <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>32</span>, <span style=color:red>#mma</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>3</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>0</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#shared</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>1</span>&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:#00f>x</span><span style=color:#000>!tt.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>&gt;, <span style=color:red>#blocked</span><span style=color:#3af>0</span>&gt;, <span style=color:red>inde</span><span style=color:#00f>x</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>16</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>0</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;, <span style=color:red>tens</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>16</span><span style=color:red>x</span><span style=color:#3af>8</span><span style=color:red>xf</span><span style=color:#3af>16</span>, <span style=color:red>#triton_gpu</span>.<span style=color:red>dot_op</span>&lt;{<span style=color:red>opId</span><span style=color:#00f>x</span> = <span style=color:#3af>1</span>, <span style=color:red>parent</span> = <span style=color:red>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:red>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-after-tritongputollvm>IR After TritonGPUToLLVM</h4><p>MLIR 阶段的最后一步就是 translate 到 LLVM dialect，可以看到其中 Triton backend 插入的 Inline Asm。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#00f>module</span> <span style=color:#00f>attributes</span> {<span style=color:#5a2>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#3af>4</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>triton_gpu</span>.<span style=color:red>shared</span> = <span style=color:#3af>36864</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} {
</span></span><span style=display:flex><span>  <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>global</span> <span style=color:#00f>external</span> <span style=color:#000>@global_smem</span>() {<span style=color:red>addr_space</span> = <span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>} <span style=color:red>:</span> <span style=color:#000>!llvm.array</span>&lt;<span style=color:#3af>0</span> <span style=color:#00f>x</span> <span style=color:#00f>i8</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:red>llvm</span>.<span style=color:red>fun</span><span style=color:#00f>c</span> <span style=color:#000>@matmul_kernel_0d1d2d3d4c5d6c7d8c</span>(<span style=color:#000>%arg0</span><span style=color:red>:</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>, <span style=color:#3af>1</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg1</span><span style=color:red>:</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>, <span style=color:#3af>1</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg2</span><span style=color:red>:</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:#3af>1</span>&gt; {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg3</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg4</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}, <span style=color:#000>%arg5</span><span style=color:red>:</span> <span style=color:#00f>i32</span> {<span style=color:red>tt</span>.<span style=color:red>divisibility</span> = <span style=color:#3af>16</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>}) <span style=color:#00f>attributes</span> {<span style=color:red>nvvm</span>.<span style=color:red>kernel</span> = <span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:red>u</span><span style=color:#00f>i1</span>, <span style=color:red>nvvm</span>.<span style=color:red>maxntid</span> = <span style=color:#3af>128</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>, <span style=color:red>sym_visibility</span> = <span style=color:#5a2>&#34;public&#34;</span>} {
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:red>addressof</span> <span style=color:#000>@global_smem</span> <span style=color:red>:</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>array</span>&lt;<span style=color:#3af>0</span> <span style=color:#00f>x</span> <span style=color:#00f>i8</span>&gt;, <span style=color:#3af>3</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> = <span style=color:red>llvm</span>.<span style=color:#00f>bitcast</span> <span style=color:#000>%0</span> <span style=color:red>:</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>array</span>&lt;<span style=color:#3af>0</span> <span style=color:#00f>x</span> <span style=color:#00f>i8</span>&gt;, <span style=color:#3af>3</span>&gt; <span style=color:#00f>to</span> <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:#00f>i8</span>, <span style=color:#3af>3</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>3</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>1</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>0</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>2</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#00f>true</span>) <span style=color:red>:</span> <span style=color:#00f>i1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>32</span> <span style=color:red>:</span> <span style=color:red>inde</span><span style=color:#00f>x</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>32</span> <span style=color:red>:</span> <span style=color:#00f>i32</span>) <span style=color:red>:</span> <span style=color:#00f>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> = <span style=color:red>llvm</span>.<span style=color:red>mlir</span>.<span style=color:#00f>constant</span>(<span style=color:#3af>0.000000e+00</span> <span style=color:red>:</span> <span style=color:red>f</span><span style=color:#3af>32</span>) <span style=color:red>:</span> <span style=color:red>f</span><span style=color:#3af>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%567</span> = <span style=color:red>llvm</span>.<span style=color:red>inline_</span><span style=color:#00f>asm</span> <span style=color:red>has_side_effects</span> <span style=color:red>asm_dialect</span> = <span style=color:red>att</span> <span style=color:red>operand_attrs</span> = [] <span style=color:#5a2>&#34;ldmatrix.sync.aligned.m8n8.x4.shared.b16 { $0, $1, $2, $3 }, [ $4 + 0 ];&#34;</span>, <span style=color:#5a2>&#34;=r,=r,=r,=r,r&#34;</span> <span style=color:#000>%566</span> <span style=color:red>:</span> (<span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>16</span>, <span style=color:#3af>3</span>&gt;) <span style=color:red>-</span>&gt; <span style=color:#000>!llvm.struct</span>&lt;(<span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;)&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%765</span> = <span style=color:red>llvm</span>.<span style=color:red>inline_</span><span style=color:#00f>asm</span> <span style=color:red>has_side_effects</span> <span style=color:red>asm_dialect</span> = <span style=color:red>att</span> <span style=color:red>operand_attrs</span> = [] <span style=color:#5a2>&#34;mma.sync.aligned.m16n8k16.row.col.f32.f16.f16.f32 { $0, $1, $2, $3 }, { $4, $5, $6, $7 }, { $8, $9 }, { $10, $11, $12, $13 };&#34;</span>, <span style=color:#5a2>&#34;=r,=r,=r,=r,r,r,r,r,r,r,0,1,2,3&#34;</span> <span style=color:#000>%677</span>, <span style=color:#000>%679</span>, <span style=color:#000>%678</span>, <span style=color:#000>%680</span>, <span style=color:#000>%685</span>, <span style=color:#000>%686</span>, <span style=color:#000>%701</span>, <span style=color:#000>%702</span>, <span style=color:#000>%703</span>, <span style=color:#000>%704</span> <span style=color:red>:</span> (<span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>vect</span><span style=color:#00f>or</span>&lt;<span style=color:#3af>2</span><span style=color:red>xf</span><span style=color:#3af>16</span>&gt;, <span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>) <span style=color:red>-</span>&gt; <span style=color:#000>!llvm.struct</span>&lt;(<span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:red>f</span><span style=color:#3af>32</span>)&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:#000>%1789</span> = <span style=color:red>llvm</span>.<span style=color:red>inline_</span><span style=color:#00f>asm</span> <span style=color:red>has_side_effects</span> <span style=color:red>asm_dialect</span> = <span style=color:red>att</span> <span style=color:red>operand_attrs</span> = [] <span style=color:#5a2>&#34;@$5 st.global.v4.b32 [ $4 + 0 ], { $0, $1, $2, $3 };&#34;</span>, <span style=color:#5a2>&#34;r,r,r,r,l,b&#34;</span> <span style=color:#000>%1782</span>, <span style=color:#000>%1784</span>, <span style=color:#000>%1786</span>, <span style=color:#000>%1788</span>, <span style=color:#000>%1449</span>, <span style=color:#000>%6</span> <span style=color:red>:</span> (<span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>, <span style=color:#00f>i32</span>, <span style=color:#000>!llvm.ptr</span>&lt;<span style=color:red>f</span><span style=color:#3af>32</span>, <span style=color:#3af>1</span>&gt;, <span style=color:#00f>i1</span>) <span style=color:red>-</span>&gt; <span style=color:#000>!llvm.void</span>
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p class="footer text-center">Copyright (c) 2023 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script>
<script>feather.replace()</script></body></html>