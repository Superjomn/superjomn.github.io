<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | OpenAI/Triton MLIR 迁移工作简介</title>
<meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><script src=https://cdn.jsdelivr.net/npm/cash-dom/dist/cash.min.js></script><script>$(function(){$("article table").addClass("table")})</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home
</a><a class=nav-link href=/tags/tech><i data-feather=terminal></i>
Tech
</a><a class=nav-link href=/tags/life><i data-feather=coffee></i>
Life
</a><a class=nav-link href=/posts/><i data-feather=archive></i>
Archive
</a><a class=nav-link href=/tags/><i data-feather=tag></i>
Tags
</a><a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><main><article><h1>OpenAI/Triton MLIR 迁移工作简介</h1><i data-feather=calendar></i> <time datetime=2022-11-15>Nov 15, 2022</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/triton>triton</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/system>system</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/tech>tech</a><br><br><p><b>Table of Contents</b></p><aside><nav id=TableOfContents><ol><li><a href=#triton-简介>Triton 简介</a><ol><li><a href=#定位>定位</a></li><li><a href=#新代码中的架构>新代码中的架构</a></li></ol></li><li><a href=#python-界面之-frontend>Python 界面之 Frontend</a></li><li><a href=#性能优化之-optimizer>性能优化之 Optimizer</a><ol><li><a href=#tritongpu-dialect>TritonGPU Dialect</a><ol><li><a href=#data-layout>Data layout</a></li><li><a href=#convertlayoutop>ConvertLayoutOp</a></li></ol></li><li><a href=#tritonir-的优化>TritonIR 的优化</a></li><li><a href=#tritongpu-ir-的优化>TritonGPU IR 的优化</a><ol><li><a href=#pipeline-pass>Pipeline Pass</a></li><li><a href=#prefetch-pass>Prefetch Pass</a></li></ol></li></ol></li><li><a href=#高性能-llvm-生成之-backend>高性能 LLVM 生成之 Backend</a><ol><li><a href=#ptx-inline-asm>PTX inline asm</a></li><li><a href=#mma-指令生成>MMA 指令生成</a></li></ol></li><li><a href=#fyi>FYI</a><ol><li><a href=#gemm-在-optimizer-pass-效果>GEMM 在 Optimizer Pass 效果</a><ol><li><a href=#python-code>Python code</a></li><li><a href=#triton-ir-translated-from-python-ast--and-after-inliner-ces-dot-dot-dot-passes>Triton IR translated from Python AST(and after Inliner, CES &mldr; passes)</a></li><li><a href=#ir-before-loopinvariantcodemotion>IR Before LoopInvariantCodeMotion</a></li><li><a href=#ir-after-loopinvariantcodemotion>IR After LoopInvariantCodeMotion</a></li><li><a href=#ir-after-converttritontotritongpu>IR After ConvertTritonToTritonGPU</a></li><li><a href=#ir-after-tritongpucombineops>IR After TritonGPUCombineOps</a></li><li><a href=#ir-after-tritongpupipeline>IR After TritonGPUPipeline</a></li><li><a href=#ir-before-tritongpuprefetch>IR Before TritonGPUPrefetch</a></li><li><a href=#ir-after-tritongpuprefetch>IR After TritonGPUPrefetch</a></li><li><a href=#ir-after-tritongputollvm>IR After TritonGPUToLLVM</a></li></ol></li></ol></li></ol></nav></aside><br><p>经过几个月的不懈努力，OpenAI Triton已经成功完成了面向MLIR Infra的迁移/重构工作，并将其最新的基于MLIR的代码合并至主分支。这个工作是由OpenAI和NVIDIA相关团队近几个月来深入合作完成的，而我也有幸参与其中。在这篇文章中，我将分享一些技术总结，记录一些收获和思考。</p><p>尽管Triton目前的开源开发非常迅速，但本文将主要聚焦于基于MLIR Infra进行重构的第一个版本的<a href=https://github.com/openai/triton/tree/ca05ef8e5b0b4d4834957bc31e7581b09d35c530>代码</a>（这应该也是两三个月前的）</p><h2 id=triton-简介>Triton 简介</h2><p>OpenAI Triton <a href=https://www.eecs.harvard.edu/~htk/publication/2019-mapl-tillet-kung-cox.pdf>paper</a> 中的介绍是 &ldquo;An Intermediate Language and Compiler for Tiled Neural Network Computations&rdquo;，其中几个关键词应该能够代表其特点：</p><ul><li><em>Intermediate Language</em>, 目前是基于 Python 的 DSL</li><li><em>Compiler</em> ，是一个经典的 Compiler 的架构</li><li><em>Tiled</em> Computation，面向 GPU 体系特点，自动分析和实施 tiling</li></ul><h3 id=定位>定位</h3><p>由于 Triton 的开发非常迅速，这里只讨论当前 Triton 的功能。</p><p>简而言之，Triton 提供了一套针对 GPU Kernel 的开发的 Language（基于 Python） 和 高性能 Compiler。</p><figure><img src=/static/triton-publish/1.png></figure><p>因此，就层次而言，Triton的 DNN 开发能力与 CUDA 的部分相对应，但与TVM、XLA等直接面向 DL 的 Domain compiler 无法完全对应。
后者更像是面向 DL 的武器库，拥有从构图到 auto fusion 等端到端的能力，而Triton则更像一把小巧、实用的瑞士军刀，面向偏底层的也是最通用的 Kernel 开发问题。</p><h3 id=新代码中的架构>新代码中的架构</h3><p>Triton 新代码中的架构总体上可以如下呈现</p><figure><img src=/static/triton-publish/three-components.png></figure><p>即总体上可以分为三大块</p><ol><li>Frontend，将用户的 Python kernel code 转换为 Triton IR，以及维护 kernel launch 的 Runtime</li><li>Optimizer，通过各类 pass 将 Triton IR 逐步转换为优化过的 TritonGPU IR</li><li>Backend，将 TritonGPU IR 逐步转换为 LLVM IR，并最终通过 ptxas 编译为 cubin</li></ol><p>贯穿这三部分的核心表示是 Triton 的 IR，微观上，IR 也分为两个层次</p><ol><li>Triton Dialect，表示计算逻辑，硬件无关的表达</li><li>TritonGPU Dialect，GPU 相关的计算表示</li></ol><p>这两者都是基于 MLIR 的自定义 dialect，除此之外，Triton 也复用了很多社区的 dialect 来进行宏观的表示，包括</p><ul><li><code>std</code> dialect： tensor, int, float 等数据类型</li><li><code>arith</code> dialect：各类数学操作</li><li><code>scf</code> dialect：if, for 等控制流</li><li><code>nvvm</code> dialect：获取 <code>thread_id</code> 等少量操作</li><li><code>gpu</code> dialect：printf 等少量操作</li></ul><p>下图是 Triton 中核心表示完整的转换过程：</p><figure><img src=/static/2023-01-29_15-59-49_screenshot.png></figure><p>其中蓝色的两部分主要是 MLIR 体系涉及的部分，随后 MLIR 会转换为 LLVM IR，之后 Triton 会调用 NVPTX 转换为 PTX Assembly，随后由 CUDA 的 ptxas 编译器编译为 cubin。</p><h2 id=python-界面之-frontend>Python 界面之 Frontend</h2><p>Frontend 用于将用户用 Python 编写的 kernel 转换为对应的 Triton IR (Triton Dialect)，这里由于篇幅不便展开，细节可以阅读 <a href=https://github.com/openai/triton/blob/ca05ef8e5b0b4d4834957bc31e7581b09d35c530/python/triton/compiler.py#L108>compiler.py::CodeGenerator</a> 中基于 Python ast 的规则。</p><p>比如 vector add 的例子</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#555;font-weight:700>@triton.jit</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>add_kernel</span>(x_ptr, y_ptr, output_ptr, N,
</span></span><span style=display:flex><span>               BLOCK_SIZE: tl<span style=color:#666>.</span>constexpr):
</span></span><span style=display:flex><span>    pid <span style=color:#666>=</span> tl<span style=color:#666>.</span>program_id(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>    block_start <span style=color:#666>=</span> pid <span style=color:#666>*</span> BLOCK_SIZE
</span></span><span style=display:flex><span>    offsets <span style=color:#666>=</span> block_start <span style=color:#666>+</span> tl<span style=color:#666>.</span>arange(<span style=color:#40a070>0</span>, BLOCK_SIZE)
</span></span><span style=display:flex><span>    mask <span style=color:#666>=</span> offsets <span style=color:#666>&lt;</span> N
</span></span><span style=display:flex><span>    x <span style=color:#666>=</span> tl<span style=color:#666>.</span>load(x_ptr <span style=color:#666>+</span> offsets, mask<span style=color:#666>=</span>mask)
</span></span><span style=display:flex><span>    y <span style=color:#666>=</span> tl<span style=color:#666>.</span>load(y_ptr <span style=color:#666>+</span> offsets, mask<span style=color:#666>=</span>mask)
</span></span><span style=display:flex><span>    output <span style=color:#666>=</span> x <span style=color:#666>+</span> y
</span></span><span style=display:flex><span>    tl<span style=color:#666>.</span>store(output_ptr<span style=color:#666>+</span>offsets, output, mask<span style=color:#666>=</span>mask)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># x, y are torch.Tensor</span>
</span></span><span style=display:flex><span>grid <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>lambda</span> meta: (triton<span style=color:#666>.</span>cdiv(n_elements, meta[<span style=color:#4070a0>&#39;BLOCK_SIZE&#39;</span>]),)
</span></span><span style=display:flex><span>add_kernel[grid](x, y, output, n_elements, BLOCK_SIZE<span style=color:#666>=</span><span style=color:#40a070>1024</span>)
</span></span></code></pre></div><p>相应会得到 Triton IR</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @kernel_0d1d2d3d(
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>},
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}) {
</span></span><span style=display:flex><span>  <span style=color:#bb60d5>%c256_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>256</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  %0 = <span>tt</span>.<span>get_program_id</span> {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  %1 = <span>arith</span>.<span>muli</span> %0, <span style=color:#bb60d5>%c256_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  %2 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>256</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>  %3 = <span>tt</span>.<span>splat</span> %1 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>  %4 = <span>arith</span>.<span>addi</span> %3, %2 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>  %5 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  %6 = <span>tt</span>.<span>addptr</span> %5, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  %7 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  %8 = <span>tt</span>.<span>addptr</span> %7, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  %9 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>  %10 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, %4, %9 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>  %11 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> %6, %10
</span></span><span style=display:flex><span>  %12 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> %8, %10
</span></span><span style=display:flex><span>  %13 = <span>arith</span>.<span>addf</span> %11, %12 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>  %14 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  %15 = <span>tt</span>.<span>addptr</span> %14, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>  <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %15, %13, %10 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>256</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>  <span>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到，Triton IR 几乎一比一地对应到原始的 Python code，将用户定义的 computation 带入 MLIR 的体系，后续会在此基础上做各类优化（by Optimizer）以及最终 translate 到更低层次的表示中（by Backend）。</p><h2 id=性能优化之-optimizer>性能优化之 Optimizer</h2><p>Optimizer 用于分析和优化 Frontend 传入的 IR，通过各类 Transformation 和 Conversion (Pass) 策略，最终传递给 Backend 做 translate。</p><p>Optimizer 大致的 workflow 如下</p><figure><img src=/static/triton-publish/optimizer.png></figure><p>主要分为三大块优化</p><ol><li>TritonIR 的优化</li><li>TritonIR to TritonGPU IR 的 Conversion</li><li>TritonGPU IR 的优化</li></ol><p>贯穿中间的数据结构是 TritonGPU IR，顾名思义是带上了 GPU 相关的信息的 IR。</p><h3 id=tritongpu-dialect>TritonGPU Dialect</h3><p>TritonGPU Dialect 相比 Triton Dialect，主要是增加了 GPU 硬件相关的 Op 和 Type。</p><p>相关的主要 Op 如下</p><ol><li><code>async_wait(N:int) -> ()</code>, 直接对应到 PTX 中的 <code>cp.async.wait_group N</code> 指令</li><li><code>alloc_tensor()->Tensor</code> , 表明 allocate 一个处于 shared memory 的 tensor</li><li><code>insert_slice_async(slice:PtrTensor, dst:Tensor, index:int, mask:i1 ...) -> Tensor</code>, 表明往 （alloc_tensor op 产生的，shared memory中的) tensor 中 insert 一个 slice，并且这个操作是 async 的</li><li><code>convert_layout(src:Tensor)->Tensor</code> ，转换 Tensor 中的 data layout</li></ol><p>前三个 Op 主要在 Pipeline 和 Prefetch 的优化（下文 Pass 中会涉及）中用到， <code>convert_layout</code> Op 在 TritonGPU Dialect 中的 Type system 比较关键，以下两个小节会重点详解。</p><h4 id=data-layout>Data layout</h4><p>Data layout 是 TritonGPU Dialect 的 Type system 的关键，确定了 Data(各层级memory中的Tensor) 到 thread 之间的映射关系。</p><p>目前 Triton 中有如下几种</p><ul><li><ol><li>Blocked Layout</li></ol><p>Blocked Layout 表示 thread 间平均分配 workload 的情况，每个线程 own 一块 memory 上连续的 data 进行处理。</p><p>其包含了如下三个字段用于帮助确定 thread 和数据之间的映射关系：</p><ul><li>sizePerThread：每个 thread 处理的 <strong>连续排布</strong> 的元素数目</li><li>threadsPerWarp：每个 Warp 在不同维度上的线程数，用向量表示</li><li>warpsPerCTA：每个 CTA 对应的 Warp 数目，这个由用户在 Python 层制定</li></ul><p>按代码中的例子</p><pre tabindex=0><code class=language-nil data-lang=nil>For example, a row-major coalesced layout may partition a 16x16 tensor over 2 warps (i.e. 64 threads) as follows.

[ 0  0  1  1  2  2  3  3  ; 32 32 33 33 34 34 35 35 ]
[ 0  0  1  1  2  2  3  3  ; 32 32 33 33 34 34 35 35 ]
[ 4  4  5  5  6  6  7  7  ; 36 36 37 37 38 38 39 39 ]
[ 4  4  5  5  6  6  7  7  ; 36 36 37 37 38 38 39 39 ]
...
[ 28 28 29 29 30 30 31 31 ; 60 60 61 61 62 62 63 63 ]
[ 28 28 29 29 30 30 31 31 ; 60 60 61 61 62 62 63 63 ]

for

#triton_gpu.blocked_layout&lt;{
  sizePerThread = {2, 2}
  threadsPerWarp = {8, 4}
  warpsPerCTA = {1, 2}
}&gt;
</code></pre></li></ul><ul><li><ol start=2><li>Shared Layout</li></ol><p>Shared Layout：表示数据在 shared memory 的一些特性，比如 swizzle 访问的一些参数。</p><p>其包含了如下字段</p><ul><li>vec, 支持 vectorization 的单位</li><li>perPhase, 每个 phase 包含多少个 vec</li><li>maxPhase, tensor 总共包含多少个 phase</li><li>order, axis 的次序</li></ul><p>其中，vec, perPhase, maxPhase 是用于避免 bank conflict 的 swizzle 操作需要的参数。</p><p>代码中的例子：</p><pre tabindex=0><code class=language-nil data-lang=nil>In order to avoid shared memory bank conflicts, elements may be swizzled
in memory. For example, a swizzled row-major layout could store its data
as follows:

A_{0, 0}  A_{0, 1}  A_{0, 2}  A_{0, 3} ...   [phase 0] \ per_phase = 2
A_{1, 0}  A_{1, 1}  A_{1, 2}  A_{1, 3} ...   [phase 0] /
groups of vec=2 elements
are stored contiguously
_ _ _ _ /\_ _ _ _
A_{2, 2}  A_{2, 3}  A_{2, 0}  A_{2, 1} ...   [phase 1] \ per phase = 2
A_{3, 2}  A_{3, 3}  A_{3, 0}  A_{3, 1} ...   [phase 1] /
</code></pre></li></ul><ul><li><ol start=3><li>MMA Layout</li></ol><p>顾名思义，MMA Layout 表示 Tensor Core 中 MMA 指令结果的 data layout，比如 Ampere 对应的 MMA Layout 的数据排布基本可以对应到 PTX 指令中的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-1684>mma.m16n8k16</a> 的 C,D 的排布。</p><p>MMA Layout 主要包含两个字段：</p><ul><li><code>version</code> ，表示 TensorCore 的版本<ul><li>1 为 Volta</li><li>2 为 Ampere</li></ul></li><li><code>warpsPerCTA</code></li></ul><p>这里演示 FP16 精度下， <code>version=2</code> 的数据排布（会映射到 <code>mma.m16n8k16</code> 指令）的 Accumulators (C or D) 的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-16816-float>数据排布</a>。</p><figure><img src=/static/mma.16816.png></figure></li></ul><ul><li><ol start=4><li>DotOperand Layout</li></ol><p>DotOperand Layout 用来表示 Triton 的 DotOp 的输入的 layout。</p><p>其主要包含如下信息</p><ol><li><code>opIdx</code> ， Operand 的 ID<ul><li><code>opIdx=0</code> 表示 DotOp 的 $a</li><li><code>opIdx=1</code> 表示 DotOp 的 $b</li></ul></li><li><code>parent</code> ，存储其对应的 MMA Layout，这里 DotOperand 的数据排布也可能间接的由 MMA Layout 确定（如果 DotOp lower 到 MMA 指令）或者 Blocked Layout（如果 DotOp lower 到 FMA 指令）</li></ol><p>这里为了方便演示，我们采用 MMA Layout 中的 <code>mma.m16n8k16.f16</code> 指令</p><ul><li><p>计算精度为 FP16</p></li><li><p>MMA Layout</p><ul><li><code>version=2</code></li><li><code>warpsPerCTA=[8,4]</code></li></ul></li><li><p>对于 $a，对应的 DotOperand 的 opIdx = 0</p></li><li><p>$b, 对应的 DotOperand 的 opIdx = 1</p><figure><img src=/static/mma.16816.op.png></figure></li></ul></li></ul><ul><li><ol start=5><li>Slice Layout</li></ol><p>Slice Layout 表明单个维度上的数据反向索引</p></li></ul><h4 id=convertlayoutop>ConvertLayoutOp</h4><p>顾名思义，ConvertLayoutOp 就是用来讲 Tensor 从一种 data layout 转换到另外一种 data layout。
由于 data layout 是 TensorType 的一部分，很自然会存在类型（其中layout）需要转换的情况，这就是 ConvertLayoutOp 的作用。</p><p>有了上面的 Data Layout，接下来我们看最简单的 MatMul 中的的 IR：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>4</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#mma</span> = <span>#triton_gpu</span>.<span>mma</span>&lt;{<span>version</span> = <span style=color:#40a070>2</span>, <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>//</span> ...
</span></span><span style=display:flex><span>%37 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>%38 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>%39 = <span>triton_gpu</span>.<span>convert_layout</span> %37 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>%40 = <span>triton_gpu</span>.<span>convert_layout</span> %38 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>%41 = <span>tt</span>.<span>dot</span> %39, %40, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span><span>//</span> ...
</span></span></code></pre></div><p>上面是截取了一段经典 MatMul 中某个阶段的 TritonGPU IR，逻辑比较直白，定义了 <code>#blocked0</code>, <code>#blocked1</code> 和 <code>#mma</code> 三种 layout，之后通过 <code>tt.load</code> 将 DotOp 的两个 Operand 从 GEMM 加载数据到 register files，之后两个 <code>triton_gpu.convert_layout</code> 转换 layout 为 DotOp 的参数需要的 <code>#triton_gpu.dot_op</code> layout。</p><p>这里列举一些典型的 data layout 的转换，以及特点：</p><ul><li><code>#shared -> #blocked</code> ，正常是代表数据从 shared memory 被 load 到 register file 中，需要考虑 swizzle</li><li><code>#blocked -> #shared</code> ，代表数据从 register file 存储到 shared memory 中，需要上一步相同的 swizzle 方式</li><li><code>#mma -> #blocked</code> ，正常是 DotOp 的输出转换为更简单的 layout 来进一步计算，由于涉及到跨 thread 间的数据传递，因此一般会借由 shared memory 中转一次</li><li><code>#blocked -> #dot_operand</code> ，转换为 DotOp 的输入，这一步可能也需要 shared memory 中转</li></ul><p>Triton 中几乎实现了任意 data layout 间的转换，当然不同的转换代价也不尽相同（考虑到是否会用到 shared memory，register 增减量等等），因此转换的代价也会在 Optimizer 里面一并考虑。</p><h3 id=tritonir-的优化>TritonIR 的优化</h3><p>TritonIR 上的优化主要是计算本身的，与硬件无关的优化，包含了如下 Pass</p><ul><li>Inliner Pass，将 Kernel Call 的子函数 Inline 展开</li><li>Combine Pass，一些特定的 Pattern rewrite，比如<ul><li><code>select(cond, load(ptrs, broadcast(cond), ???), other) => load(ptrs, broadcast(cond), other)</code></li></ul></li><li>Canonicalizer Pass，一些化简的 Pattern rewrite</li><li>CSE Pass，MLIR 的 <a href=https://mlir.llvm.org/docs/Passes/#-cse-eliminate-common-sub-expressions>cse</a> Pass，用于 Eliminate common sub-expressions</li><li>LICM Pass，MLIR 的 <a href=https://mlir.llvm.org/doxygen/LoopInvariantCodeMotion_8cpp_source.html>LoopInvariantCodeMotion Pass</a> ，将循环无关的变量挪到 forloop 外面</li></ul><h3 id=tritongpu-ir-的优化>TritonGPU IR 的优化</h3><p>TritonGPU IR 上的优化在计算本身优化外，新增了 GPU 硬件相关的优化，具体的 Pass 列表如下</p><ul><li>ConvertTritonToTritonGPU Pass，将 Triton IR 转换为 TritonGPU IR，主要是增加 TritonGPU 特有的 layout</li><li>Coalesce Pass，重排 order，使得最大 contiguity 的维度排在最前面</li><li>Combine Pass，同 Triton IR</li><li>Pipeline Pass，MMA 指令对应的 global memory 到 shared memory 的 N-Buffer 优化，下文详解</li><li>Prefetch Pass，MMA 指令对应的 shared memory 到 register file 的 N-Buffer 优化，下文详解</li><li>Canonicalizer，同 Triton IR</li><li>CSE Pass，同 Triton IR</li><li>LICM Pass，同 Triton IR</li></ul><h4 id=pipeline-pass>Pipeline Pass</h4><p>Pipeline Pass 和下一小节中的 Prefetch Pass 是配合关系，整体用来为 DotOp (mma 指令) 的 Operand 提供 IO 优化。</p><p>Pipeline 优化主要针对 DotOp 中 GEMM 到 SMEM 之间的数据拷贝，并自动做 Double Buffer 或者 N Buffer 的优化。</p><p>最简单的 Double buffer 的伪代码如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>A <span style=color:#666>=</span> alloc_tensor(shape<span style=color:#666>=</span>[<span style=color:#40a070>2</span><span style=color:#666>*</span><span style=color:#40a070>16</span>,<span style=color:#40a070>16</span>])
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># cp.async &amp; cp.async.commit_group</span>
</span></span><span style=display:flex><span>A <span style=color:#666>=</span> insert_slice_async(A, ptr0, <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>B <span style=color:#666>=</span> alloc_tensor(shape<span style=color:#666>=</span>[<span style=color:#40a070>2</span><span style=color:#666>*</span><span style=color:#40a070>16</span>,<span style=color:#40a070>8</span>])
</span></span><span style=display:flex><span>B <span style=color:#666>=</span> insert_slice_async(B, ptr1, <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A <span style=color:#666>=</span> insert_slice_async(A, ptr00, <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>B <span style=color:#666>=</span> insert_slice_async(B, ptr11, <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>async_wait(num<span style=color:#666>=</span><span style=color:#40a070>2</span>) <span style=color:#60a0b0;font-style:italic># cp.async.wait_group</span>
</span></span><span style=display:flex><span>A_slice0 <span style=color:#666>=</span> extract_slice(A, offset<span style=color:#666>=</span>(<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>), size<span style=color:#666>=</span>(<span style=color:#40a070>1</span>,<span style=color:#40a070>16</span>,<span style=color:#40a070>16</span>))
</span></span><span style=display:flex><span>B_slice0 <span style=color:#666>=</span> extract_slice(B, offset<span style=color:#666>=</span>(<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>), size<span style=color:#666>=</span>(<span style=color:#40a070>1</span>,<span style=color:#40a070>16</span>,<span style=color:#40a070>8</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#666>...</span>):
</span></span><span style=display:flex><span>    a <span style=color:#666>=</span> ldmatrix(A_slice0)
</span></span><span style=display:flex><span>    b <span style=color:#666>=</span> ldmatrix(B_slice0)
</span></span><span style=display:flex><span>    c <span style=color:#666>=</span> dot(a, b)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    offset <span style=color:#666>=</span> (i<span style=color:#666>+</span><span style=color:#40a070>1</span>) <span style=color:#666>%</span> <span style=color:#40a070>2</span>
</span></span><span style=display:flex><span>    A <span style=color:#666>=</span> insert_slice_async(A, ptr2, offset)
</span></span><span style=display:flex><span>    B <span style=color:#666>=</span> insert_slice_async(B, ptr3, offset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    async_wait(num<span style=color:#666>=</span><span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>    A_slice0 <span style=color:#666>=</span> extract_slice(A, offset<span style=color:#666>=</span>(offset,<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>), size<span style=color:#666>=</span>(<span style=color:#40a070>1</span>,<span style=color:#40a070>16</span>,<span style=color:#40a070>16</span>))
</span></span><span style=display:flex><span>    B_slice0 <span style=color:#666>=</span> extract_slice(B, offset<span style=color:#666>=</span>(offset,<span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>), size<span style=color:#666>=</span>(<span style=color:#40a070>1</span>,<span style=color:#40a070>16</span>,<span style=color:#40a070>8</span>))
</span></span></code></pre></div><p>其中，</p><ul><li><code>alloc_tensor</code> 大致对应到 <code>triton_gpu.alloc_tensor</code></li><li><code>insert_slice_async</code> 对应到 <code>triton_gpu.insert_slice_async</code> ， 表示异步地向 Tensor 中插入一个 slice，这个过程是通过 <code>cp.async</code> 指令实现的异步</li><li><code>tensor.extract_slice</code> 表示从 Tensor 中读取一个 slice</li><li><code>async_wait</code> 的语义对应到 <code>cp.async.wait_group</code> 指令</li></ul><h4 id=prefetch-pass>Prefetch Pass</h4><p>Prefetch 的逻辑跟 Pipeline Pass 基本类似，也是 Double buffer 和 N Buffer 的优化，区别是其承担了 SMEM 到 register file 的数据搬运，IR 的表示方式是 <code>triton_gpu.convert_layout %37 : (tensor&lt;16x16xf16, #blocked0>) -> tensor&lt;16x16xf16, #triton_gpu.dot_op&lt;{opIdx = 0, parent = #mma}>></code> ， 最终映射的核心指令是 <code>ldmatrix</code> 。</p><h2 id=高性能-llvm-生成之-backend>高性能 LLVM 生成之 Backend</h2><p>Triton 的 Backend 可以有微观和宏观两个角度</p><ul><li>微观上主要包括 <code>TritonGPU IR -> LLVM Dialect</code> 的过程，这里需要注意的是，<a href=https://mlir.llvm.org/docs/Dialects/LLVM/>LLVM Dialect</a> 是 MLIR 体系中的一个表示，其可以进一步自动 lower 到 LLVM IR</li><li>宏观上进一步包括了 LLVM Dialect -> LLVM IR -> PTX -> cubin 等过程</li></ul><p>这里我们只从微观角度介绍，因为宏观角度中，大部分流程可以通过 LLVM 社区或者 CUDA 的一些设施自动完成。</p><p>Triton 的 Backend 是比较经典的 MLIR 的 Lowering，主要内容就是将 TritonGPU IR 中包含的每种 Op 逐个的 OpConversion。 不过为了高性能，以及保证 Codegen 产物的可控，Triton 在 LLVM 中大量插入了 PTX 的内联汇编（下文会介绍）。 此外，大部分 Op 的 Lowering 都是比较规则化，下文会简要介绍 Dot 指令的 Lowering。</p><h3 id=ptx-inline-asm>PTX inline asm</h3><p>Triton 中使用 Inline asm 大致几个原因：</p><ul><li>一些指令对应的操作在现有的 <code>gpu</code> 和 <code>nvgpu</code> 的 dialect 还不太完善</li><li>性能原因，比如浮点类型间的变换，一小块汇编足以；借助一个很长的 workflow 还不太可控</li></ul><p>Triton 里面针对 Inline asm 的封装有个简单的 wrapper，类似最简单的 <code>cp.async.wait_group</code> 的调用</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>PTXBuilder ptxBuilder;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>asyncWaitOp <span style=color:#666>=</span> <span style=color:#666>*</span>ptxBuilder.create<span style=color:#666>&lt;&gt;</span>(<span style=color:#4070a0>&#34;cp.async.wait_group&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>auto</span> num <span style=color:#666>=</span> op<span style=color:#666>-&gt;</span>getAttrOfType<span style=color:#666>&lt;</span>IntegerAttr<span style=color:#666>&gt;</span>(<span style=color:#4070a0>&#34;num&#34;</span>).getInt();
</span></span><span style=display:flex><span>asyncWaitOp(ptxBuilder.newConstantOperand(num));
</span></span></code></pre></div><p>到稍微复杂点的 <code>ld</code> 的各种参数组合</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>ld <span style=color:#666>=</span> ptxBuilder.create<span style=color:#666>&lt;&gt;</span>(<span style=color:#4070a0>&#34;ld&#34;</span>)
</span></span><span style=display:flex><span>                     <span style=color:#666>-&gt;</span>o(<span style=color:#4070a0>&#34;volatile&#34;</span>, op.getIsVolatile())
</span></span><span style=display:flex><span>                     .global()
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;ca&#34;</span>, op.getCache() <span style=color:#666>==</span> triton<span style=color:#666>::</span>CacheModifier<span style=color:#666>::</span>CA)
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;cg&#34;</span>, op.getCache() <span style=color:#666>==</span> triton<span style=color:#666>::</span>CacheModifier<span style=color:#666>::</span>CG)
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;L1::evict_first&#34;</span>,
</span></span><span style=display:flex><span>                        op.getEvict() <span style=color:#666>==</span> triton<span style=color:#666>::</span>EvictionPolicy<span style=color:#666>::</span>EVICT_FIRST)
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;L1::evict_last&#34;</span>,
</span></span><span style=display:flex><span>                        op.getEvict() <span style=color:#666>==</span> triton<span style=color:#666>::</span>EvictionPolicy<span style=color:#666>::</span>EVICT_LAST)
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;L1::cache_hint&#34;</span>, hasL2EvictPolicy)
</span></span><span style=display:flex><span>                     .v(nWords)
</span></span><span style=display:flex><span>                     .b(width);
</span></span></code></pre></div><h3 id=mma-指令生成>MMA 指令生成</h3><p>相比于 ReduceOp 等需要跟 layout 结合的 Op 的 Lowering，DotOp 的是规则非常清晰的。</p><p>这里大致提下在 Backend，一个 Dot 的工作流涉及的阶段和 Op：</p><table><thead><tr><th></th><th>Stage</th><th>Op</th><th>Layout</th></tr></thead><tbody><tr><td>2</td><td>Load <code>$a</code>, <code>$b</code> 的 tile 到 SMEM</td><td><code>triton_gpu.insert_slice_async</code></td><td><code>#shared</code></td></tr><tr><td>3</td><td>从 SMEM Load 参数到 Register file</td><td><code>tensor.extract_slice</code></td><td><code>#dot_op</code></td></tr><tr><td>4</td><td>执行 MMA，结果会在 Registter file</td><td><code>tt.dot</code></td><td><code>#mma</code></td></tr></tbody></table><p>所以直接跟 MMA 指令相关的其实只在第 4 步，其需要的 \(a\), \(b\) 两个参数已经通过 <code>tensor.extract_slice</code> 拷贝到了 Register file，直接满足了 Ampere 上的 <code>mma</code> 指令的需求。</p><p>在 Ampere 架构上，一个 DotOp 会映射到多个 mma 指令，下面我们以 FP16 的 <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#warp-level-matrix-fragment-mma-16816-float>mma.m16n8k16</a> 指令为例，具体的任务设置如下</p><ul><li>Dot 计算的 tile 的尺寸是 M=32, N=16, K=16<ul><li>对应着 <code>mma.m16n8k16</code> 指令的尺寸是 <code>M=16, N=8, K=16</code> ，因此一个 tile 需要在 m, n, k 方向展开 <code>2x2x1</code> 总共 4 个 <code>mma.m16n8k16</code> 指令</li></ul></li></ul><p>最终会有类似如下的代码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> (<span style=color:#902000>unsigned</span> k <span style=color:#666>=</span> <span style=color:#40a070>0</span>; k <span style=color:#666>&lt;</span> numK; <span style=color:#666>++</span>k)
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>for</span> (<span style=color:#902000>unsigned</span> m <span style=color:#666>=</span> <span style=color:#40a070>0</span>; m <span style=color:#666>&lt;</span> numM; <span style=color:#666>++</span>m)
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>for</span> (<span style=color:#902000>unsigned</span> n <span style=color:#666>=</span> <span style=color:#40a070>0</span>; n <span style=color:#666>&lt;</span> numN; <span style=color:#666>++</span>n) {
</span></span><span style=display:flex><span>          callMMA(m, n, k);
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>其中，numM, numN, numK 就对应着上面的 2, 2, 1。</p><p>callMMA 的代码如上文时候 InlineAsm，类似如下代码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span> <span style=color:#007020;font-weight:700>auto</span> mma <span style=color:#666>=</span> builder.create(<span style=color:#4070a0>&#34;mma.sync.aligned.m8n8k4&#34;</span>)
</span></span><span style=display:flex><span>                     <span style=color:#666>-&gt;</span>o(isARow <span style=color:#666>?</span> <span style=color:#4070a0>&#34;row&#34;</span> <span style=color:#666>:</span> <span style=color:#4070a0>&#34;col&#34;</span>)
</span></span><span style=display:flex><span>                     .o(isBRow <span style=color:#666>?</span> <span style=color:#4070a0>&#34;row&#34;</span> <span style=color:#666>:</span> <span style=color:#4070a0>&#34;col&#34;</span>)
</span></span><span style=display:flex><span>                     .o(<span style=color:#4070a0>&#34;f32.f16.f16.f32&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      mma(resOprs, AOprs, BOprs, COprs);
</span></span></code></pre></div><h2 id=fyi>FYI</h2><ul><li><a href=https://github.com/openai/triton/tree/ca05ef8e5b0b4d4834957bc31e7581b09d35c530>Triton MLIR migration code</a></li><li>Triton paper: <a href=https://www.eecs.harvard.edu/~htk/publication/2019-mapl-tillet-kung-cox.pdf>Triton: An Intermediate Language and Compiler forTiled Neural Network Computations</a></li></ul><h3 id=gemm-在-optimizer-pass-效果>GEMM 在 Optimizer Pass 效果</h3><p>下面列举了经典的 GEMM 在 Triton 的 Compile pipeline 里面的 IR 的变换。</p><h4 id=python-code>Python code</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>matmul_kernel</span>(
</span></span><span style=display:flex><span>    a_ptr, b_ptr, c_ptr,
</span></span><span style=display:flex><span>    stride_am, stride_ak,
</span></span><span style=display:flex><span>    stride_bk, stride_bn,
</span></span><span style=display:flex><span>    stride_cm, stride_cn,
</span></span><span style=display:flex><span>    M: tl<span style=color:#666>.</span>constexpr, N: tl<span style=color:#666>.</span>constexpr, K: tl<span style=color:#666>.</span>constexpr,
</span></span><span style=display:flex><span>    BLOCK_SIZE_M: tl<span style=color:#666>.</span>constexpr, BLOCK_SIZE_N: tl<span style=color:#666>.</span>constexpr,
</span></span><span style=display:flex><span>    BLOCK_SIZE_K: tl<span style=color:#666>.</span>constexpr,
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    offs_m <span style=color:#666>=</span> tl<span style=color:#666>.</span>arange(<span style=color:#40a070>0</span>, BLOCK_SIZE_M)
</span></span><span style=display:flex><span>    offs_n <span style=color:#666>=</span> tl<span style=color:#666>.</span>arange(<span style=color:#40a070>0</span>, BLOCK_SIZE_N)
</span></span><span style=display:flex><span>    offs_k <span style=color:#666>=</span> tl<span style=color:#666>.</span>arange(<span style=color:#40a070>0</span>, BLOCK_SIZE_K)
</span></span><span style=display:flex><span>    a_ptrs <span style=color:#666>=</span> a_ptr <span style=color:#666>+</span> offs_m[:, <span style=color:#007020;font-weight:700>None</span>] <span style=color:#666>*</span> stride_am <span style=color:#666>+</span> offs_k[<span style=color:#007020;font-weight:700>None</span>, :] <span style=color:#666>*</span> stride_ak
</span></span><span style=display:flex><span>    b_ptrs <span style=color:#666>=</span> b_ptr <span style=color:#666>+</span> offs_k[:, <span style=color:#007020;font-weight:700>None</span>] <span style=color:#666>*</span> stride_bk <span style=color:#666>+</span> offs_n[<span style=color:#007020;font-weight:700>None</span>, :] <span style=color:#666>*</span> stride_bn
</span></span><span style=display:flex><span>    accumulator <span style=color:#666>=</span> tl<span style=color:#666>.</span>zeros((BLOCK_SIZE_M, BLOCK_SIZE_N), dtype<span style=color:#666>=</span>tl<span style=color:#666>.</span>float32)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> k <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, K, BLOCK_SIZE_K):
</span></span><span style=display:flex><span>        a <span style=color:#666>=</span> tl<span style=color:#666>.</span>load(a_ptrs)
</span></span><span style=display:flex><span>        b <span style=color:#666>=</span> tl<span style=color:#666>.</span>load(b_ptrs)
</span></span><span style=display:flex><span>        accumulator <span style=color:#666>+=</span> tl<span style=color:#666>.</span>dot(a, b)
</span></span><span style=display:flex><span>        a_ptrs <span style=color:#666>+=</span> BLOCK_SIZE_K <span style=color:#666>*</span> stride_ak
</span></span><span style=display:flex><span>        b_ptrs <span style=color:#666>+=</span> BLOCK_SIZE_K <span style=color:#666>*</span> stride_bk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    c_ptrs <span style=color:#666>=</span> c_ptr <span style=color:#666>+</span> offs_m[:, <span style=color:#007020;font-weight:700>None</span>] <span style=color:#666>*</span> stride_cm <span style=color:#666>+</span> offs_n[<span style=color:#007020;font-weight:700>None</span>, :] <span style=color:#666>*</span> stride_cn
</span></span><span style=display:flex><span>    tl<span style=color:#666>.</span>store(c_ptrs, accumulator)
</span></span></code></pre></div><h4 id=triton-ir-translated-from-python-ast--and-after-inliner-ces-dot-dot-dot-passes>Triton IR translated from Python AST(and after Inliner, CES &mldr; passes)</h4><p>这一步算是 Python code 直接翻译到了 Triton IR.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>0.000000e+00</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c64</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst_0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>16</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %0 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %1 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %2 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %3 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %4 = <span>arith</span>.<span>muli</span> %2, %3 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %5 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %6 = <span>tt</span>.<span>addptr</span> %5, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %7 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %8 = <span>tt</span>.<span>broadcast</span> %6 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %9 = <span>tt</span>.<span>broadcast</span> %7 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %10 = <span>tt</span>.<span>addptr</span> %8, %9 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %11 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg4</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %12 = <span>arith</span>.<span>muli</span> %2, %11 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %13 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %14 = <span>tt</span>.<span>addptr</span> %13, %12 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %15 = <span>tt</span>.<span>expand_dims</span> %1 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %16 = <span>tt</span>.<span>broadcast</span> %14 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %17 = <span>tt</span>.<span>broadcast</span> %15 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %18 = <span>tt</span>.<span>addptr</span> %16, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %19<span>:</span><span style=color:#40a070>3</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %10, <span style=color:#bb60d5>%arg9</span> = %18) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      %26 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex><span>      %27 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %28 = <span>tt</span>.<span>dot</span> %26, %27, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>      %29 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      %30 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %31 = <span>tt</span>.<span>splat</span> %30 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>      %32 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %31 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %28, %29, %32 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    %20 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg5</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %21 = <span>arith</span>.<span>muli</span> %2, %20 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %22 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %23 = <span>tt</span>.<span>addptr</span> %22, %21 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %24 = <span>tt</span>.<span>broadcast</span> %23 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %25 = <span>tt</span>.<span>addptr</span> %24, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %25, %19#0 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-before-loopinvariantcodemotion>IR Before LoopInvariantCodeMotion</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>0.000000e+00</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c64</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst_0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>16</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %0 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %1 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %2 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %3 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %4 = <span>arith</span>.<span>muli</span> %2, %3 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %5 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %6 = <span>tt</span>.<span>addptr</span> %5, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %7 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %8 = <span>tt</span>.<span>broadcast</span> %6 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %9 = <span>tt</span>.<span>broadcast</span> %7 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %10 = <span>tt</span>.<span>addptr</span> %8, %9 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %11 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg4</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %12 = <span>arith</span>.<span>muli</span> %2, %11 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %13 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %14 = <span>tt</span>.<span>addptr</span> %13, %12 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %15 = <span>tt</span>.<span>expand_dims</span> %1 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %16 = <span>tt</span>.<span>broadcast</span> %14 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %17 = <span>tt</span>.<span>broadcast</span> %15 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %18 = <span>tt</span>.<span>addptr</span> %16, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %19<span>:</span><span style=color:#40a070>3</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %10, <span style=color:#bb60d5>%arg9</span> = %18) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      %26 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex><span>      %27 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex><span>      %28 = <span>tt</span>.<span>dot</span> %26, %27, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>      %29 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %30 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %31 = <span>tt</span>.<span>splat</span> %30 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>      %32 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %31 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %28, %29, %32 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    %20 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg5</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %21 = <span>arith</span>.<span>muli</span> %2, %20 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %22 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %23 = <span>tt</span>.<span>addptr</span> %22, %21 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %24 = <span>tt</span>.<span>broadcast</span> %23 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %25 = <span>tt</span>.<span>addptr</span> %24, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %25, %19#0 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>可以看到</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span>      %30 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %31 = <span>tt</span>.<span>splat</span> %30 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span></code></pre></div><p>这段计算的输入分别是 function argument 和 constant，不依赖 forloop 内的变量，理论上可以挪出去。</p><h4 id=ir-after-loopinvariantcodemotion>IR After LoopInvariantCodeMotion</h4><p>LoopInvariantCodeMotion 是 MLIR 社区的一个 Pass，用于将无关 variable 计算挪到 forloop 外面，可以看到上小节里面的计算已经挪出去了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>0.000000e+00</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c64</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst_0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>16</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %0 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %1 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %2 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %3 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %4 = <span>arith</span>.<span>muli</span> %2, %3 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %5 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %6 = <span>tt</span>.<span>addptr</span> %5, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %7 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %8 = <span>tt</span>.<span>broadcast</span> %6 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %9 = <span>tt</span>.<span>broadcast</span> %7 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %10 = <span>tt</span>.<span>addptr</span> %8, %9 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %11 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg4</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %12 = <span>arith</span>.<span>muli</span> %2, %11 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %13 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %14 = <span>tt</span>.<span>addptr</span> %13, %12 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %15 = <span>tt</span>.<span>expand_dims</span> %1 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %16 = <span>tt</span>.<span>broadcast</span> %14 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %17 = <span>tt</span>.<span>broadcast</span> %15 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %18 = <span>tt</span>.<span>addptr</span> %16, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    %19 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %20 = <span>tt</span>.<span>splat</span> %19 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %21<span>:</span><span style=color:#40a070>3</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %10, <span style=color:#bb60d5>%arg9</span> = %18) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;) {
</span></span><span style=display:flex><span>      %28 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex><span>      %29 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt;
</span></span><span style=display:flex><span>      %30 = <span>tt</span>.<span>dot</span> %28, %29, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>      %31 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      %32 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %20 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %30, %31, %32 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    %22 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg5</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %23 = <span>arith</span>.<span>muli</span> %2, %22 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>&gt;
</span></span><span style=display:flex><span>    %24 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %25 = <span>tt</span>.<span>addptr</span> %24, %23 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %26 = <span>tt</span>.<span>broadcast</span> %25 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    %27 = <span>tt</span>.<span>addptr</span> %26, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;&gt;
</span></span><span style=display:flex><span>    <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %27, %21#0 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>&gt;
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-after-converttritontotritongpu>IR After ConvertTritonToTritonGPU</h4><p>这一步是在原有的硬件无关的 Triton IR 基础上加入了 GPU 相关的 data layout 和 operation.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>2</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>1</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>3</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>4</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#blocked</span><span style=color:#40a070>5</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>0.000000e+00</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>|\colorbo</span><span style=color:#007020;font-weight:700>x</span>{<span>yellow</span>}{<span>\strut</span> <span>#blocked</span><span style=color:#40a070>4</span>}<span>|</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c64</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst_0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>16</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %0 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %1 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %2 = <span>triton_gpu</span>.<span>convert_layout</span> %0 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>2</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %3 = <span>tt</span>.<span>expand_dims</span> %2 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>2</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %4 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %5 = <span>arith</span>.<span>muli</span> %3, %4 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %6 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %7 = <span>tt</span>.<span>addptr</span> %6, %5 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %8 = <span>triton_gpu</span>.<span>convert_layout</span> %0 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>3</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %9 = <span>tt</span>.<span>expand_dims</span> %8 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>3</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>3</span>&gt;
</span></span><span style=display:flex><span>    %10 = <span>tt</span>.<span>broadcast</span> %7 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %11 = <span>triton_gpu</span>.<span>convert_layout</span> %10 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %12 = <span>tt</span>.<span>broadcast</span> %9 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>3</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>3</span>&gt;
</span></span><span style=display:flex><span>    %13 = <span>triton_gpu</span>.<span>convert_layout</span> %12 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>3</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %14 = <span>tt</span>.<span>addptr</span> %11, %13 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %15 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg4</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %16 = <span>arith</span>.<span>muli</span> %3, %15 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %17 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %18 = <span>tt</span>.<span>addptr</span> %17, %16 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %19 = <span>triton_gpu</span>.<span>convert_layout</span> %1 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>5</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %20 = <span>tt</span>.<span>expand_dims</span> %19 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>5</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>5</span>&gt;
</span></span><span style=display:flex><span>    %21 = <span>tt</span>.<span>broadcast</span> %18 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %22 = <span>triton_gpu</span>.<span>convert_layout</span> %21 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %23 = <span>tt</span>.<span>broadcast</span> %20 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>5</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>5</span>&gt;
</span></span><span style=display:flex><span>    %24 = <span>triton_gpu</span>.<span>convert_layout</span> %23 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>5</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %25 = <span>tt</span>.<span>addptr</span> %22, %24 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %26 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %27 = <span>tt</span>.<span>splat</span> %26 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %28<span>:</span><span style=color:#40a070>3</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %14, <span style=color:#bb60d5>%arg9</span> = %25) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;) {
</span></span><span style=display:flex><span>      %36 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>      %37 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %38 = <span>triton_gpu</span>.<span>convert_layout</span> %36 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>4</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %39 = <span>triton_gpu</span>.<span>convert_layout</span> %37 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>4</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %40 = <span>tt</span>.<span>dot</span> %38, %39, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>4</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>4</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>      %41 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>      %42 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %27 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %40, %41, %42 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    %29 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg5</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %30 = <span>arith</span>.<span>muli</span> %3, %29 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %31 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %32 = <span>tt</span>.<span>addptr</span> %31, %30 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %33 = <span>tt</span>.<span>broadcast</span> %32 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;
</span></span><span style=display:flex><span>    %34 = <span>triton_gpu</span>.<span>convert_layout</span> %33 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>2</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    %35 = <span>tt</span>.<span>addptr</span> %34, %24 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %35, %28#0 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>4</span>&gt;
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>这里比较明显的是</p><ol><li>作为 dotOp 的输出， <code>%40</code> 应该是 mma layout，但这一步还是 blocked layout，这个会在下一节里面改写</li><li><code>%38</code>, <code>%39</code> 这些的 layout 应该是 <code>dot_op&lt;mma></code> 但由于 mma layout 还没有给定，所以还是 <code>dot_op&lt;blocked></code></li></ol><h4 id=ir-after-tritongpucombineops>IR After TritonGPUCombineOps</h4><p>这一步会包含很多 Op pattern 的改写，直接的变化是</p><ul><li>给 dot 相关的增加了 mma 的 data layout</li><li>插入了 mma layout 相关的 <code>convert_layout</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>4</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span><span>#mma</span> = <span>#triton_gpu</span>.<span>mma</span>&lt;{<span>version</span> = <span style=color:#40a070>2</span>, <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c64</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c16_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>0.000000e+00</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%cst_0</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span>dense</span>&lt;<span style=color:#40a070>16</span>&gt; <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %0 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>0</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %1 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %2 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %3 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg3</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %4 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg0</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %5 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>0</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %6 = <span>tt</span>.<span>expand_dims</span> %0 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>0</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %7 = <span>arith</span>.<span>muli</span> %6, %3 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %8 = <span>tt</span>.<span>addptr</span> %4, %7 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %9 = <span>tt</span>.<span>broadcast</span> %8 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %10 = <span>tt</span>.<span>expand_dims</span> %5 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>0</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %11 = <span>tt</span>.<span>broadcast</span> %10 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %12 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg4</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %13 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg1</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %14 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %15 = <span>tt</span>.<span>make_range</span> {<span style=color:#007020;font-weight:700>end</span> = <span style=color:#40a070>8</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>start</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %16 = <span>tt</span>.<span>expand_dims</span> %1 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %17 = <span>arith</span>.<span>muli</span> %16, %12 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %18 = <span>tt</span>.<span>addptr</span> %13, %17 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %19 = <span>tt</span>.<span>broadcast</span> %18 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %20 = <span>tt</span>.<span>expand_dims</span> %14 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %21 = <span>tt</span>.<span>broadcast</span> %20 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %22 = <span>tt</span>.<span>expand_dims</span> %15 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %23 = <span>tt</span>.<span>broadcast</span> %22 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>1</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %24 = <span>arith</span>.<span>muli</span> <span style=color:#bb60d5>%arg4</span>, <span style=color:#bb60d5>%c16_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %25 = <span>tt</span>.<span>splat</span> %24 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %26 = <span>tt</span>.<span>addptr</span> %9, %11 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %27 = <span>tt</span>.<span>addptr</span> %19, %21 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %28<span>:</span><span style=color:#40a070>3</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %26, <span style=color:#bb60d5>%arg9</span> = %27) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) {
</span></span><span style=display:flex><span>      %37 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg8</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %38 = <span>tt</span>.<span style=color:#007020;font-weight:700>load</span> <span style=color:#bb60d5>%arg9</span> {<span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %39 = <span>triton_gpu</span>.<span>convert_layout</span> %37 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      %40 = <span>triton_gpu</span>.<span>convert_layout</span> %38 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %41 = <span>tt</span>.<span>dot</span> %39, %40, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %42 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %43 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %41, %42, %43 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    %29 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg5</span> <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %30 = <span>tt</span>.<span>splat</span> <span style=color:#bb60d5>%arg2</span> <span>:</span> (<span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %31 = <span>tt</span>.<span>expand_dims</span> %2 {<span>axis</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#triton_gpu</span>.<span>slice</span>&lt;{<span>dim</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#blocked</span><span style=color:#40a070>1</span>}&gt;&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %32 = <span>arith</span>.<span>muli</span> %31, %29 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span>x</span><span style=color:#007020;font-weight:700>i32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %33 = <span>tt</span>.<span>addptr</span> %30, %32 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %34 = <span>tt</span>.<span>broadcast</span> %33 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>1</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %35 = <span>tt</span>.<span>addptr</span> %34, %23 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %36 = <span>triton_gpu</span>.<span>convert_layout</span> %28#0 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span>tt</span>.<span style=color:#007020;font-weight:700>store</span> %35, %36 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h4 id=ir-after-tritongpupipeline>IR After TritonGPUPipeline</h4><p>这一步可以认为是在 global memory -> shared memory 的数据搬运做 Pipeline 优化。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>4</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#mma</span> = <span>#triton_gpu</span>.<span>mma</span>&lt;{<span>version</span> = <span style=color:#40a070>2</span>, <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>4</span>, <span>maxPhase</span> = <span style=color:#40a070>2</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>8</span>, <span>maxPhase</span> = <span style=color:#40a070>1</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    %28 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, <span style=color:#bb60d5>%c0</span>, <span style=color:#bb60d5>%c64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    %29 = <span style=color:#002070;font-weight:700>triton_gpu.alloc_tensor :</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %30 = <span>tt</span>.<span>splat</span> %28 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %31 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %26, %29, <span style=color:#bb60d5>%c0_i32</span>, %30 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %32 = <span style=color:#002070;font-weight:700>triton_gpu.alloc_tensor :</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %33 = <span>tt</span>.<span>splat</span> %28 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %34 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %27, %32, <span style=color:#bb60d5>%c0_i32</span>, %33 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %35 = <span>tt</span>.<span>addptr</span> %26, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %36 = <span>tt</span>.<span>addptr</span> %27, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    %40 = <span>tt</span>.<span>splat</span> %39 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %41 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %35, %31, %37, %40 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %42 = <span>tt</span>.<span>splat</span> %39 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %43 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %36, %34, %37, %42 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %44 = <span>tt</span>.<span>addptr</span> %35, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %45 = <span>tt</span>.<span>addptr</span> %36, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c1_i32_1</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %46 = <span>arith</span>.<span>addi</span> %37, <span style=color:#bb60d5>%c1_i32_1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex;background-color:#d8d8d8><span>    <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0_i32_2</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %47 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %41[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %48 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %43[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c1_i32_3</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %49 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%c0_i32_2</span>, <span style=color:#bb60d5>%c1_i32_3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %50<span>:</span><span style=color:#40a070>12</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %26, <span style=color:#bb60d5>%arg9</span> = %27, <span style=color:#bb60d5>%arg10</span> = %41, <span style=color:#bb60d5>%arg11</span> = %43, <span style=color:#bb60d5>%arg12</span> = %47, <span style=color:#bb60d5>%arg13</span> = %48, <span style=color:#bb60d5>%arg14</span> = %45, <span style=color:#bb60d5>%arg15</span> = %44, <span style=color:#bb60d5>%arg16</span> = %38, <span style=color:#bb60d5>%arg17</span> = %46, <span style=color:#bb60d5>%arg18</span> = %49) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>      %59 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg12</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      %60 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg13</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %61 = <span>tt</span>.<span>dot</span> %59, %60, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span>      %62 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %63 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %64 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg16</span>, <span style=color:#bb60d5>%c16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %65 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, %64, <span style=color:#bb60d5>%c64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %66 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c3_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32_4</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %67 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c3_i32_4</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %68 = <span>arith</span>.<span>index_cast</span> %67 <span>:</span> <span style=color:#007020;font-weight:700>i32</span> <span style=color:#007020;font-weight:700>to</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %69 = <span>tt</span>.<span>splat</span> %65 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %70 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%arg10</span>, %66, %69 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %71 = <span>tt</span>.<span>splat</span> %65 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %72 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg14</span>, <span style=color:#bb60d5>%arg11</span>, %66, %71 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %73 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %74 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg14</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %75 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %70[%68, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %76 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %72[%68, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_5</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %77 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c1_i32_5</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_6</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %78 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c1_i32_6</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %61, %62, %63, %70, %72, %75, %76, %74, %73, %64, %77, %78 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-before-tritongpuprefetch>IR Before TritonGPUPrefetch</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>4</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#mma</span> = <span>#triton_gpu</span>.<span>mma</span>&lt;{<span>version</span> = <span style=color:#40a070>2</span>, <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>4</span>, <span>maxPhase</span> = <span style=color:#40a070>2</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>8</span>, <span>maxPhase</span> = <span style=color:#40a070>1</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt;, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    %28 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, <span style=color:#bb60d5>%c0</span>, <span style=color:#bb60d5>%c64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>    %29 = <span style=color:#002070;font-weight:700>triton_gpu.alloc_tensor :</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %30 = <span>tt</span>.<span>splat</span> %28 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %31 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %26, %29, <span style=color:#bb60d5>%c0_i32</span>, %30 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %32 = <span style=color:#002070;font-weight:700>triton_gpu.alloc_tensor :</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %33 = <span>tt</span>.<span>splat</span> %28 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %34 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %27, %32, <span style=color:#bb60d5>%c0_i32</span>, %33 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %35 = <span>tt</span>.<span>addptr</span> %26, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %36 = <span>tt</span>.<span>addptr</span> %27, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    %40 = <span>tt</span>.<span>splat</span> %39 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %41 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %35, %31, %37, %40 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %42 = <span>tt</span>.<span>splat</span> %39 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %43 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> %36, %34, %37, %42 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    %44 = <span>tt</span>.<span>addptr</span> %35, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %45 = <span>tt</span>.<span>addptr</span> %36, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c1_i32_1</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %46 = <span>arith</span>.<span>addi</span> %37, <span style=color:#bb60d5>%c1_i32_1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0_i32_2</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %47 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %41[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %48 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %43[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c1_i32_3</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %49 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%c0_i32_2</span>, <span style=color:#bb60d5>%c1_i32_3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %50<span>:</span><span style=color:#40a070>12</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %26, <span style=color:#bb60d5>%arg9</span> = %27, <span style=color:#bb60d5>%arg10</span> = %41, <span style=color:#bb60d5>%arg11</span> = %43, <span style=color:#bb60d5>%arg12</span> = %47, <span style=color:#bb60d5>%arg13</span> = %48, <span style=color:#bb60d5>%arg14</span> = %45, <span style=color:#bb60d5>%arg15</span> = %44, <span style=color:#bb60d5>%arg16</span> = %38, <span style=color:#bb60d5>%arg17</span> = %46, <span style=color:#bb60d5>%arg18</span> = %49) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %59 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg12</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %60 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg13</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      %61 = <span>tt</span>.<span>dot</span> %59, %60, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span>      %62 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %63 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %64 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg16</span>, <span style=color:#bb60d5>%c16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %65 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, %64, <span style=color:#bb60d5>%c64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %66 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c3_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32_4</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %67 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c3_i32_4</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %68 = <span>arith</span>.<span>index_cast</span> %67 <span>:</span> <span style=color:#007020;font-weight:700>i32</span> <span style=color:#007020;font-weight:700>to</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %69 = <span>tt</span>.<span>splat</span> %65 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %70 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%arg10</span>, %66, %69 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %71 = <span>tt</span>.<span>splat</span> %65 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %72 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg14</span>, <span style=color:#bb60d5>%arg11</span>, %66, %71 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %73 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %74 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg14</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex><span>      %75 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %70[%68, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %76 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %72[%68, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_5</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %77 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c1_i32_5</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_6</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %78 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c1_i32_6</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %61, %62, %63, %70, %72, %75, %76, %74, %73, %64, %77, %78 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-after-tritongpuprefetch>IR After TritonGPUPrefetch</h4><p>这一步可以认为是在 Dot 相关的 shared memory -> registers 的数据搬运阶段做 Pipepline 优化。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>8</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>16</span>, <span style=color:#40a070>2</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#blocked</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>blocked</span>&lt;{<span>sizePerThread</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>threadsPerWarp</span> = [<span style=color:#40a070>4</span>, <span style=color:#40a070>8</span>], <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>], <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#mma</span> = <span>#triton_gpu</span>.<span>mma</span>&lt;{<span>version</span> = <span style=color:#40a070>2</span>, <span>warpsPerCTA</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>0</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>4</span>, <span>maxPhase</span> = <span style=color:#40a070>2</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span>#shared</span><span style=color:#40a070>1</span> = <span>#triton_gpu</span>.<span>shared</span>&lt;{<span>ve</span><span style=color:#007020;font-weight:700>c</span> = <span style=color:#40a070>8</span>, <span>perPhase</span> = <span style=color:#40a070>8</span>, <span>maxPhase</span> = <span style=color:#40a070>1</span>, <span>order</span> = [<span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>]}&gt;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>fun</span><span style=color:#007020;font-weight:700>c</span> <span>publi</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c56c78c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span>) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c0_i32_2</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %47 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %41[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>    %48 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %43[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>%c1_i32_3</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %49 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%c0_i32_2</span>, <span style=color:#bb60d5>%c1_i32_3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %50 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %47[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %51 = <span>triton_gpu</span>.<span>convert_layout</span> %50 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %52 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %48[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %53 = <span>triton_gpu</span>.<span>convert_layout</span> %52 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    %54<span>:</span><span style=color:#40a070>14</span> = <span>scf</span>.<span>f</span><span style=color:#007020;font-weight:700>or</span> <span style=color:#bb60d5>%arg6</span> = <span style=color:#bb60d5>%c0</span> <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>%c64</span> <span>step</span> <span style=color:#bb60d5>%c16</span> <span>iter_args</span>(<span style=color:#bb60d5>%arg7</span> = <span style=color:#bb60d5>%cst</span>, <span style=color:#bb60d5>%arg8</span> = %26, <span style=color:#bb60d5>%arg9</span> = %27, <span style=color:#bb60d5>%arg10</span> = %41, <span style=color:#bb60d5>%arg11</span> = %43, <span style=color:#bb60d5>%arg12</span> = %47, <span style=color:#bb60d5>%arg13</span> = %48, <span style=color:#bb60d5>%arg14</span> = %45, <span style=color:#bb60d5>%arg15</span> = %44, <span style=color:#bb60d5>%arg16</span> = %38, <span style=color:#bb60d5>%arg17</span> = %46, <span style=color:#bb60d5>%arg18</span> = %49, <span style=color:#bb60d5>%arg19</span> = %51, <span style=color:#bb60d5>%arg20</span> = %53) <span>-</span>&gt; (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;) {
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %63 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg12</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %64 = <span>triton_gpu</span>.<span>convert_layout</span> <span style=color:#bb60d5>%arg13</span> <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      %65 = <span>tt</span>.<span>dot</span> %63, %64, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span>      %66 = <span>tt</span>.<span>dot</span> <span style=color:#bb60d5>%arg19</span>, <span style=color:#bb60d5>%arg20</span>, <span style=color:#bb60d5>%arg7</span> {<span>allowTF</span><span style=color:#40a070>32</span> = <span style=color:#007020;font-weight:700>true</span>, <span>transA</span> = <span style=color:#007020;font-weight:700>false</span>, <span>transB</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; * <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;
</span></span><span style=display:flex><span>      %67 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg8</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %68 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg9</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %69 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg16</span>, <span style=color:#bb60d5>%c16</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %70 = <span>arith</span>.<span>cmpi</span> <span style=color:#007020;font-weight:700>slt</span>, %69, <span style=color:#bb60d5>%c64</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %71 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c3_i32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c3_i32_4</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %72 = <span>arith</span>.<span>remsi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c3_i32_4</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %73 = <span>arith</span>.<span>index_cast</span> %72 <span>:</span> <span style=color:#007020;font-weight:700>i32</span> <span style=color:#007020;font-weight:700>to</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>
</span></span><span style=display:flex><span>      %74 = <span>tt</span>.<span>splat</span> %70 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %75 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%arg10</span>, %71, %74 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %76 = <span>tt</span>.<span>splat</span> %70 <span>:</span> (<span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>x</span><span style=color:#007020;font-weight:700>i1</span>, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %77 = <span>triton_gpu</span>.<span>insert_slice_asyn</span><span style=color:#007020;font-weight:700>c</span> <span style=color:#bb60d5>%arg14</span>, <span style=color:#bb60d5>%arg11</span>, %71, %76 {<span>axis</span> = <span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>cache</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>evict</span> = <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>isVolatile</span> = <span style=color:#007020;font-weight:700>false</span>} <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt; <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      %78 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg15</span>, <span style=color:#bb60d5>%cst_0</span> <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %79 = <span>tt</span>.<span>addptr</span> <span style=color:#bb60d5>%arg14</span>, %25 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span>triton_gpu</span>.<span>async_wait</span> {<span>num</span> = <span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}
</span></span><span style=display:flex><span>      %80 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %75[%73, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex><span>      %81 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %77[%73, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_5</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %82 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg17</span>, <span style=color:#bb60d5>%c1_i32_5</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>%c1_i32_6</span> = <span>arith</span>.<span style=color:#007020;font-weight:700>constant</span> <span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %83 = <span>arith</span>.<span>addi</span> <span style=color:#bb60d5>%arg18</span>, <span style=color:#bb60d5>%c1_i32_6</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      %84 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %80[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>16</span>, <span style=color:#40a070>16</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %85 = <span>triton_gpu</span>.<span>convert_layout</span> %84 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      %86 = <span>tens</span><span style=color:#007020;font-weight:700>or</span>.<span>extract_slice</span> %81[<span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>] [<span style=color:#40a070>16</span>, <span style=color:#40a070>8</span>] [<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>] <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;
</span></span><span style=display:flex;background-color:#d8d8d8><span>      %87 = <span>triton_gpu</span>.<span>convert_layout</span> %86 <span>:</span> (<span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;) <span>-</span>&gt; <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>      <span>scf</span>.<span>yield</span> %65, %67, %68, %75, %77, %80, %81, %79, %78, %69, %82, %83, %85, %87 <span>:</span> <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>32</span>, <span>#mma</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>3</span><span>x</span><span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>0</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#shared</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>1</span>&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span style=color:#007020;font-weight:700>x</span><span style=color:#bb60d5>!tt.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>&gt;, <span>#blocked</span><span style=color:#40a070>0</span>&gt;, <span>inde</span><span style=color:#007020;font-weight:700>x</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>16</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>0</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;, <span>tens</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>16</span><span>x</span><span style=color:#40a070>8</span><span>xf</span><span style=color:#40a070>16</span>, <span>#triton_gpu</span>.<span>dot_op</span>&lt;{<span>opId</span><span style=color:#007020;font-weight:700>x</span> = <span style=color:#40a070>1</span>, <span>parent</span> = <span>#mma</span>}&gt;&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ir-after-tritongputollvm>IR After TritonGPUToLLVM</h4><p>MLIR 阶段的最后一步就是 translate 到 LLVM dialect，可以看到其中 Triton backend 插入的 Inline Asm。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#007020;font-weight:700>module</span> <span style=color:#007020;font-weight:700>attributes</span> {<span style=color:#4070a0>&#34;triton_gpu.num-warps&#34;</span> = <span style=color:#40a070>4</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>triton_gpu</span>.<span>shared</span> = <span style=color:#40a070>36864</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} {
</span></span><span style=display:flex><span>  <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>global</span> <span style=color:#007020;font-weight:700>external</span> @global_smem() {<span>addr_space</span> = <span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>} <span>:</span> <span style=color:#bb60d5>!llvm.array</span>&lt;<span style=color:#40a070>0</span> <span style=color:#007020;font-weight:700>x</span> <span style=color:#007020;font-weight:700>i8</span>&gt;
</span></span><span style=display:flex><span>  <span>llvm</span>.<span>fun</span><span style=color:#007020;font-weight:700>c</span> @matmul_kernel_0d1d2d3d4c5d6c7d8c(<span style=color:#bb60d5>%arg0</span><span>:</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>, <span style=color:#40a070>1</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg1</span><span>:</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>, <span style=color:#40a070>1</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg2</span><span>:</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>, <span style=color:#40a070>1</span>&gt; {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg3</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg4</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}, <span style=color:#bb60d5>%arg5</span><span>:</span> <span style=color:#007020;font-weight:700>i32</span> {<span>tt</span>.<span>divisibility</span> = <span style=color:#40a070>16</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>}) <span style=color:#007020;font-weight:700>attributes</span> {<span>nvvm</span>.<span>kernel</span> = <span style=color:#40a070>1</span> <span>:</span> <span>u</span><span style=color:#007020;font-weight:700>i1</span>, <span>nvvm</span>.<span>maxntid</span> = <span style=color:#40a070>128</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>, <span>sym_visibility</span> = <span style=color:#4070a0>&#34;public&#34;</span>} {
</span></span><span style=display:flex><span>    %0 = <span>llvm</span>.<span>mlir</span>.<span>addressof</span> @global_smem <span>:</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>array</span>&lt;<span style=color:#40a070>0</span> <span style=color:#007020;font-weight:700>x</span> <span style=color:#007020;font-weight:700>i8</span>&gt;, <span style=color:#40a070>3</span>&gt;
</span></span><span style=display:flex><span>    %1 = <span>llvm</span>.<span style=color:#007020;font-weight:700>bitcast</span> %0 <span>:</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>array</span>&lt;<span style=color:#40a070>0</span> <span style=color:#007020;font-weight:700>x</span> <span style=color:#007020;font-weight:700>i8</span>&gt;, <span style=color:#40a070>3</span>&gt; <span style=color:#007020;font-weight:700>to</span> <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span style=color:#007020;font-weight:700>i8</span>, <span style=color:#40a070>3</span>&gt;
</span></span><span style=display:flex><span>    %2 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>3</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %3 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>1</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %4 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>0</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %5 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>2</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %6 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#007020;font-weight:700>true</span>) <span>:</span> <span style=color:#007020;font-weight:700>i1</span>
</span></span><span style=display:flex><span>    %7 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>32</span> <span>:</span> <span>inde</span><span style=color:#007020;font-weight:700>x</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %8 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>32</span> <span>:</span> <span style=color:#007020;font-weight:700>i32</span>) <span>:</span> <span style=color:#007020;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    %9 = <span>llvm</span>.<span>mlir</span>.<span style=color:#007020;font-weight:700>constant</span>(<span style=color:#40a070>0.000000e+00</span> <span>:</span> <span>f</span><span style=color:#40a070>32</span>) <span>:</span> <span>f</span><span style=color:#40a070>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %567 = <span>llvm</span>.<span>inline_</span><span style=color:#007020;font-weight:700>asm</span> <span>has_side_effects</span> <span>asm_dialect</span> = <span>att</span> <span>operand_attrs</span> = [] <span style=color:#4070a0>&#34;ldmatrix.sync.aligned.m8n8.x4.shared.b16 { $0, $1, $2, $3 }, [ $4 + 0 ];&#34;</span>, <span style=color:#4070a0>&#34;=r,=r,=r,=r,r&#34;</span> %566 <span>:</span> (<span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>f</span><span style=color:#40a070>16</span>, <span style=color:#40a070>3</span>&gt;) <span>-</span>&gt; <span style=color:#bb60d5>!llvm.struct</span>&lt;(<span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;)&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %765 = <span>llvm</span>.<span>inline_</span><span style=color:#007020;font-weight:700>asm</span> <span>has_side_effects</span> <span>asm_dialect</span> = <span>att</span> <span>operand_attrs</span> = [] <span style=color:#4070a0>&#34;mma.sync.aligned.m16n8k16.row.col.f32.f16.f16.f32 { $0, $1, $2, $3 }, { $4, $5, $6, $7 }, { $8, $9 }, { $10, $11, $12, $13 };&#34;</span>, <span style=color:#4070a0>&#34;=r,=r,=r,=r,r,r,r,r,r,r,0,1,2,3&#34;</span> %677, %679, %678, %680, %685, %686, %701, %702, %703, %704 <span>:</span> (<span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>vect</span><span style=color:#007020;font-weight:700>or</span>&lt;<span style=color:#40a070>2</span><span>xf</span><span style=color:#40a070>16</span>&gt;, <span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>) <span>-</span>&gt; <span style=color:#bb60d5>!llvm.struct</span>&lt;(<span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>, <span>f</span><span style=color:#40a070>32</span>)&gt;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex;background-color:#d8d8d8><span>    %1789 = <span>llvm</span>.<span>inline_</span><span style=color:#007020;font-weight:700>asm</span> <span>has_side_effects</span> <span>asm_dialect</span> = <span>att</span> <span>operand_attrs</span> = [] <span style=color:#4070a0>&#34;@$5 st.global.v4.b32 [ $4 + 0 ], { $0, $1, $2, $3 };&#34;</span>, <span style=color:#4070a0>&#34;r,r,r,r,l,b&#34;</span> %1782, %1784, %1786, %1788, %1449, %6 <span>:</span> (<span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#007020;font-weight:700>i32</span>, <span style=color:#bb60d5>!llvm.ptr</span>&lt;<span>f</span><span style=color:#40a070>32</span>, <span style=color:#40a070>1</span>&gt;, <span style=color:#007020;font-weight:700>i1</span>) <span>-</span>&gt; <span style=color:#bb60d5>!llvm.void</span>
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><script src=https://utteranc.es/client.js repo=superjomn/superjomn.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><p class="footer text-center">Copyright (c) 2024 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script><script>feather.replace()</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script></body></html>