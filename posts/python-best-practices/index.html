<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/style.css><title>Superjomn's blog | Best Practices for Python Programming (Continuously Updated)</title><meta name=google-site-verification content="kO2XszgjIr1OyaOubGpeb0M34ADBz27vyI1dLETarCM"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z60BDN3JGH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z60BDN3JGH")</script><script src=https://cdn.jsdelivr.net/npm/cash-dom/dist/cash.min.js></script><script>$(function(){$("article table").addClass("table")})</script><body><div id=nav-border class=container><nav id=nav class="nav justify-content-center"><a class=nav-link href=/><i data-feather=home></i>
Home
</a><a class=nav-link href=/tags/tech><i data-feather=terminal></i>
Tech
</a><a class=nav-link href=/tags/life><i data-feather=coffee></i>
Life
</a><a class=nav-link href=/posts/><i data-feather=archive></i>
Archive
</a><a class=nav-link href=/tags/><i data-feather=tag></i>
Tags
</a><a class=nav-link href=/posts/about/><i data-feather=info></i>
About</a></nav></div><div class=container><main id=main><main><article><h1>Best Practices for Python Programming (Continuously Updated)</h1><i data-feather=calendar></i> <time datetime=2023-02-22>Feb 22, 2023</time>
<span id=social></span><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/python>python</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/tech>tech</a><br><br><p><b>Table of Contents</b></p><aside><nav id=TableOfContents><ol><li><a href=#basics>Basics</a><ol><li><a href=#new><code>__new__</code></a><ol><li><a href=#singleton-pattern>Singleton Pattern</a></li><li><a href=#subclassing-immutable-types>Subclassing Immutable Types</a></li><li><a href=#factory-methods>Factory Methods</a></li></ol></li><li><a href=#iter-and-next><code>__iter__</code> and <code>__next__</code></a></li><li><a href=#aiter-and-anext><code>__aiter__</code> and <code>__anext__</code></a></li></ol></li><li><a href=#handy-builtin-utilities>Handy builtin utilities</a><ol><li><a href=#setter-and-getter>setter and getter</a></li><li><a href=#dataclass><code>@dataclass</code></a><ol><li><a href=#use-default-values-or-default-factories>Use default values or default factories</a></li><li><a href=#use-frozen-true-to-make-the-class-immutable>Use <code>frozen=True</code> to make the class immutable</a></li><li><a href=#use-order-true-to-enable-comparison-operators-based-on-the-class-attributes>Use <code>order=True</code> to enable comparison operators based on the class attributes</a></li><li><a href=#use-inheritance-to-create-subclasses-of-data-classes>Use inheritance to create subclasses of data classes</a></li></ol></li><li><a href=#functools-partial-to-get-new-function-by-partially-fixing-some-arguments-of-an-existing-one>functools <code>partial</code> to get new function by partially fixing some arguments of an existing one</a></li><li><a href=#functools-warps-to-help-define-better-decorators>functools <code>@warps</code> to help define better decorators</a></li><li><a href=#functools-lru-cache-decorator-to-wrap-a-function-with-a-lru-cache>functools <code>@lru_cache</code> : decorator to wrap a function with a LRU cache</a><ol><li><a href=#accelerating-dp-like-recursive-function-call>Accelerating DP-like recursive function call</a></li><li><a href=#initialization-for-some-heavy-states-without-introducing-global-variables>Initialization for some heavy states without introducing global variables</a></li></ol></li></ol></li></ol></nav></aside><br><p>When delving into the codebases of some successful large Python projects such as PyTorch, I am consistently impressed by their code &ndash; whether it&rsquo;s clean yet precise, or leveraging lesser-known built-in or third-party packages to significantly enhance functionality.</p><p>High-quality code snippets, handy packages, and modules have greatly facilitated my work. In this blog, I&rsquo;ll be sharing noteworthy findings and insights learned from the open-source codebase.</p><h2 id=basics>Basics</h2><h3 id=new><code>__new__</code></h3><p>The <code>__new__</code> method is used for creating a new instance of a class. It is a static method that gets called before the <code>__init__</code> method.</p><p>The default <code>__new__</code> method could be</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>MyClass</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, <span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        instance <span style=color:#666>=</span> <span style=color:#007020>super</span>(MyClass, <span style=color:#007020>cls</span>)<span style=color:#666>.</span><span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, <span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> instance
</span></span></code></pre></div><p>Note that, different from <code>__init__</code>, whose first argument is an instance <code>self</code>, <code>__new__</code>&rsquo;s first argument is a class.</p><p>You can override <code>__new__</code> if something special need to be done with the object creation.</p><p>There are some classical use cases for the <code>__new__</code> method:</p><h4 id=singleton-pattern>Singleton Pattern</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Singleton</span>:
</span></span><span style=display:flex><span>    _instance <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>None</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>cls</span><span style=color:#666>.</span>_instance <span style=color:#007020;font-weight:700>is</span> <span style=color:#007020;font-weight:700>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#007020>cls</span><span style=color:#666>.</span>_instance <span style=color:#666>=</span> <span style=color:#007020>super</span>()<span style=color:#666>.</span><span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>)
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>cls</span><span style=color:#666>.</span>_instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Usage</span>
</span></span><span style=display:flex><span>singleton1 <span style=color:#666>=</span> Singleton()
</span></span><span style=display:flex><span>singleton2 <span style=color:#666>=</span> Singleton()
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(singleton1 <span style=color:#007020;font-weight:700>is</span> singleton2)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>True
</span></span></code></pre></div><h4 id=subclassing-immutable-types>Subclassing Immutable Types</h4><p>When subclassing immutable types like <code>str</code>, <code>int</code>, <code>unicode</code> or <code>tuple</code>, the properties of immutable cannot be changed after they are created, you can override <code>__new__</code> instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>UpperStr</span>(<span style=color:#007020>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, value):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>str</span><span style=color:#666>.</span><span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, value<span style=color:#666>.</span>upper())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Usage</span>
</span></span><span style=display:flex><span>upper_string <span style=color:#666>=</span> UpperStr(<span style=color:#4070a0>&#34;hello&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(upper_string)  <span style=color:#60a0b0;font-style:italic># Output: HELLO</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HELLO
</span></span></code></pre></div><h4 id=factory-methods>Factory Methods</h4><p><code>__new__</code> can be used to implement factory methods that return instances of different classes based on input parameters.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Shape</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, <span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>cls</span> <span style=color:#007020;font-weight:700>is</span> Shape:
</span></span><span style=display:flex><span>            shape_type <span style=color:#666>=</span> args[<span style=color:#40a070>0</span>]
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>if</span> shape_type <span style=color:#666>==</span> <span style=color:#4070a0>&#39;circle&#39;</span>:
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span> Circle()
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>elif</span> shape_type <span style=color:#666>==</span> <span style=color:#4070a0>&#39;square&#39;</span>:
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>return</span> Square()
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>super</span>(Shape, <span style=color:#007020>cls</span>)<span style=color:#666>.</span><span style=color:#06287e>__new__</span>(<span style=color:#007020>cls</span>, <span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Circle</span>(Shape):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Square</span>(Shape):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Usage</span>
</span></span><span style=display:flex><span>shape <span style=color:#666>=</span> Shape(<span style=color:#4070a0>&#39;circle&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#007020>isinstance</span>(shape, Circle))  <span style=color:#60a0b0;font-style:italic># Output: True</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>True
</span></span></code></pre></div><h3 id=iter-and-next><code>__iter__</code> and <code>__next__</code></h3><p>The <code>__iter__</code> is a magic method that allows an object to be iterable, its result should be an iterable, and the <code>__next__</code> method returns the next element of the iterable.</p><p>A naive example:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Counter</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__init__</span>(<span style=color:#007020>self</span>, n):
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>n <span style=color:#666>=</span> n
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__iter__</span>(<span style=color:#007020>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic># Return the iterator object (self)</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>self</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__next__</span>(<span style=color:#007020>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>&lt;</span> <span style=color:#007020>self</span><span style=color:#666>.</span>n:
</span></span><span style=display:flex><span>            <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>self</span><span style=color:#666>.</span>i
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#60a0b0;font-style:italic># signal the end</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>raise</span> <span style=color:#007020>StopIteration</span>
</span></span></code></pre></div><h3 id=aiter-and-anext><code>__aiter__</code> and <code>__anext__</code></h3><p>Similar to <code>__iter__</code> and <code>__next__</code>, the <code>__aiter__</code> and <code>__anext__</code> are the asynchronous version.
The <code>__aiter__</code> allows an object to be an asynchronous iterator object, which is an object that has an <code>__anext__</code> method that returns an awaitable object that yields the next element of the sequence.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>AsyncCounter</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__init__</span>(<span style=color:#007020>self</span>, n):
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>n <span style=color:#666>=</span> n
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__aiter__</span>(<span style=color:#007020>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic># Return the iterator object (self)</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>self</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>async</span> <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__anext__</span>(<span style=color:#007020>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>&lt;</span> <span style=color:#007020>self</span><span style=color:#666>.</span>n:
</span></span><span style=display:flex><span>            <span style=color:#007020>self</span><span style=color:#666>.</span>i <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>            <span style=color:#60a0b0;font-style:italic># Simulate some delay</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>await</span> asyncio<span style=color:#666>.</span>sleep(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>self</span><span style=color:#666>.</span>i
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#60a0b0;font-style:italic># Signal the end</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>raise</span> <span style=color:#007020>StopAsyncIteration</span>
</span></span></code></pre></div><h2 id=handy-builtin-utilities>Handy builtin utilities</h2><h3 id=setter-and-getter>setter and getter</h3><p>When there is some logic bound to a member when it is got or updated, then the getter and setter could be used.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>App</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>__init__</span>(<span style=color:#007020>self</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>update_count <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>_name <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>name</span>(<span style=color:#007020>self</span>) <span style=color:#666>-&gt;</span> <span style=color:#007020>str</span>:
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>self</span><span style=color:#666>.</span>_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@name.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>name</span>(<span style=color:#007020>self</span>, v:<span style=color:#007020>str</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>_name <span style=color:#666>=</span> v
</span></span><span style=display:flex><span>        <span style=color:#007020>self</span><span style=color:#666>.</span>update_count <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#666>=</span> App()
</span></span><span style=display:flex><span>app<span style=color:#666>.</span>name <span style=color:#666>=</span> <span style=color:#4070a0>&#39;a&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#666>.</span>name <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#39;name:&#39;</span>, app<span style=color:#666>.</span>name) <span style=color:#60a0b0;font-style:italic># b</span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#39;update_count:&#39;</span>, app<span style=color:#666>.</span>update_count) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>name: b
</span></span><span style=display:flex><span>update_count: 2
</span></span></code></pre></div><h3 id=dataclass><code>@dataclass</code></h3><p><code>@dataclass</code> is a decorator that can be used to create classes that <strong>mainly store data</strong>.
It can automatically generate some common methods for the class, such as <code>__init__</code>, <code>__repr__</code>, and <code>__eq__</code>, based on the type hints of the class attributes.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>dataclasses</span> <span style=color:#007020;font-weight:700>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Point</span>:
</span></span><span style=display:flex><span>    x: <span style=color:#007020>float</span>
</span></span><span style=display:flex><span>    y: <span style=color:#007020>float</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#666>=</span> Point(<span style=color:#40a070>1.</span>, <span style=color:#40a070>2.</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(p)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Point(x=1.0, y=2.0)
</span></span></code></pre></div><p>There are several classical practices using <code>@dataclass</code></p><h4 id=use-default-values-or-default-factories>Use default values or default factories</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>dataclasses</span> <span style=color:#007020;font-weight:700>import</span> dataclass, field
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>random</span> <span style=color:#007020;font-weight:700>import</span> randint
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>typing</span> <span style=color:#007020;font-weight:700>import</span> List
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>DummyContainer</span>:
</span></span><span style=display:flex><span>    sides: <span style=color:#007020>int</span> <span style=color:#666>=</span> <span style=color:#40a070>6</span>
</span></span><span style=display:flex><span>    value: <span style=color:#007020>int</span> <span style=color:#666>=</span> field(default_factory<span style=color:#666>=</span><span style=color:#007020;font-weight:700>lambda</span>: randint(<span style=color:#40a070>1</span>, <span style=color:#40a070>6</span>))
</span></span><span style=display:flex><span>    alist: List[<span style=color:#007020>int</span>] <span style=color:#666>=</span> field(default_factory<span style=color:#666>=</span><span style=color:#007020>list</span>) <span style=color:#60a0b0;font-style:italic># avoid assign [] directly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dummy <span style=color:#666>=</span> DummyContainer()
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(dummy)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>DummyContainer(sides=6, value=2, alist=[])
</span></span></code></pre></div><h4 id=use-frozen-true-to-make-the-class-immutable>Use <code>frozen=True</code> to make the class immutable</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>dataclasses</span> <span style=color:#007020;font-weight:700>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>(frozen<span style=color:#666>=</span><span style=color:#007020;font-weight:700>True</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Circle</span>:
</span></span><span style=display:flex><span>    radius: <span style=color:#007020>float</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const_circle <span style=color:#666>=</span> Circle(<span style=color:#40a070>2.0</span>)
</span></span></code></pre></div><h4 id=use-order-true-to-enable-comparison-operators-based-on-the-class-attributes>Use <code>order=True</code> to enable comparison operators based on the class attributes</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>dataclasses</span> <span style=color:#007020;font-weight:700>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>(order<span style=color:#666>=</span><span style=color:#007020;font-weight:700>True</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Circle</span>:
</span></span><span style=display:flex><span>    radius: <span style=color:#007020>float</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c0 <span style=color:#666>=</span> Circle(<span style=color:#40a070>1.</span>)
</span></span><span style=display:flex><span>c1 <span style=color:#666>=</span> Circle(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(c0 <span style=color:#666>&gt;</span> c1)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>False
</span></span></code></pre></div><h4 id=use-inheritance-to-create-subclasses-of-data-classes>Use inheritance to create subclasses of data classes</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>dataclasses</span> <span style=color:#007020;font-weight:700>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Animal</span>:
</span></span><span style=display:flex><span>    name: <span style=color:#007020>str</span>
</span></span><span style=display:flex><span>    sound: <span style=color:#007020>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>Dog</span>(Animal):
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># inherits name and sound from Animal</span>
</span></span><span style=display:flex><span>    watch_house: <span style=color:#007020>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dog <span style=color:#666>=</span> Dog(name<span style=color:#666>=</span><span style=color:#4070a0>&#34;Huang&#34;</span>, sound<span style=color:#666>=</span><span style=color:#4070a0>&#34;Wang&#34;</span>, watch_house<span style=color:#666>=</span><span style=color:#007020;font-weight:700>False</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(dog)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Dog(name=&#39;Huang&#39;, sound=&#39;Wang&#39;, watch_house=False)
</span></span></code></pre></div><h3 id=functools-partial-to-get-new-function-by-partially-fixing-some-arguments-of-an-existing-one>functools <code>partial</code> to get new function by partially fixing some arguments of an existing one</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>functools</span> <span style=color:#007020;font-weight:700>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>func0</span>(a, b):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;a:</span><span style=color:#70a0d0>{</span>a<span style=color:#70a0d0>}</span><span style=color:#4070a0>, b:</span><span style=color:#70a0d0>{</span>b<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1 <span style=color:#666>=</span> partial(func0, a <span style=color:#666>=</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(func1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1(b<span style=color:#666>=</span><span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># reset argument a</span>
</span></span><span style=display:flex><span>func1(a<span style=color:#666>=</span><span style=color:#40a070>1</span>, b<span style=color:#666>=</span><span style=color:#40a070>10</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>functools.partial(&lt;function func0 at 0x7fccb00e31e0&gt;, a=0)
</span></span><span style=display:flex><span>a:0, b:10
</span></span><span style=display:flex><span>a:1, b:10
</span></span></code></pre></div><h3 id=functools-warps-to-help-define-better-decorators>functools <code>@warps</code> to help define better decorators</h3><p>Below is a classical way to define an decorator</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>actual_func</span>(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#4070a0>&#39;&#39;&#39; The actual func. &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Before Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;After Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>greet</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#39;&#39;&#39; The greet func. &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Hello, </span><span style=color:#70a0d0>{</span>name<span style=color:#70a0d0>}</span><span style=color:#4070a0>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>greet(<span style=color:#4070a0>&#34;Martin&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Before Calling greet
</span></span><span style=display:flex><span>Hello, Martin!
</span></span><span style=display:flex><span>After Calling greet
</span></span></code></pre></div><p>The name and docstring of the decorated function will be hidden in the decorator function, and this makes the usage a bit opaque when debugging.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span><span style=color:#bb60d5>__doc__</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>actual_func
</span></span><span style=display:flex><span>The actual func.
</span></span></code></pre></div><p>In other words, the name and the docstring of the decorated function is overwritten by the decorator, which is not expected.</p><p>We can fix such issue with <code>@wraps</code>, for example, the original code could be replaced with</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>functools</span> <span style=color:#007020;font-weight:700>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>decorator</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#555;font-weight:700>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>actual_func</span>(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Before Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>        func(<span style=color:#666>*</span>args, <span style=color:#666>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;After Calling </span><span style=color:#70a0d0>{</span>func<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> actual_func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#555;font-weight:700>@decorator</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>greet</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#39;&#39;&#39; The greet func. &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Hello, </span><span style=color:#70a0d0>{</span>name<span style=color:#70a0d0>}</span><span style=color:#4070a0>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span><span style=color:#bb60d5>__name__</span>)
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(greet<span style=color:#666>.</span><span style=color:#bb60d5>__doc__</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>greet
</span></span><span style=display:flex><span> The greet func.
</span></span></code></pre></div><h3 id=functools-lru-cache-decorator-to-wrap-a-function-with-a-lru-cache>functools <code>@lru_cache</code> : decorator to wrap a function with a LRU cache</h3><h4 id=accelerating-dp-like-recursive-function-call>Accelerating DP-like recursive function call</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#555;font-weight:700>@functools.lru_cache</span>(maxsize<span style=color:#666>=</span><span style=color:#40a070>1000</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>factorial</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> n <span style=color:#666>*</span> factorial(n<span style=color:#666>-</span><span style=color:#40a070>1</span>) <span style=color:#007020;font-weight:700>if</span> n <span style=color:#007020;font-weight:700>else</span> <span style=color:#40a070>1</span>
</span></span></code></pre></div><h4 id=initialization-for-some-heavy-states-without-introducing-global-variables>Initialization for some heavy states without introducing global variables</h4><p>Suppose we have some global states that should be initialized only once, the naive way to do it is by introducing some global variables,</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>state <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>get_state</span>(args):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> state <span style=color:#007020;font-weight:700>is</span> <span style=color:#007020;font-weight:700>None</span>:
</span></span><span style=display:flex><span>        state <span style=color:#666>=</span> construct_state(args)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> state
</span></span></code></pre></div><p>We can eliminate the need for a global variable with a cache:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#555;font-weight:700>@lru_cache</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>get_state</span>(args):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> construct_state(args)
</span></span></code></pre></div><script src=https://utteranc.es/client.js repo=superjomn/superjomn.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><p class="footer text-center">Copyright (c) 2025 Chunwei Yan</p></main></div><script src=/js/feather.min.js></script><script>feather.replace()</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script></body></html>