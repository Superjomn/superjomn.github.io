<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><style>span.hl{background:blue}</style><title>Python VM 执行方式简要探索 | Superjomn's Blog</title><meta name=keywords content="python"><meta name=description content="Python Code Object 有用的 attribute Python Bytecode 理解 Python Frame 修改 Frame 的 Code Object 总结 FYI 最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。
本文会从可复现的角度，多一些可以执行的例子。
Python Code Object 这里是简单的介绍，详细的可以参考 code objects 这本书的章节。
Code object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。
我们先从一个简单的函数开始
1 2 3 4 def foo(name, age): ''' Get the information of a person. ''' born = 2023 - age return f&#34;hello {name}, born at {born}!"><meta name=author content="Chunwei Yan"><link rel=canonical href=https://superjomn.github.io/posts/python-vm-brief-introduction/><link crossorigin=anonymous href=/assets/css/stylesheet.ea0c225f8967ca091debb4444b3f01a4161cd5b163f019d5856592c642712ab7.css integrity="sha256-6gwiX4lnygkd67RESz8BpBYc1bFj8BnVhWWSxkJxKrc=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://superjomn.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://superjomn.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://superjomn.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://superjomn.github.io/apple-touch-icon.png><link rel=mask-icon href=https://superjomn.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Python VM 执行方式简要探索"><meta property="og:description" content="Python Code Object 有用的 attribute Python Bytecode 理解 Python Frame 修改 Frame 的 Code Object 总结 FYI 最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。
本文会从可复现的角度，多一些可以执行的例子。
Python Code Object 这里是简单的介绍，详细的可以参考 code objects 这本书的章节。
Code object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。
我们先从一个简单的函数开始
1 2 3 4 def foo(name, age): ''' Get the information of a person. ''' born = 2023 - age return f&#34;hello {name}, born at {born}!"><meta property="og:type" content="article"><meta property="og:url" content="https://superjomn.github.io/posts/python-vm-brief-introduction/"><meta property="og:image" content="https://superjomn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-24T00:00:00+00:00"><meta property="og:site_name" content="Superjomn"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://superjomn.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Python VM 执行方式简要探索"><meta name=twitter:description content="Python Code Object 有用的 attribute Python Bytecode 理解 Python Frame 修改 Frame 的 Code Object 总结 FYI 最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。
本文会从可复现的角度，多一些可以执行的例子。
Python Code Object 这里是简单的介绍，详细的可以参考 code objects 这本书的章节。
Code object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。
我们先从一个简单的函数开始
1 2 3 4 def foo(name, age): ''' Get the information of a person. ''' born = 2023 - age return f&#34;hello {name}, born at {born}!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://superjomn.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Python VM 执行方式简要探索","item":"https://superjomn.github.io/posts/python-vm-brief-introduction/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python VM 执行方式简要探索","name":"Python VM 执行方式简要探索","description":"Python Code Object 有用的 attribute Python Bytecode 理解 Python Frame 修改 Frame 的 Code Object 总结 FYI 最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。\n本文会从可复现的角度，多一些可以执行的例子。\nPython Code Object 这里是简单的介绍，详细的可以参考 code objects 这本书的章节。\nCode object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。\n我们先从一个简单的函数开始\n1 2 3 4 def foo(name, age): \u0026#39;\u0026#39;\u0026#39; Get the information of a person. \u0026#39;\u0026#39;\u0026#39; born = 2023 - age return f\u0026#34;hello {name}, born at {born}!","keywords":["python"],"articleBody":" Python Code Object 有用的 attribute Python Bytecode 理解 Python Frame 修改 Frame 的 Code Object 总结 FYI 最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。\n本文会从可复现的角度，多一些可以执行的例子。\nPython Code Object 这里是简单的介绍，详细的可以参考 code objects 这本书的章节。\nCode object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。\n我们先从一个简单的函数开始\n1 2 3 4 def foo(name, age): ''' Get the information of a person. ''' born = 2023 - age return f\"hello {name}, born at {born}!\" 查看其 Code object:\n1 foo.__code__ 1 ","wordCount":"959","inLanguage":"en","datePublished":"2023-02-24T00:00:00Z","dateModified":"2023-02-24T00:00:00Z","author":[{"@type":"Person","name":"Chunwei Yan"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://superjomn.github.io/posts/python-vm-brief-introduction/"},"publisher":{"@type":"Organization","name":"Superjomn's Blog","logo":{"@type":"ImageObject","url":"https://superjomn.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://superjomn.github.io accesskey=h title="Home (Alt + H)"><img src=https://superjomn.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://superjomn.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://superjomn.github.io/posts/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://superjomn.github.io>Home</a>&nbsp;»&nbsp;<a href=https://superjomn.github.io/posts/>Posts</a></div><h1 class=post-title>Python VM 执行方式简要探索</h1><div class=post-meta><span title='2023-02-24 00:00:00 +0000 UTC'>February 24, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;959 words&nbsp;·&nbsp;Chunwei Yan</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#python-code-object>Python Code Object</a><ul><li><a href=#有用的-attribute>有用的 attribute</a></li><li><a href=#python-bytecode-理解>Python Bytecode 理解</a></li></ul></li><li><a href=#python-frame>Python Frame</a><ul><li><a href=#修改-frame-的-code-object>修改 Frame 的 Code Object</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#fyi>FYI</a></li></ul></nav></div></details></div><div class=post-content><ul><li><a href=#python-code-object>Python Code Object</a><ul><li><a href=#%E6%9C%89%E7%94%A8%E7%9A%84-attribute>有用的 attribute</a></li><li><a href=#python-bytecode-%E7%90%86%E8%A7%A3>Python Bytecode 理解</a></li></ul></li><li><a href=#python-frame>Python Frame</a><ul><li><a href=#%E4%BF%AE%E6%94%B9-frame-%E7%9A%84-code-object>修改 Frame 的 Code Object</a></li></ul></li><li><a href=#%E6%80%BB%E7%BB%93>总结</a></li><li><a href=#fyi>FYI</a></li></ul><p>最近在看 TorchDynamo 的东西，里面需要对 Python 执行机制有一些了解，所以单独拆开放到了这篇文章里。</p><p>本文会从可复现的角度，多一些可以执行的例子。</p><h2 id=python-code-object>Python Code Object<a hidden class=anchor aria-hidden=true href=#python-code-object>#</a></h2><p>这里是简单的介绍，详细的可以参考 <a href=https://leanpub.com/insidethepythonvirtualmachine/read#leanpub-auto-code-objects>code objects</a> 这本书的章节。</p><p>Code object 用来记录 Python 的 byte code，对应的粒度是 Block，这里的 Block 可以包含从 Module 到 Class definition 到 Function body 的各类结构（有别于编译器里面的 BasicBlock）。 可以理解 Code object 是可以嵌套的。</p><p>我们先从一个简单的函数开始</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>age</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39; Get the information of a person. &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>born</span> <span class=o>=</span> <span class=mi>2023</span> <span class=o>-</span> <span class=n>age</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;hello </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>, born at </span><span class=si>{</span><span class=n>born</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>查看其 Code object:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=vm>__code__</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;code object foo at 0x7f4da6f59500, file &#34;/tmp/ipykernel_2935902/3583013317.py&#34;, line 1&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=有用的-attribute>有用的 attribute<a hidden class=anchor aria-hidden=true href=#有用的-attribute>#</a></h3><p>那 <code>foo.__code__</code> 中包含的有用的 attribute 如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>dir</span><span class=p>(</span><span class=n>foo</span><span class=o>.</span><span class=vm>__code__</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>得到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;__class__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__delattr__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__dir__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__doc__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__eq__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__format__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__ge__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__getattribute__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__gt__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__hash__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__init__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__init_subclass__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__le__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__lt__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__ne__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__new__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__reduce__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__reduce_ex__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__repr__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__setattr__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__sizeof__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__str__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;__subclasshook__&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_argcount&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_cellvars&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_nlocals&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_posonlyargcount&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_stacksize&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;co_varnames&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;replace&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>其中比较多打交道的属性如下</p><ul><li><strong><code>co_names</code></strong> is a tuple containing global attributes and methods used inside the scope,</li><li><strong><code>co_varname</code></strong> is the tuple containing local variable names used in function,</li><li><strong><code>co_consts</code></strong> returns the literals used by bytecode.</li></ul><p>对应属性的内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>call_foo</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_names</span>
</span></span></code></pre></td></tr></table></div></div><p><code>co_names</code> 是空的，因为 <code>foo</code> 函数里面没有调用任何的外部函数或属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_varnames</span>
</span></span></code></pre></td></tr></table></div></div><p><code>co_varnames</code> 比较丰富，看到 local scope 可以用的 variable name 都在里面，包括两个 argument： name 和 age，以及一个 local variable： born。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>foo</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_consts</span>
</span></span></code></pre></td></tr></table></div></div><p><code>co_consts</code> 意料外有好几个，一类是 code 里面用到的 <strong>2023</strong> 这个常量，另外几个字符串是 string format 里面分割开的几个字段。</p><h3 id=python-bytecode-理解>Python Bytecode 理解<a hidden class=anchor aria-hidden=true href=#python-bytecode-理解>#</a></h3><p>接下来我们尝试理解下简单的 Python bytecode，接着上面的例子。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>foo</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> 2           0 LOAD_CONST               1 (2023)
</span></span><span class=line><span class=cl>             2 LOAD_FAST                1 (age)
</span></span><span class=line><span class=cl>             4 BINARY_SUBTRACT
</span></span><span class=line><span class=cl>             6 STORE_FAST               2 (born)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 3           8 LOAD_CONST               2 (&#39;hello &#39;)
</span></span><span class=line><span class=cl>            10 LOAD_FAST                0 (name)
</span></span><span class=line><span class=cl>            12 FORMAT_VALUE             0
</span></span><span class=line><span class=cl>            14 LOAD_CONST               3 (&#39;, born at &#39;)
</span></span><span class=line><span class=cl>            16 LOAD_FAST                2 (born)
</span></span><span class=line><span class=cl>            18 FORMAT_VALUE             0
</span></span><span class=line><span class=cl>            20 LOAD_CONST               4 (&#39;!&#39;)
</span></span><span class=line><span class=cl>            22 BUILD_STRING             5
</span></span><span class=line><span class=cl>            24 RETURN_VALUE
</span></span></code></pre></td></tr></table></div></div><p>上面 dump 出来的内容包含了 <code>dis</code> 增加的一些 human readable 的 hint，具体内容可以分为 3 列：</p><ol><li>表示原始 Python 源代码中的行号</li><li>bytecode 中的行号以及对应的 opcode</li><li>argument ID，圆括弧里面是一些 hint</li></ol><p>这里需要提一下， Python 的执行方式是基于 Stack 而非 Register，带来的好处就是 bytecode 逻辑非常简单，常见的操作如下</p><ul><li>在执行一个 Opcode 前，将其所需的 variable 压栈</li><li>执行这个 Opcode 时，从 stack 中 Pop 所需数目的 variable</li><li>将执行结果压入 stack 中，备后续使用</li></ul><p>上面的前三行 code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2           0 LOAD_CONST               1 (2023)
</span></span><span class=line><span class=cl>            2 LOAD_FAST                1 (age)
</span></span><span class=line><span class=cl>            4 BINARY_SUBTRACT
</span></span></code></pre></td></tr></table></div></div><p>表示的是</p><ol><li>将 1st 常量 2023 压栈</li><li>将 1st 变量 age 压栈</li><li>Pop 两个值，并执行 2023 - age</li><li>将结果压栈</li></ol><p>Opcode 有一些具体的含义，比如其中几个比较重要的</p><ul><li><code>LOAD_CONST</code> 表示是从 Code object 的 <code>co_consts</code> 里面 load<ul><li>参考上节，~co_consts~ 第 1 个 value 是 2023， 因此 <code>LOAD_CONST 1</code> 表示 Load 2023 进 stack，跟末尾的 hint 对应起来了</li></ul></li><li><code>LOAD_FAST</code> 是从 <code>co_varnames</code> 里面 Load 到 stack</li><li><code>STORE_FAST</code> 表示将 stack 的 head 中的值 Store 到 <code>co_varnames</code> 里面的一个 variable</li><li><code>RETURN_VALUE</code> 表示将 stack 中包含的所有值返回</li></ul><p>完整的 opcode 及对应的 Python 的处理行为可以参考 <a href=https://github.com/python/cpython/blob/22b8d77b98a5944e688be0927b8139c49d4a7257/Python/generated_cases.c.h>Python/generated_cases.c.h</a>，内容非常清晰，截取 <code>LOAD_FAST</code> 对应的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6>6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7>7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8>8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=n>TARGET</span><span class=p>(</span><span class=n>LOAD_FAST</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>PyObject</span> <span class=o>*</span><span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=n>GETLOCAL</span><span class=p>(</span><span class=n>oparg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>assert</span><span class=p>(</span><span class=n>value</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Py_INCREF</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>STACK_GROW</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>POKE</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>DISPATCH</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=python-frame>Python Frame<a hidden class=anchor aria-hidden=true href=#python-frame>#</a></h2><p>Python Code Object 存储了待执行的 Python bytecode，但这些 bytecode 无法直接执行，还需要专门的 Interpreter 机制。
这跟 C/C++ 完全不同，毕竟 bytecode 和 machine code 完全是两码事。</p><p>为了执行 bytecode， Python 对应有 Frame Object 的数据结构，简单可以认为 Frame Object 跟 Code Object 对应，前者 hold 执行一个 Code Object 所需要的所有 runtime 的信息，而后者则记录了具体需要执行的 bytecode。
因此，当从一个 Block 跳到另外一个 Block 时候，会有 Frame 的切换，例如，function call 时，会先 hold 住当前的 Frame，创建一个新的 Frame 接着执行该 function 对应的 Code Object； 执行完毕，则跳回先前的 Frame。</p><p>Frame 具体数据结构我们需要参考下 <a href=https://github.com/python/cpython/blob/main/Include/internal/pycore_frame.h#L16>pycore_frame.h/_frame</a> 相关的 code：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=k>struct</span> <span class=nc>_frame</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject_HEAD</span>
</span></span><span class=line><span class=cl>    <span class=n>PyFrameObject</span> <span class=o>*</span><span class=n>f_back</span><span class=p>;</span>      <span class=cm>/* previous frame, or NULL */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>_PyInterpreterFrame</span> <span class=o>*</span><span class=n>f_frame</span><span class=p>;</span> <span class=cm>/* points to the frame data */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_trace</span><span class=p>;</span>          <span class=cm>/* Trace function */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>f_lineno</span><span class=p>;</span>               <span class=cm>/* Current line number. Only valid if non-zero */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>f_trace_lines</span><span class=p>;</span>         <span class=cm>/* Emit per-line trace events? */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>f_trace_opcodes</span><span class=p>;</span>       <span class=cm>/* Emit per-opcode trace events? */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>f_fast_as_locals</span><span class=p>;</span>      <span class=cm>/* Have the fast locals of this frame been converted to a dict? */</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* The frame data, if this frame object owns the frame */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>_f_frame_data</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 <code>f_back</code> 指针用来 chain 多个跳转的 Frame，这样上面的 function call 才可以实施。</p><p><code>f_frame</code> 记录了一个 Frame 具体的信息，接着看下如下 code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span><span class=lnt id=hl-13-17><a class=lnlinks href=#hl-13-17>17</a>
</span><span class=lnt id=hl-13-18><a class=lnlinks href=#hl-13-18>18</a>
</span><span class=lnt id=hl-13-19><a class=lnlinks href=#hl-13-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_PyInterpreterFrame</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PyCodeObject</span> <span class=o>*</span><span class=n>f_code</span><span class=p>;</span> <span class=cm>/* Strong reference */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>_PyInterpreterFrame</span> <span class=o>*</span><span class=n>previous</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_funcobj</span><span class=p>;</span> <span class=cm>/* Strong reference. Only valid if not on C stack */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_globals</span><span class=p>;</span> <span class=cm>/* Borrowed reference. Only valid if not on C stack */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_builtins</span><span class=p>;</span> <span class=cm>/* Borrowed reference. Only valid if not on C stack */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_locals</span><span class=p>;</span> <span class=cm>/* Strong reference, may be NULL. Only valid if not on C stack */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyFrameObject</span> <span class=o>*</span><span class=n>frame_obj</span><span class=p>;</span> <span class=cm>/* Strong reference, may be NULL. Only valid if not on C stack */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// NOTE: This is not necessarily the last instruction started in the given
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// frame. Rather, it is the code unit *prior to* the *next* instruction. For
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// example, it may be an inline CACHE entry, an instruction we just jumped
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// over, or (in the case of a newly-created frame) a totally invalid value:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>_Py_CODEUNIT</span> <span class=o>*</span><span class=n>prev_instr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>stacktop</span><span class=p>;</span>  <span class=cm>/* Offset of TOS from localsplus  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>yield_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Locals and stack */</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject</span> <span class=o>*</span><span class=n>localsplus</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>_PyInterpreterFrame</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里比较明确的是</p><ul><li><code>f_code</code> 肯定是指向对应的 Code Object</li><li><code>f_globals</code>, <code>f_locals</code> 应该直接对应到 Code Object 里面的 <code>co_names</code> 和 <code>co_varnames</code></li><li><code>stacktop</code> 对应着 stack 中的 top 位置</li></ul><h3 id=修改-frame-的-code-object>修改 Frame 的 Code Object<a hidden class=anchor aria-hidden=true href=#修改-frame-的-code-object>#</a></h3><p>得益于 <a href=https://peps.python.org/pep-0523/>PEP 523</a>，从 Python 3.6 开始，一个 <code>PyEval_EvalFrameEx()</code> 函数加入了 Python API，不同于之前的 <code>PyEval_EvalFrameDefault()</code> ， 新函数允许用户自定义 Frame Object 执行过程。</p><p>类似 TorchDynamo，与 Python 交互最核心的也是通过这个 API。</p><p>API 的实现很简单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=n>PyObject</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>PyEval_EvalFrameEx</span><span class=p>(</span><span class=n>PyFrameObject</span> <span class=o>*</span><span class=n>frame</span><span class=p>,</span> <span class=kt>int</span> <span class=n>throwflag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PyThreadState</span> <span class=o>*</span><span class=n>tstate</span> <span class=o>=</span> <span class=n>PyThreadState_GET</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tstate</span><span class=o>-&gt;</span><span class=n>interp</span><span class=o>-&gt;</span><span class=n>eval_frame</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=n>throwflag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>只要用户设置了自定义的 interpreter，那就执行自定义的 <code>eval_frame</code> 逻辑，这一点也是 TorchDynamo 的核心。</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>本文主要介绍了 Python 执行机制中 Code Object 和 Frame Object 两个重要的概念，具体特点如下</p><ul><li>Code Object 和 Frame Object 对应到 Block 粒度</li><li>Code Object 主要记录了 bytecode 以及 <code>co_names</code>, <code>co_varnames</code> 等一大类静态信息</li><li>Frame Object 跟 Code Object 基本一一对应，记录了执行所需的信息，当出现类似 function call，新的 Frame Object 会创建接着执行，完毕后再返回当前 Frame</li></ul><h2 id=fyi>FYI<a hidden class=anchor aria-hidden=true href=#fyi>#</a></h2><ul><li><a href=https://leanpub.com/insidethepythonvirtualmachine/read#leanpub-auto-code-objects>Inside the Python Virtual Machine</a> ，一本详细讲解 Python VM 的书</li><li><a href=https://tenthousandmeters.com/blog/python-behind-the-scenes-1-how-the-cpython-vm-works/>Python behind the scenes #1: how the CPython VM works</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://superjomn.github.io/tags/python/>python</a></li></ul><nav class=paginav><a class=next href=https://superjomn.github.io/posts/python-functools-introduction/><span class=title>Next »</span><br><span>Python functools 包简要实践</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on twitter" href="https://twitter.com/intent/tweet/?text=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2&amp;url=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f&amp;hashtags=python"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f&amp;title=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2&amp;summary=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2&amp;source=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f&title=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on whatsapp" href="https://api.whatsapp.com/send?text=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2%20-%20https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Python VM 执行方式简要探索 on telegram" href="https://telegram.me/share/url?text=Python%20VM%20%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f%e7%ae%80%e8%a6%81%e6%8e%a2%e7%b4%a2&amp;url=https%3a%2f%2fsuperjomn.github.io%2fposts%2fpython-vm-brief-introduction%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://superjomn.github.io>Superjomn's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>